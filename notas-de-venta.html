<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de Imprenta</title>
    <!-- Tailwind CSS CDN -->

    <!-- Local Assets -->
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="assets/css/inter.css" rel="stylesheet">
    <link href="assets/css/fontawesome.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F9FF;
            /* azul claro vibrante */
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #1F2937;
        }

        .input-group select,
        .input-group input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #3B82F6;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            background-color: #FFFFFF;
            color: #1F2937;
            transition: all 0.2s ease;
        }

        .input-group select:focus,
        .input-group input[type="number"]:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .input-group.input-error {
            border: 2px solid #EF4444;
            border-radius: 0.5rem;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
            padding: 0.5rem;
        }

        #opcionesAutocopia,
        #opcionesSimple {
            border: 2px dashed #3B82F6;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #F0F9FF;
            margin-top: 1rem;
        }

        input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #3B82F6;
        }

        input[type="radio"]:checked {
            accent-color: #2563EB;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            border-bottom: 2px solid #1F2937;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .result-card {
            background-color: #EEF2FF;
            border: 1px solid #C7D2FE;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            text-align: center;
        }

        .result-price {
            font-size: 2.5rem;
            font-weight: 800;
            color: #16A34A;
            text-align: center;
            margin: 1rem 0;
        }

        .result-breakdown {
            margin-top: 1.5rem;
            border-top: 1px dashed #A78BFA;
            padding-top: 1.5rem;
        }

        .result-breakdown p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .result-breakdown span {
            font-weight: 600;
        }

        .formula {
            font-size: 0.85rem;
            color: #6B7280;
            margin-left: 1rem;
            margin-bottom: 0.5rem;
        }

        .copy-text-container {
            background-color: #E0F2FE;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            word-break: break-all;
            border: 1px solid #93C5FD;
        }

        .creator-info {
            color: #EF4444;
            font-weight: 600;
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.95rem;
        }

        .cost-details-section {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }

        .cost-details-section summary {
            font-weight: 600;
            cursor: pointer;
            padding: 0.5rem 0;
            color: #2563EB;
            list-style: none;
            display: flex;
            align-items: center;
        }

        .cost-details-section summary::-webkit-details-marker {
            display: none;
        }

        .cost-details-section summary::before {
            content: '+';
            font-weight: bold;
            margin-right: 0.5rem;
            transition: transform 0.2s ease-in-out;
            transform: rotate(0deg);
        }

        .cost-details-section[open] summary::before {
            content: '-';
            transform: rotate(90deg);
        }

        .cost-details-content p {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            /* Corrección responsiva */
            gap: 0.5rem;
            /* Espaciado entre elementos al hacer wrap */
            padding: 0.2rem 0;
            border-bottom: 1px dotted #E5E7EB;
        }

        /* Ajuste para que el texto NO se rompa palabra por palabra si es posible, pero permita multilínea */
        .cost-details-content p>span:first-child {
            flex: 1 1 auto;
            text-align: left;
            min-width: 150px;
        }

        .cost-details-content p:last-child {
            border-bottom: none;
        }

        .cost-details-content input[type="number"] {
            width: 80px;
            padding: 0.25rem 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            text-align: right;
            margin-left: 0.5rem;
        }

        .master-cost-details-section {
            background-color: #E0F2FE;
            border: 1px solid #93C5FD;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .master-cost-details-section summary {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1E40AF;
            cursor: pointer;
            padding: 0.5rem 0;
            list-style: none;
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .master-cost-details-section summary::-webkit-details-marker {
            display: none;
        }

        .master-cost-details-section summary::before {
            content: '+';
            font-weight: bold;
            margin-right: 0.75rem;
            font-size: 1.25em;
            transition: transform 0.2s ease-in-out;
            transform: rotate(0deg);
        }

        .master-cost-details-section[open] summary::before {
            content: '-';
            transform: rotate(90deg);
        }

        .master-cost-details-content {
            padding-top: 1rem;
            border-top: 1px dashed #BFDBFE;
        }

        .offset-recommendation {
            color: #EF4444;
            font-weight: 600;
            text-align: center;
            margin-top: 1.5rem;
            font-size: 1.1rem;
            border-top: 2px dashed #EF4444;
            padding-top: 1rem;
        }

        /* === TOGGLE MAQUILA === */
        .maquila-card-off {
            background-color: #F9FAFB;
            border-color: #D1D5DB;
        }

        .maquila-card-off:hover {
            background-color: #FEF2F2;
            border-color: #FCA5A5;
        }

        .maquila-card-on {
            background-color: #FEF2F2;
            border-color: #EF4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
        }

        /* Pista del toggle */
        .maquila-track-off {
            background-color: #D1D5DB;
        }

        .maquila-track-on {
            background-color: #EF4444;
        }

        /* Pulgar del toggle */
        .maquila-thumb-off {
            left: 2px;
        }

        .maquila-thumb-on {
            left: calc(100% - 26px);
        }

        /* Badge de estado */
        .maquila-badge-off {
            background-color: #E5E7EB;
            color: #6B7280;
        }

        .maquila-badge-on {
            background-color: #EF4444;
            color: #FFFFFF;
        }

        #customAlert {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background-color: #EF4444;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1000;
            font-weight: 500;
            max-width: 300px;
            text-align: center;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        <div class="text-center mb-8">
            <h1 id="tituloPage" class="text-3xl font-bold text-gray-900">Cotizador de Notas de Remisión</h1>
            <p class="text-gray-500 mt-2">Completa los campos para obtener un precio estimado.</p>
            <!-- Información del creador agregada aquí -->
            <div class="creator-info">
                Creado por Joel Adrian Mtz Meza, whats 8341446103
            </div>
        </div>

        <form id="cotizadorForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">

            <!-- SECCIÓN 0: TIPO DE PRODUCTO -->
            <fieldset class="md:col-span-2 border-t pt-6">
                <legend class="section-title">Tipo de Producto</legend>
                <div class="input-group">
                    <label for="tipoProducto">¿Qué deseas cotizar?</label>
                    <select id="tipoProducto">
                        <option value="" disabled selected>Selecciona el tipo de producto</option>
                        <option value="notas_remision">Notas de Remisión</option>
                        <option value="notas">Notas</option>
                        <option value="recetas">Recetas</option>
                        <option value="impresiones">Impresiones</option>
                    </select>
                </div>
            </fieldset>

            <!-- SECCIÓN 1: INFORMACIÓN BÁSICA -->
            <fieldset class="md:col-span-2 border-t pt-6">
                <legend class="section-title">1. Información Básica</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="cantidad">Cantidad de Notas</label>
                        <input type="number" id="cantidad" placeholder="Escribe cantidad solicitada" min="1" required>
                    </div>
                    <div class="input-group">
                        <label>Selecciona cómo especificar el tamaño:</label>
                        <div class="flex items-center space-x-4">
                            <input type="radio" id="tamanoPredet" name="tipoTamano" value="predeterminado" checked>
                            <label for="tamanoPredet">Tamaño Predeterminado</label>
                            <input type="radio" id="tamanoPersonal" name="tipoTamano" value="personalizado">
                            <label for="tamanoPersonal">Medida Personalizada</label>
                        </div>
                    </div>
                </div>

                <!-- Contenedor para selector predeterminado -->
                <div id="tamanoPredetContainer" class="input-group">
                    <label for="tamano">Tamaño</label>
                    <select id="tamano">
                        <option value="" disabled selected>Selecciona el tamaño</option>
                        <option value="carta">Carta: 21.59 cm × 27.94 cm</option>
                        <option value="media_carta">1/2 Carta: 21.59 cm × 13.97 cm</option>
                        <option value="tercio_carta">1/3 Carta: 21.59 cm × 9.31 cm</option>
                        <option value="cuarto_carta">1/4 Carta: 10.79 cm × 13.97 cm</option>
                        <option value="oficio">Oficio: 21.59 cm × 34.00 cm</option>
                        <option value="media_oficio">1/2 Oficio: 21.59 cm × 17.00 cm</option>
                        <option value="tercio_oficio">1/3 Oficio: 21.59 cm × 11.33 cm</option>
                        <option value="cuarto_oficio">1/4 Oficio: 10.79 cm × 17.00 cm</option>
                    </select>
                </div>

                <!-- Contenedor para medidas personalizadas -->
                <div id="tamanoPersonalContainer" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="anchoCustom"><i class="fas fa-arrows-alt-h"></i> Ancho (cm)</label>
                        <input type="number" id="anchoCustom" placeholder="Ej: 15.5" step="0.01" min="0.1">
                    </div>
                    <div class="input-group">
                        <label for="largoCustom"><i class="fas fa-arrows-alt-v"></i> Largo (cm)</label>
                        <input type="number" id="largoCustom" placeholder="Ej: 20.0" step="0.01" min="0.1">
                    </div>
                </div>
            </fieldset>

            <!-- SECCIÓN 2: TIPO DE PAPEL -->
            <fieldset class="md:col-span-2 border-t pt-6">
                <legend class="section-title">2. Tipo de Papel</legend>
                <div class="input-group">
                    <label>¿Lleva copias (Papel Autocopia)?</label>
                    <div class="flex items-center space-x-4" id="tipoPapelRadios">
                        <!-- Ninguno seleccionado por defecto -->
                        <input type="radio" id="conCopia" name="tipoPapel" value="autocopia">
                        <label for="conCopia">Sí</label>
                        <input type="radio" id="sinCopia" name="tipoPapel" value="simple">
                        <label for="sinCopia">No</label>
                    </div>
                    <p id="tipoPapelError" class="text-red-500 text-sm mt-1 hidden">Por favor, selecciona una opción
                        para el tipo de papel.</p>
                </div>

                <!-- Opciones para Papel Autocopia -->
                <div id="opcionesAutocopia" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="numCopias">Número de Copias (además del original)</label>
                        <input type="number" id="numCopias" placeholder="¿Cuántas copias?" min="0">
                    </div>
                    <div id="coloresCopiasContainer" class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Los selectores de color se generarán aquí -->
                    </div>
                </div>

                <!-- Opciones para Papel Simple -->
                <div id="opcionesSimple" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="papelSimple">Tipo de Papel</label>
                        <select id="papelSimple">
                            <option value="" disabled selected>Selecciona el tipo de papel</option>
                            <option value="bond75">Bond 75gr</option>
                            <option value="bond90">Bond 90gr</option>
                            <option value="bristol180">Bristol 180gr</option>
                            <option value="seguridadHoops">Seguridad Hoops</option>
                            <option value="seguridadOaktree">Seguridad Oaktree</option>
                            <option value="opalina">Opalina 120gr</option> <!-- Nueva opción con 120gr -->
                        </select>
                    </div>
                    <div id="colorOaktreeContainer" class="input-group hidden">
                        <label for="colorOaktree">Color Papel Oaktree</label>
                        <select id="colorOaktree">
                            <option value="" disabled selected>Selecciona el color</option>
                            <option value="amarillo_claro">Amarillo Claro</option>
                            <option value="oro">Oro</option>
                            <option value="verde_claro">Verde Claro</option>
                            <option value="verde_oscuro">Verde Oscuro</option>
                            <option value="azul_claro">Azul Claro</option>
                            <option value="azul_oscuro">Azul Oscuro</option>
                            <option value="rosa">Rosa</option>
                            <option value="gris">Gris</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- SECCIÓN 3: ACABADOS Y DISEÑO -->
            <fieldset class="md:col-span-2 border-t pt-6">
                <legend class="section-title">3. Acabados y Diseño</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label for="folio">¿Lleva Folio?</label>
                        <select id="folio">
                            <option value="" disabled selected>Selecciona la opción</option>
                            <option value="no">No</option>
                            <option value="si">Sí</option>
                        </select>
                    </div>
                    <div id="folioColorContainer" class="input-group hidden">
                        <label for="folioColor">Color del Folio</label>
                        <select id="folioColor">
                            <option value="" disabled selected>Selecciona el color</option>
                            <option value="negro">Negro</option>
                            <option value="rojo">Rojo</option>
                            <option value="otro">Otro Color</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="impresion">Tipo de Impresión</label>
                        <select id="impresion">
                            <option value="" disabled selected>Selecciona la impresión</option>
                            <option value="bw">Blanco y Negro</option>
                            <option value="color1">1 Color Específico</option>
                            <option value="color2">2 Colores Específicos</option>
                            <option value="cmyk">Selección de Color (CMYK)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="diseno">Diseño</label>
                        <select id="diseno">
                            <option value="" disabled selected>Selecciona tipo de diseño</option>
                            <option value="cliente">Cliente envía diseño</option>
                            <option value="guardado">Diseño guardado aquí</option>
                            <option value="nuevo">Realizar diseño</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- SECCIÓN 4: COSTO DE MAQUILA -->
            <fieldset class="md:col-span-2 border-t pt-4">
                <div id="maquilaCard" onclick="toggleMaquila()"
                    class="maquila-card-off flex items-center gap-4 p-4 rounded-xl border-2 cursor-pointer select-none transition-all duration-300">
                    <input type="checkbox" id="maquilaCheck" class="sr-only">
                    <!-- Toggle switch -->
                    <div class="flex-shrink-0">
                        <div id="maquilaToggleTrack"
                            class="maquila-track-off w-14 h-7 rounded-full relative transition-all duration-300">
                            <div id="maquilaToggleThumb"
                                class="maquila-thumb-off absolute top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300">
                            </div>
                        </div>
                    </div>
                    <!-- Texto -->
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <span class="text-red-600 font-bold text-base">Costo de Maquila</span>
                            <span id="maquilaEstado"
                                class="text-xs font-bold px-2 py-0.5 rounded-full maquila-badge-off">DESACTIVADO</span>
                        </div>
                        <span class="text-gray-500 text-sm mt-0.5">Descuento del 18% del subtotal por concepto de
                            maquila</span>
                    </div>
                </div>
            </fieldset>

            <div class="md:col-span-2 mt-6">
                <button type="submit"
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-extrabold py-4 px-8 rounded-xl shadow-lg transform transition hover:scale-[1.02] duration-200 text-2xl uppercase tracking-wide border-b-4 border-blue-800 active:border-b-0 active:translate-y-1">
                    <i class="fas fa-calculator mr-2"></i> Calcular Cotización
                </button>
            </div>
        </form>

        <!-- Sección de Resultado con Desglose Colapsable -->
        <div id="resultado" class="hidden mt-8 transition-all duration-300">
            <!-- El contenido se inyectará aquí -->
        </div>

        <!-- Botón LIMPIAR CAMPOS mejorado -->
        <div class="md:col-span-2 mt-8 mb-12">
            <button type="button" id="limpiarCamposBtn"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-xl shadow-md transition-all duration-200 text-xl flex items-center justify-center gap-3">
                <i class="fas fa-trash-alt text-2xl"></i> <span class="tracking-wider">LIMPIAR CAMPOS</span>
            </button>
        </div>

        <!-- Sección de Consulta de Costos MAESTRA -->
        <div class="md:col-span-2 master-cost-details-section">
            <details id="masterCostDetails">
                <summary>Consulta y Edición de Costos Base</summary>
                <div class="master-cost-details-content">
                    <p class="text-gray-600 mb-4">Modifica los valores en los campos de la derecha. Deja un campo vacío
                        para usar el costo predefinido.</p>

                    <!-- Contenedores para la generación dinámica de costos -->
                    <details class="cost-details-section">
                        <summary class="text-lg text-orange-600">Costos de Papel</summary>
                        <div id="papelCostDetails" class="cost-details-content pt-2">
                            <!-- Contenido de costos de papel se generará aquí -->
                        </div>
                    </details>

                    <details class="cost-details-section mt-4">
                        <summary class="text-lg text-blue-600">Costos de Impresión</summary>
                        <div id="impresionCostDetails" class="cost-details-content pt-2">
                            <!-- Contenido de costos de impresión se generará aquí -->
                        </div>
                    </details>

                    <details class="cost-details-section mt-4">
                        <summary class="text-lg text-purple-600">Costos de Acabados</summary>
                        <div id="acabadosCostDetails" class="cost-details-content pt-2">
                            <!-- Contenido de costos de acabados se generará aquí -->
                        </div>
                    </details>

                    <details class="cost-details-section mt-4">
                        <summary class="text-lg text-green-600">Costos de Diseño</summary>
                        <div id="disenoCostDetails" class="cost-details-content pt-2">
                            <!-- Contenido de costos de diseño se generará aquí -->
                        </div>
                    </details>

                    <button type="button" id="updateCostsBtn"
                        class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg mt-6 hover:bg-indigo-700 transition-colors duration-300 text-lg">
                        Actualizar Costos Manuales y Recalcular
                    </button>
                    <button type="button" id="clearManualCostsBtn"
                        class="w-full bg-gray-400 text-white font-bold py-3 px-6 rounded-lg mt-2 hover:bg-gray-500 transition-colors duration-300 text-lg">
                        Borrar Ajustes Manuales
                    </button>
                </div>
            </details>
        </div>
    </div>

    <!-- Custom Alert Message Box -->
    <div id="customAlert" class="hidden"></div>

    <script>
        // --- CONFIGURACIÓN CENTRALIZADA DE COSTOS ---
        const APP_COST_CONFIG = {
            papel: {
                carta: {
                    autocopia_original: 0.43,
                    autocopia_final: 0.48,
                    autocopia_intermedio: 0.40,
                    bond75: 0.20,
                    bond90: 0.20,
                    bristol180: 1.21,
                    seguridadHoops: 0.52,
                    seguridadOaktree: 0.75,
                    opalina: 0.49 // Nuevo costo Opalina Carta
                },
                oficio: {
                    autocopia_original: 0.43,
                    autocopia_final: 0.48,
                    autocopia_intermedio: 0.40,
                    bond75: 0.21,
                    bond90: 0.25,
                    bristol180: 1.21,
                    seguridadHoops: 0.69,
                    seguridadOaktree: 1.00,
                    opalina: 0.64 // Nuevo costo Opalina Oficio
                }
            },
            impresionDigital: {
                bn: [
                    { min: 1, max: 50, carta: 0.8, oficio: 0.85 },
                    { min: 51, max: 100, carta: 0.78, oficio: 0.83 },
                    { min: 101, max: 150, carta: 0.78, oficio: 0.8 },
                    { min: 151, max: 200, carta: 0.7, oficio: 0.78 },
                    { min: 201, max: 500, carta: 0.68, oficio: 0.75 },
                    { min: 501, max: 1000, carta: 0.65, oficio: 0.7 }
                ],
                color: [
                    { min: 1, max: 50, carta: 6.04, oficio: 6.5 },
                    { min: 51, max: 100, carta: 6, oficio: 6.3 },
                    { min: 101, max: 150, carta: 5.85, oficio: 6 },
                    { min: 151, max: 200, carta: 5.7, oficio: 5.85 },
                    { min: 201, max: 500, carta: 5.5, oficio: 5.6 },
                    { min: 501, max: 1000, carta: 5.4, oficio: 5.45 }
                ]
            },
            acabadosDigital: {
                corte_2_div: 100, // 1/2 Carta/Oficio
                corte_3_div: 120, // 1/3 Carta/Oficio
                corte_4_div: 125, // 1/4 Carta/Oficio
                pegado: 85,
                compaginado_autocopia: 80, // Costo por servicio
                // folio_acabado_millar: 200 // Eliminado de aquí
            },
            servicios: {
                diseno_cliente: 60,
                diseno_guardado: 150,
                diseno_nuevo: 215.52,
                folio_por_diseno_cliente_guardado: 150 // Nuevo costo para folio cuando diseño es cliente/guardado
            }
        };

        // Objeto global para almacenar los ajustes manuales de costos individuales
        let individualCostOverrides = {};

        // Función para obtener un valor de costo de APP_COST_CONFIG
        function getBaseCostValue(path) {
            let value = APP_COST_CONFIG;
            const parts = path.split('.');
            for (let i = 0; i < parts.length; i++) {
                let part = parts[i];
                const arrayMatch = part.match(/(\w+)\[(\d+)\]/); // Check for array index pattern
                if (arrayMatch) {
                    const arrayName = arrayMatch[1];
                    const index = parseInt(arrayMatch[2], 10);
                    if (value && value[arrayName] !== undefined && Array.isArray(value[arrayName]) && value[arrayName][index] !== undefined) {
                        value = value[arrayName][index];
                    } else {
                        console.warn(`Path de costo '${path}' (parte array '${part}') no encontrado en APP_COST_CONFIG.`);
                        return undefined;
                    }
                } else {
                    if (value && value[part] !== undefined) {
                        value = value[part];
                    } else {
                        console.warn(`Path de costo '${path}' (parte '${part}') no encontrado en APP_COST_CONFIG.`);
                        return undefined;
                    }
                }
            }
            return value;
        }


        // Función para obtener un costo efectivo (con override si existe)
        function getEffectiveCostValue(path) {
            const overrideKey = `manual_${path.replace(/\./g, '_').replace(/\[/g, '__').replace(/\]/g, '')}`; // e.g., "manual_impresionDigital_bn__0__carta"
            if (individualCostOverrides[overrideKey] !== undefined && individualCostOverrides[overrideKey] !== null) {
                return individualCostOverrides[overrideKey];
            }
            return getBaseCostValue(path);
        }

        // Función para formatear valores a moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
        }

        // Function to show a custom alert message
        let customAlertTimeout; // To store the timeout ID
        function showCustomAlert(message) {
            const customAlert = document.getElementById('customAlert');
            customAlert.textContent = message;
            customAlert.classList.remove('hidden');

            // Clear any existing timeout to prevent multiple alerts from hiding too soon
            clearTimeout(customAlertTimeout);

            // Hide after a few seconds
            customAlertTimeout = setTimeout(() => {
                customAlert.classList.add('hidden');
            }, 5000);
        }

        // --- Funciones de validación visual (movidas al ámbito global) ---
        function markFieldError(element) {
            // Find the closest parent .input-group
            let parentGroup = element.closest('.input-group');
            if (parentGroup) {
                parentGroup.classList.add('input-error');
            } else if (element) {
                // Fallback if not inside an input-group, apply directly to the element
                element.classList.add('input-error');
            }
        }

        function clearFieldError(element) {
            let parentGroup = element.closest('.input-group');
            if (parentGroup) {
                parentGroup.classList.remove('input-error');
            } else if (element) {
                // Fallback
                element.classList.remove('input-error');
            }
        }

        function clearAllFieldErrors() {
            // Clear errors on input-group elements
            document.querySelectorAll('.input-group.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
            // Clear any potential direct errors on inputs/selects not inside a recognized input-group
            document.querySelectorAll('input.input-error, select.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
            // Also hide the specific radio button error message
            document.getElementById('tipoPapelError').classList.add('hidden');
        }

        // --- MOTOR DE CÁLCULO (movido al ámbito global) ---
        // Función para actualizar el objeto global `individualCostOverrides` desde los inputs
        function updateIndividualCostOverridesFromInputs() {
            const inputElements = document.querySelectorAll('.cost-details-content input.cost-input');
            inputElements.forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value)) {
                    individualCostOverrides[input.id] = value;
                } else {
                    individualCostOverrides[input.id] = null; // Borrar el override si el input está vacío o no es un número
                }
            });
            // console.log("Individual Cost Overrides actualizados:", individualCostOverrides);
        }

        function calcularCotizacion() {
            updateIndividualCostOverridesFromInputs();
            clearAllFieldErrors(); // Limpiar errores visuales al inicio de cada cálculo
            let isValid = true; // Bandera para rastrear la validez del formulario

            // 1. Recopilar datos del formulario
            const tipoProducto = document.getElementById('tipoProducto').value;
            const cantidad = parseInt(document.getElementById('cantidad').value);

            // Determinar si usa tamaño personalizado o predeterminado
            const tipoTamano = document.querySelector('input[name="tipoTamano"]:checked')?.value;
            let tamano;
            let usandoMedidasPersonalizadas = false;

            const conCopiaRadio = document.getElementById('conCopia');
            const sinCopiaRadio = document.getElementById('sinCopia');
            const esAutocopia = conCopiaRadio.checked;
            const numCopias = esAutocopia ? parseInt(document.getElementById('numCopias').value) : 0;
            const papelSimple = document.getElementById('papelSimple').value;
            const llevaFolio = document.getElementById('folio').value === 'si';
            const folioColor = document.getElementById('folioColor').value;
            const impresion = document.getElementById('impresion').value;
            const diseno = document.getElementById('diseno').value;

            // Validación de campos y marcaje de errores
            if (!tipoProducto) {
                markFieldError(document.getElementById('tipoProducto'));
                isValid = false;
            }
            if (isNaN(cantidad) || cantidad <= 0) {
                markFieldError(document.getElementById('cantidad'));
                isValid = false;
            }

            // Validar tamaño según el modo seleccionado
            if (tipoTamano === 'personalizado') {
                const anchoCm = parseFloat(document.getElementById('anchoCustom').value);
                const largoCm = parseFloat(document.getElementById('largoCustom').value);

                // Validar inputs personalizados
                if (isNaN(anchoCm) || anchoCm <= 0) {
                    markFieldError(document.getElementById('anchoCustom'));
                    isValid = false;
                }
                if (isNaN(largoCm) || largoCm <= 0) {
                    markFieldError(document.getElementById('largoCustom'));
                    isValid = false;
                }

                // Si los inputs son válidos, seleccionar tamaño óptimo
                if (!isNaN(anchoCm) && anchoCm > 0 && !isNaN(largoCm) && largoCm > 0) {
                    tamano = seleccionarTamanoOptimo(anchoCm, largoCm);
                    usandoMedidasPersonalizadas = true;
                    // Mensaje informativo al usuario
                    const tamanoNombre = document.getElementById('tamano').querySelector(`option[value="${tamano}"]`).text.split(':')[0];
                    showCustomAlert(`Se usará el tamaño ${tamanoNombre} para tus medidas de ${anchoCm}×${largoCm} cm`);
                }
            } else {
                tamano = document.getElementById('tamano').value;
                // Validación existente
                if (!tamano) {
                    markFieldError(document.getElementById('tamano'));
                    isValid = false;
                }
            }
            // Check if any radio button for tipoPapel is selected
            const tipoPapelSelected = document.querySelector('input[name="tipoPapel"]:checked');
            const tipoPapelError = document.getElementById('tipoPapelError');
            if (!tipoPapelSelected) {
                markFieldError(document.getElementById('tipoPapelRadios')); // Marca el contenedor de los radios
                tipoPapelError.classList.remove('hidden'); // Show inline error
                isValid = false;
            } else {
                tipoPapelError.classList.add('hidden'); // Hide inline error if valid
            }

            if (esAutocopia) {
                if (isNaN(numCopias) || numCopias < 0) {
                    markFieldError(document.getElementById('numCopias'));
                    isValid = false;
                }
                const coloresCopiasGenerados = document.querySelectorAll('#coloresCopiasContainer select');
                for (let i = 0; i < coloresCopiasGenerados.length; i++) {
                    if (!coloresCopiasGenerados[i].value) {
                        markFieldError(coloresCopiasGenerados[i]);
                        isValid = false;
                    }
                }
            } else if (!papelSimple) {
                markFieldError(document.getElementById('papelSimple'));
                isValid = false;
            }
            if (papelSimple === 'seguridadOaktree' && document.getElementById('colorOaktreeContainer').classList.contains('hidden') === false && !document.getElementById('colorOaktree').value) {
                markFieldError(document.getElementById('colorOaktree'));
                isValid = false;
            }

            if (!document.getElementById('folio').value) {
                markFieldError(document.getElementById('folio'));
                isValid = false;
            }
            if (llevaFolio && !folioColor) {
                markFieldError(document.getElementById('folioColor'));
                isValid = false;
            }
            if (!document.getElementById('impresion').value) {
                markFieldError(document.getElementById('impresion'));
                isValid = false;
            }
            if (!document.getElementById('diseno').value) {
                markFieldError(document.getElementById('diseno'));
                isValid = false;
            }

            if (!isValid) {
                showCustomAlert('Por favor, completa todos los campos resaltados en rojo.');
                return false; // Indicar que la validación falló
            }

            // 2. Cálculos iniciales
            const basePapel = tamano.includes('oficio') ? 'oficio' : 'carta';
            const factorDivision = {
                carta: 1, media_carta: 2, tercio_carta: 3, cuarto_carta: 4,
                oficio: 1, media_oficio: 2, tercio_oficio: 3, cuarto_oficio: 4
            }[tamano];

            const hojasRequeridasCliente = Math.ceil(cantidad / factorDivision);
            const numPartes = esAutocopia ? 1 + numCopias : 1;

            // Todas las cotizaciones ahora se hacen con el método Digital
            const resultado = calcularDigital(cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, folioColor, impresion, diseno, basePapel, factorDivision, hojasRequeridasCliente, numPartes);

            // 3. Mostrar resultado
            mostrarResultado(resultado, { cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, folioColor, impresion, diseno, hojasRequeridasCliente }); // Pasa hojasRequeridasCliente
            return true; // Indicar que la cotización se realizó con éxito
        }

        // Función para obtener el texto descriptivo del tipo de papel (para resumen)
        function getTipoPapelText(esAutocopia, numCopias, papelSimple) {
            if (esAutocopia) {
                // Construir descripción detallada: original + copias con sus colores
                let descripcion = 'Autocopia: original';
                if (numCopias > 0) {
                    // Copias intermedias
                    for (let i = 1; i < numCopias; i++) {
                        const colorSelect = document.getElementById(`intermedio_color_${i}`);
                        const colorNombre = colorSelect && colorSelect.value ? colorSelect.options[colorSelect.selectedIndex].text : 'color';
                        descripcion += ` y copia ${i} ${colorNombre}`;
                    }
                    // Copia final
                    const colorFinalSelect = document.getElementById('final_color');
                    const colorFinalNombre = colorFinalSelect && colorFinalSelect.value ? colorFinalSelect.options[colorFinalSelect.selectedIndex].text : 'color';
                    descripcion += ` y copia final ${colorFinalNombre}`;
                }
                return descripcion;
            } else {
                const papelSelect = document.getElementById('papelSimple');
                // Retorna el texto visible del option seleccionado
                return papelSelect.options[papelSelect.selectedIndex].text;
            }
        }

        // Función para obtener el texto descriptivo del tipo de impresión (para resumen)
        function getImpresionText(impresionValue) {
            const impresionSelect = document.getElementById('impresion');
            return impresionSelect.options[impresionSelect.selectedIndex].text;
        }

        // Función para obtener el texto descriptivo del diseño (para resumen)
        function getDisenoText(disenoValue) {
            const disenoSelect = document.getElementById('diseno');
            return disenoSelect.options[disenoSelect.selectedIndex].text;
        }

        // Mapa de medidas en centímetros para cada tamaño
        const tamanoMedidas = {
            'carta': '21.59 cm × 27.94 cm',
            'media_carta': '21.59 cm × 13.97 cm',
            'tercio_carta': '21.59 cm × 9.31 cm',
            'cuarto_carta': '10.79 cm × 13.97 cm',
            'oficio': '21.59 cm × 34.00 cm',
            'media_oficio': '21.59 cm × 17.00 cm',
            'tercio_oficio': '21.59 cm × 11.33 cm',
            'cuarto_oficio': '10.79 cm × 17.00 cm'
        };

        // Función para seleccionar automáticamente el tamaño óptimo basado en medidas personalizadas
        function seleccionarTamanoOptimo(anchoCm, largoCm) {
            const tamanosDisponibles = {
                'cuarto_carta': { ancho: 10.79, largo: 13.97, area: 150.7 },
                'tercio_carta': { ancho: 21.59, largo: 9.31, area: 201.0 },
                'media_carta': { ancho: 21.59, largo: 13.97, area: 301.6 },
                'cuarto_oficio': { ancho: 10.79, largo: 17.00, area: 183.4 },
                'tercio_oficio': { ancho: 21.59, largo: 11.33, area: 244.6 },
                'media_oficio': { ancho: 21.59, largo: 17.00, area: 367.0 },
                'carta': { ancho: 21.59, largo: 27.94, area: 603.2 },
                'oficio': { ancho: 21.59, largo: 34.00, area: 734.1 }
            };

            const candidatos = [];

            for (const [key, dim] of Object.entries(tamanosDisponibles)) {
                // Verificar si la medida personalizada cabe (en cualquier orientación)
                const cabeNormal = anchoCm <= dim.ancho && largoCm <= dim.largo;
                const cabeRotado = largoCm <= dim.ancho && anchoCm <= dim.largo;

                if (cabeNormal || cabeRotado) {
                    candidatos.push({ key, area: dim.area });
                }
            }

            // Ordenar por área ascendente y retornar el más pequeño que quepa
            if (candidatos.length > 0) {
                candidatos.sort((a, b) => a.area - b.area);
                return candidatos[0].key;
            }

            // Si no cabe en ninguno, retornar el más grande (oficio)
            return 'oficio';
        }

        // Función para obtener el texto del tipo de producto
        function getTipoProductoText() {
            const tipoProductoSelect = document.getElementById('tipoProducto');
            if (tipoProductoSelect && tipoProductoSelect.value) {
                return tipoProductoSelect.options[tipoProductoSelect.selectedIndex].text;
            }
            return 'Notas'; // Valor por defecto
        }

        // Función para construir el texto de resumen para el cliente
        function getSummaryText(res, params) {
            const { cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, impresion, diseno, factorDivision } = params;

            const tipoProducto = getTipoProductoText();
            let summary = `${cantidad} ${tipoProducto} `;

            // Obtener nombre del tamaño sin las medidas (del texto visible del select)
            const tamanoTextoCompleto = document.getElementById('tamano').options[document.getElementById('tamano').selectedIndex].text;
            const tamanoNombre = tamanoTextoCompleto.split(':')[0]; // Obtener solo "Carta", "1/2 Carta", etc.
            const medidas = tamanoMedidas[tamano] || '';

            summary += `tamaño ${tamanoNombre} (${medidas}) `;
            // Usa la función getTipoPapelText para el resumen
            summary += `en papel ${getTipoPapelText(esAutocopia, numCopias, papelSimple)} `;

            if (llevaFolio) {
                summary += `con Folio `;
            }

            const acabadosParts = [];
            let isCortadas = false;
            let isPegadas = false;
            let isCompaginadas = false;

            if (factorDivision > 1) {
                isCortadas = true;
            }
            if (esAutocopia) {
                isCompaginadas = true;
            }
            // Para el método Digital, el pegado aplica si las notas son cortadas (implica que se forman blocs)
            if (isCortadas) {
                isPegadas = true;
            }

            if (isCortadas && isPegadas) {
                acabadosParts.push('cortadas y pegadas');
            } else if (isCortadas) {
                acabadosParts.push('cortadas');
            } else if (isPegadas) {
                acabadosParts.push('pegadas');
            }

            if (isCompaginadas) {
                acabadosParts.push('compaginadas');
            }

            let acabadosStr = '';
            if (acabadosParts.length > 0) {
                acabadosStr = acabadosParts.join(', ');
            }

            if (acabadosStr) {
                summary += `con impresión ${getImpresionText(impresion)}, ${acabadosStr}, `;
            } else {
                summary += `con impresión ${getImpresionText(impresion)}, `;
            }

            summary += `${getDisenoText(diseno)}, `;

            // Precio unitario CON IVA redondeado hacia arriba
            summary += `Precio Unitario (con IVA): ${formatCurrency(res.precioUnitarioConIVA)}, `;
            summary += `TOTAL: ${formatCurrency(res.total)}. `;
            summary += `Método de impresión: Impresión Digital`;

            // Si hay maquila, agregar al final
            if (res.aplicaMaquila) {
                summary += ` (Precio de Maquila)`;
            }
            summary += `.`;

            return summary;
        }

        // Función para mostrar los resultados en la UI
        function mostrarResultado(res, params) {
            const resultadoDiv = document.getElementById('resultado');
            if (!res) {
                resultadoDiv.classList.add('hidden');
                return;
            }

            resultadoDiv.classList.remove('hidden');

            // Sección de maquila en el desglose
            const maquilaBreakdownHtml = res.aplicaMaquila ? `
                <div>
                    <h3 class="text-sm font-bold text-red-700 uppercase tracking-wider border-b border-red-200 pb-1">Descuento Maquila (18%)</h3>
                    <div class="flex justify-between text-red-600 mt-1 font-semibold">
                        <span>Descuento aplicado:</span>
                        <span class="font-mono">- ${formatCurrency(res.descuentoMaquila)}</span>
                    </div>
                    <p class="text-xs text-red-400 mt-1 bg-red-50 p-2 rounded">${res.maquilaFormula}</p>
                </div>
            ` : '';

            // Desglose de costos detallado
            let breakdownHtml = `
                <div id="breakdownContent" class="hidden transition-all duration-300 ease-in-out mt-4 bg-white p-4 rounded-lg border border-gray-200 shadow-inner">
                    <p class="text-sm text-gray-500 mb-2">Método: <span class="font-semibold text-gray-700">Impresión Digital</span></p>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider border-b pb-1">Papel</h3>
                            <div class="flex justify-between text-gray-700 mt-1"><span>Costo:</span> <span class="font-mono">${formatCurrency(res.costos.papel)}</span></div>
                            <p class="text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded">${res.papelFormula}</p>
                        </div>
                        
                        <div>
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider border-b pb-1">Impresión</h3>
                            <div class="flex justify-between text-gray-700 mt-1"><span>Costo:</span> <span class="font-mono">${formatCurrency(res.costos.impresion)}</span></div>
                            <p class="text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded">${res.impresionFormula}</p>
                        </div>

                        <div>
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider border-b pb-1">Acabados</h3>
                            <div class="flex justify-between text-gray-700 mt-1"><span>Costo:</span> <span class="font-mono">${formatCurrency(res.costos.acabados)}</span></div>
                            <p class="text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded">${res.acabadosFormula}</p>
                        </div>

                        <div>
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider border-b pb-1">Servicios</h3>
                            <div class="flex justify-between text-gray-700 mt-1"><span>Costo:</span> <span class="font-mono">${formatCurrency(res.costos.servicios)}</span></div>
                            <p class="text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded">${res.serviciosFormula}</p>
                        </div>

                        ${maquilaBreakdownHtml}
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-300">
                        <div class="flex justify-between text-sm text-gray-600"><span>Subtotal Base:</span> <span>${formatCurrency(res.subtotalBase)}</span></div>
                        ${res.aplicaMaquila ? `<div class="flex justify-between text-sm text-red-600 font-semibold"><span>Descuento Maquila (18%):</span> <span>- ${formatCurrency(res.descuentoMaquila)}</span></div>` : ''}
                        <div class="flex justify-between text-sm text-gray-600"><span>Subtotal con descuento:</span> <span>${formatCurrency(res.subtotal)}</span></div>
                        <div class="flex justify-between text-sm text-gray-600"><span>IVA (16%):</span> <span>${formatCurrency(res.iva)}</span></div>
                        <div class="flex justify-between font-bold text-gray-800 mt-1"><span>Precio Unitario (con IVA):</span> <span>${formatCurrency(res.precioUnitarioConIVA)}</span></div>
                        <div class="flex justify-between font-bold text-green-700 mt-1 text-lg"><span>TOTAL:</span> <span>${formatCurrency(res.total)}</span></div>
                    </div>
                </div>
            `;

            resultadoDiv.innerHTML = `
                <div class="result-card bg-white border-2 border-indigo-100 rounded-2xl shadow-xl overflow-hidden">
                    <div class="bg-indigo-50 p-6 text-center border-b border-indigo-100">
                        <h2 class="text-2xl font-extrabold text-indigo-900 mb-2 tracking-tight">Cotización Estimada</h2>
                        <div class="text-5xl font-black text-green-600 my-4 drop-shadow-sm">${formatCurrency(res.total)}</div>
                        <p class="text-sm text-indigo-600 font-medium">${formatCurrency(res.precioUnitarioConIVA)} / unidad (con IVA incluido)</p>
                        ${res.aplicaMaquila ? '<p class="text-xs text-red-500 font-semibold mt-1">✓ Descuento de Maquila (18%) aplicado</p>' : ''}
                    </div>

                    <div class="p-6">
                        <div class="flex justify-end mb-4">
                            <button onclick="document.getElementById('breakdownContent').classList.toggle('hidden')" 
                                class="flex items-center gap-2 text-indigo-600 hover:text-indigo-800 font-bold bg-indigo-50 hover:bg-indigo-100 px-4 py-2 rounded-lg transition-colors text-sm uppercase tracking-wide">
                                <i class="fas fa-info-circle"></i> Explicación de Costos
                            </button>
                        </div>

                        ${breakdownHtml}

                        <div class="copy-text-container bg-blue-50 border border-blue-200 rounded-xl p-6 mt-6">
                            <p class="text-blue-900 font-bold mb-2 flex items-center gap-2"><i class="fas fa-file-alt"></i> Resumen para Cliente:</p>
                            <p id="clientSummaryText" class="text-gray-700 text-sm leading-relaxed mb-4 bg-white p-3 rounded border border-blue-100 shadow-sm">${getSummaryText(res, { ...params, factorDivision: res.factorDivision })}</p>
                            <button class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all transform hover:scale-[1.01] active:scale-95 flex items-center justify-center gap-2 text-lg" onclick="copyToClipboard('clientSummaryText')">
                                <i class="fas fa-copy"></i> COPIAR AL PORTAPAPELES
                            </button>
                        </div>
                        ${params.hojasRequeridasCliente > 250 ? '<div class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 text-sm font-medium rounded-r"><i class="fas fa-exclamation-triangle mr-2"></i>¡Importante! Para esta cantidad, se recomienda cotizar en Offset.</div>' : ''}
                    </div>
                </div>
            `;
            resultadoDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Función para copiar texto al portapapeles
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges();
            showCustomAlert('Texto copiado al portapapeles!');
        }

        // --- LÓGICA DE COTIZACIÓN DIGITAL ---
        function calcularDigital(cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, folioColor, impresion, diseno, basePapel, factorDivision, hojasRequeridasCliente, numPartes) {
            const costos = { papel: 0, impresion: 0, acabados: 0, servicios: 0 };
            let papelFormula = '';
            let impresionFormula = '';
            let acabadosFormula = '';
            let serviciosFormula = '';

            const tamanoDisplayName = document.getElementById('tamano').options[document.getElementById('tamano').selectedIndex].text;
            const hojasRequeridasFormula = `(Cantidad de Notas (${cantidad}) / Factor de División por tamaño (${factorDivision})) = ${hojasRequeridasCliente} hojas de cliente. `;

            // --- Costo Papel ---
            if (esAutocopia) {
                const costoOriginal = getEffectiveCostValue(`papel.${basePapel}.autocopia_original`);
                const costoFinal = getEffectiveCostValue(`papel.${basePapel}.autocopia_final`);
                const costoIntermedio = getEffectiveCostValue(`papel.${basePapel}.autocopia_intermedio`);

                let costoBasePapelCalculado = 0;
                costoBasePapelCalculado += hojasRequeridasCliente * costoOriginal;
                costoBasePapelCalculado += hojasRequeridasCliente * costoFinal;
                papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoOriginal.toFixed(2)}/hoja original) + `;
                papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoFinal.toFixed(2)}/hoja final) `;

                if (numCopias > 1) {
                    costoBasePapelCalculado += hojasRequeridasCliente * (numCopias - 1) * costoIntermedio;
                    papelFormula += `+ (${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${numCopias - 1} copias intermedias x ${costoIntermedio.toFixed(2)}/hoja)`;
                }
                costos.papel = costoBasePapelCalculado * 2;
                papelFormula = hojasRequeridasFormula + `(${papelFormula}) * 2 (utilidad del papel)`;
            } else {
                const papelSimpleDisplayName = document.getElementById('papelSimple').options[document.getElementById('papelSimple').selectedIndex].text;

                // Condición para el papel Opalina
                if (papelSimple === 'opalina') {
                    const costoUnitarioOpalina = getEffectiveCostValue(`papel.${basePapel}.opalina`);
                    let costoBasePapelCalculado = hojasRequeridasCliente * costoUnitarioOpalina;
                    papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoUnitarioOpalina.toFixed(2)}/hoja de ${papelSimpleDisplayName})`;
                    costos.papel = costoBasePapelCalculado * 2;
                    papelFormula = hojasRequeridasFormula + `(${papelFormula}) * 2 (utilidad del papel)`;
                } else if (papelSimple.startsWith('bond')) {
                    costos.papel = 0;
                    papelFormula = hojasRequeridasFormula + `Costo de papel Bond (${papelSimpleDisplayName}) incluido en impresión digital. Utilidad del papel ya aplicada.`;
                } else {
                    const costoUnitarioPapelSimple = getEffectiveCostValue(`papel.${basePapel}.${papelSimple}`);
                    let costoBasePapelCalculado = hojasRequeridasCliente * costoUnitarioPapelSimple;
                    papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoUnitarioPapelSimple.toFixed(2)}/hoja de ${papelSimpleDisplayName})`;
                    costos.papel = costoBasePapelCalculado * 2;
                    papelFormula = hojasRequeridasFormula + `(${papelFormula}) * 2 (utilidad del papel)`;
                }
            }

            // --- Costo Impresión (digital) ---
            let tarifaImpresion = 0;
            const esImpresionBN = impresion === 'bw';
            const folioCambiaColor = llevaFolio && (folioColor === 'rojo' || folioColor === 'otro');

            const currentImpresionType = (!esImpresionBN || folioCambiaColor) ? 'color' : 'bn'; // Determine if it's color or B/N based on selections
            const impressionRates = APP_COST_CONFIG.impresionDigital[currentImpresionType];

            // Find the correct rate based on quantity
            let foundRate = false;
            for (let i = 0; i < impressionRates.length; i++) {
                const rate = impressionRates[i];
                if (cantidad >= rate.min && cantidad <= rate.max) {
                    tarifaImpresion = getEffectiveCostValue(`impresionDigital.${currentImpresionType}[${i}].${basePapel}`);
                    impresionFormula += `Tarifa ${currentImpresionType.toUpperCase()} ${basePapel === 'carta' ? 'Carta' : 'Oficio'} (Cant: ${rate.min}-${rate.max}): ${tarifaImpresion.toFixed(2)}`;
                    foundRate = true;
                    break;
                }
            }
            // If quantity is above the last defined range, use the last rate
            if (!foundRate && cantidad > impressionRates[impressionRates.length - 1].max) {
                const lastRateIndex = impressionRates.length - 1;
                const lastRate = impressionRates[lastRateIndex];
                tarifaImpresion = getEffectiveCostValue(`impresionDigital.${currentImpresionType}[${lastRateIndex}].${basePapel}`);
                impresionFormula += `Tarifa ${currentImpresionType.toUpperCase()} ${basePapel === 'carta' ? 'Carta' : 'Oficio'} (Cant: >${lastRate.max}): ${tarifaImpresion.toFixed(2)}`;
            } else if (!foundRate) {
                // Fallback if no rate found (e.g., quantity is 0 or invalid)
                tarifaImpresion = 0;
                impresionFormula += `No se encontró tarifa de impresión para la cantidad y tipo de impresión seleccionados.`;
            }

            costos.impresion = (hojasRequeridasCliente * numPartes) * tarifaImpresion;
            impresionFormula = `(${hojasRequeridasCliente} cantidad de hojas x ${numPartes} partes) x (${impresionFormula}). `;
            if (esImpresionBN && folioCambiaColor) {
                impresionFormula += `(La impresión B/N se cotiza como Color debido al color de folio seleccionado).`;
            }


            // --- Costos Acabados (digital) ---
            let corteCosto = 0;
            acabadosFormula += 'Corte: ';
            if (factorDivision === 2) { corteCosto = getEffectiveCostValue('acabadosDigital.corte_2_div'); acabadosFormula += `${corteCosto} (1/2 Carta/Oficio) `; }
            if (factorDivision === 3) { corteCosto = getEffectiveCostValue('acabadosDigital.corte_3_div'); acabadosFormula += `${corteCosto} (1/3 Carta/Oficio) `; }
            if (factorDivision === 4) { corteCosto = getEffectiveCostValue('acabadosDigital.corte_4_div'); acabadosFormula += `${corteCosto} (1/4 Carta/Oficio) `; }
            costos.acabados += corteCosto;

            const pegadoCosto = getEffectiveCostValue('acabadosDigital.pegado');
            costos.acabados += pegadoCosto;
            acabadosFormula += `+ Pegado: ${pegadoCosto}`;

            if (esAutocopia) {
                const compaginadoCosto = getEffectiveCostValue('acabadosDigital.compaginado_autocopia');
                costos.acabados += compaginadoCosto;
                acabadosFormula += `+ Compaginado: ${compaginadoCosto}`;
            }

            // El costo del folio se mueve a la sección de servicios según el tipo de diseño

            // --- Costos Servicios (digital) ---
            serviciosFormula += 'Diseño: ';
            const disenoCosto = {
                cliente: getEffectiveCostValue('servicios.diseno_cliente'),
                guardado: getEffectiveCostValue('servicios.diseno_guardado'),
                nuevo: getEffectiveCostValue('servicios.diseno_nuevo')
            }[diseno];
            serviciosFormula += `${disenoCosto} (${getDisenoText(diseno)})`;
            costos.servicios += disenoCosto;

            if (llevaFolio) {
                if (diseno === 'cliente' || diseno === 'guardado') {
                    const folioServicioCosto = getEffectiveCostValue('servicios.folio_por_diseno_cliente_guardado');
                    costos.servicios += folioServicioCosto;
                    serviciosFormula += ` + Costo Folio: ${folioServicioCosto} (cuando diseño es cliente/guardado)`;
                } else if (diseno === 'nuevo') {
                    // No additional cost for folio if new design is being made, it's included in 'nuevo' design cost
                    serviciosFormula += ` (Folio incluido en costo de "Realizar diseño")`;
                }
            }


            const subtotalBase = costos.papel + costos.impresion + costos.acabados + costos.servicios;

            // Verificar si se aplica maquila
            const aplicaMaquila = document.getElementById('maquilaCheck') && document.getElementById('maquilaCheck').checked;
            const descuentoMaquila = aplicaMaquila ? subtotalBase * 0.18 : 0;
            const maquilaFormula = aplicaMaquila ? `Descuento Maquila = Subtotal Base (${formatCurrency(subtotalBase)}) × 18% = ${formatCurrency(descuentoMaquila)}` : '';

            const subtotal = subtotalBase - descuentoMaquila;
            const iva = subtotal * 0.16;
            const totalExacto = subtotal + iva;

            // Redondear total hacia arriba al entero más cercano
            const total = Math.ceil(totalExacto);

            // Precio unitario con IVA: total redondeado / cantidad, redondeado hacia arriba
            // Para que sea coherente: precioUnitario * cantidad = total
            const precioUnitarioConIVAExacto = totalExacto / cantidad;
            const precioUnitarioConIVA = Math.ceil(precioUnitarioConIVAExacto * 100) / 100; // Redondear hacia arriba a 2 decimales

            // Precio unitario sin IVA (referencia)
            const precioUnitarioSinIVA = subtotal / cantidad;

            return {
                metodo: 'Digital',
                costos,
                subtotalBase,
                descuentoMaquila,
                maquilaFormula,
                aplicaMaquila,
                subtotal,
                iva,
                total,
                precioUnitarioSinIVA,
                precioUnitarioConIVA,
                papelFormula,
                impresionFormula,
                acabadosFormula,
                serviciosFormula,
                factorDivision
            };
        }

        // --- LÓGICA DE LA INTERFAZ ---
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('cotizadorForm');

            // Elementos del DOM del formulario
            const cantidadInput = document.getElementById('cantidad');
            const tamanoSelect = document.getElementById('tamano');
            const conCopiaRadio = document.getElementById('conCopia');
            const sinCopiaRadio = document.getElementById('sinCopia');
            const opcionesAutocopia = document.getElementById('opcionesAutocopia');
            const opcionesSimple = document.getElementById('opcionesSimple');
            const papelSimpleSelect = document.getElementById('papelSimple');
            const colorOaktreeContainer = document.getElementById('colorOaktreeContainer');
            const folioSelect = document.getElementById('folio');
            const folioColorContainer = document.getElementById('folioColorContainer');
            const numCopiasInput = document.getElementById('numCopias');
            const coloresCopiasContainer = document.getElementById('coloresCopiasContainer');
            const impresionSelect = document.getElementById('impresion');
            const disenoSelect = document.getElementById('diseno');
            const limpiarCamposBtn = document.getElementById('limpiarCamposBtn');

            // Elementos para el control maestro de costos
            const masterCostDetails = document.getElementById('masterCostDetails');
            const updateCostsBtn = document.getElementById('updateCostsBtn');
            const clearManualCostsBtn = document.getElementById('clearManualCostsBtn');


            // --- Funciones de UI ---

            // Función para actualizar visibilidad de opciones de papel
            function actualizarOpcionesPapel() {
                // console.log('--- actualizarOpcionesPapel disparado ---');
                // console.log('Con Copia:', conCopiaRadio.checked);
                // console.log('Sin Copia:', sinCopiaRadio.checked);

                // Clear errors on related fields when changing selection
                clearFieldError(conCopiaRadio);
                clearFieldError(sinCopiaRadio);
                clearFieldError(numCopiasInput);
                clearFieldError(papelSimpleSelect);
                clearFieldError(document.getElementById('colorOaktree'));

                document.getElementById('tipoPapelError').classList.add('hidden');

                if (conCopiaRadio.checked) {
                    // console.log('Mostrando Autocopia...');
                    opcionesAutocopia.classList.remove('hidden');
                    opcionesSimple.classList.add('hidden');
                    actualizarColoresCopias();
                } else if (sinCopiaRadio.checked) {
                    // console.log('Mostrando Simple...');
                    opcionesAutocopia.classList.add('hidden');
                    // console.log('Clases ANTES de quitar hidden:', opcionesSimple.className);
                    opcionesSimple.classList.remove('hidden');
                    // console.log('Clases DESPUÉS de quitar hidden:', opcionesSimple.className);
                } else {
                    // console.log('Ocultando todo...');
                    opcionesAutocopia.classList.add('hidden');
                    opcionesSimple.classList.add('hidden');
                }
                actualizarColorOaktree();
            }

            // Función para actualizar visibilidad de color Oaktree
            function actualizarColorOaktree() {
                clearFieldError(papelSimpleSelect);
                clearFieldError(document.getElementById('colorOaktree'));

                // Solo mostrar si papelSimpleSelect.value es 'seguridadOaktree' Y opcionesSimple está visible
                if (papelSimpleSelect.value === 'seguridadOaktree' && !opcionesSimple.classList.contains('hidden')) {
                    colorOaktreeContainer.classList.remove('hidden');
                } else {
                    colorOaktreeContainer.classList.add('hidden');
                }
            }

            // Función para actualizar visibilidad de color de folio
            function actualizarColorFolio() {
                clearFieldError(folioSelect);
                clearFieldError(document.getElementById('folioColor'));
                if (folioSelect.value === 'si') {
                    folioColorContainer.classList.remove('hidden');
                } else {
                    folioColorContainer.classList.add('hidden');
                }
            }

            // Función para alternar entre modo predeterminado y personalizado de tamaño
            function actualizarModoTamano() {
                const tamanoPersonalRadio = document.getElementById('tamanoPersonal');
                const tamanoPredetContainer = document.getElementById('tamanoPredetContainer');
                const tamanoPersonalContainer = document.getElementById('tamanoPersonalContainer');

                // Limpiar errores de ambos modos
                clearFieldError(document.getElementById('tamano'));
                clearFieldError(document.getElementById('anchoCustom'));
                clearFieldError(document.getElementById('largoCustom'));

                if (tamanoPersonalRadio.checked) {
                    // Mostrar campos personalizados, ocultar selector
                    tamanoPredetContainer.classList.add('hidden');
                    tamanoPersonalContainer.classList.remove('hidden');
                    document.getElementById('tamano').value = ''; // Limpiar selector
                } else {
                    // Mostrar selector, ocultar campos personalizados
                    tamanoPredetContainer.classList.remove('hidden');
                    tamanoPersonalContainer.classList.add('hidden');
                    document.getElementById('anchoCustom').value = '';
                    document.getElementById('largoCustom').value = '';
                }
            }

            // Función para generar selectores de color para copias
            function actualizarColoresCopias() {
                clearFieldError(numCopiasInput); // Clear error when number of copies changes
                coloresCopiasContainer.innerHTML = '';
                const copias = parseInt(numCopiasInput.value) || 0;
                // Solo generar si "Sí" está marcado y hay copias > 0
                if (copias <= 0 || !conCopiaRadio.checked) {
                    return;
                }

                const colores = ['Verde', 'Azul', 'Rosa', 'Amarillo'];

                // Copias intermedias
                for (let i = 1; i < copias; i++) {
                    const id = `intermedio_color_${i}`;
                    let html = `<div class="input-group"><label for="${id}">Color Intermedio ${i}</label><select id="${id}">`;
                    html += `<option value="" disabled selected>Selecciona el color</option>`;
                    colores.forEach(color => {
                        html += `<option value="${color.toLowerCase()}">${color}</option>`;
                    });
                    html += `</select></div>`;
                    coloresCopiasContainer.innerHTML += html;
                }

                // Copia final
                const idFinal = 'final_color';
                let htmlFinal = `<div class="input-group"><label for="${idFinal}">Color Copia Final</label><select id="${idFinal}">`;
                htmlFinal += `<option value="" disabled selected>Selecciona el color</option>`;
                colores.forEach(color => {
                    htmlFinal += `<option value="${color.toLowerCase()}">${color}</option>`;
                });
                htmlFinal += `</select></div>`;
                coloresCopiasContainer.innerHTML += htmlFinal;
            }

            // Función para limpiar todos los campos del formulario y ocultar el resultado
            function limpiarCampos() {
                cantidadInput.value = '';
                numCopiasInput.value = '';

                tamanoSelect.value = '';
                papelSimpleSelect.value = '';
                folioSelect.value = '';
                impresionSelect.value = '';
                disenoSelect.value = '';

                // Limpiar el selector de tipo de producto
                const tipoProductoSelect = document.getElementById('tipoProducto');
                if (tipoProductoSelect) tipoProductoSelect.value = '';

                // Limpiar campos de medidas personalizadas
                document.getElementById('anchoCustom').value = '';
                document.getElementById('largoCustom').value = '';

                // Resetear a modo predeterminado
                document.getElementById('tamanoPredet').checked = true;
                actualizarModoTamano();

                conCopiaRadio.checked = false;
                sinCopiaRadio.checked = false;

                document.getElementById('resultado').classList.add('hidden');
                colorOaktreeContainer.classList.add('hidden');
                folioColorContainer.classList.add('hidden');
                coloresCopiasContainer.innerHTML = '';

                clearAllFieldErrors(); // Clear all red borders
                clearIndividualCostOverrides(); // Llama a la nueva función de limpieza
                actualizarOpcionesPapel(); // Asegurar el estado inicial correcto al limpiar (ocultar todo)
            }

            // --- Event Listeners ---
            // console.log('Iniciando asignación de eventos...');

            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    clearAllFieldErrors(); // Clear previous errors before validating
                    calcularCotizacion();
                });
                // console.log('Evento submit asignado.');
            } else {
                console.error('ERROR CRÍTICO: Formulario no encontrado');
            }

            if (conCopiaRadio && sinCopiaRadio) {
                conCopiaRadio.addEventListener('change', actualizarOpcionesPapel);
                sinCopiaRadio.addEventListener('change', actualizarOpcionesPapel);
                // console.log('Eventos de radio buttons asignados.');
            } else {
                console.error('ERROR CRÍTICO: Radio buttons no encontrados');
            }

            if (papelSimpleSelect) papelSimpleSelect.addEventListener('change', actualizarColorOaktree);
            if (folioSelect) folioSelect.addEventListener('change', actualizarColorFolio);
            if (numCopiasInput) numCopiasInput.addEventListener('input', actualizarColoresCopias);

            // Add input/change listeners for immediate error clearing
            if (cantidadInput) cantidadInput.addEventListener('input', () => clearFieldError(cantidadInput));
            if (tamanoSelect) tamanoSelect.addEventListener('change', () => clearFieldError(tamanoSelect));
            if (impresionSelect) impresionSelect.addEventListener('change', () => clearFieldError(impresionSelect));
            if (disenoSelect) disenoSelect.addEventListener('change', () => clearFieldError(disenoSelect));

            // Listeners para alternar entre modo predeterminado y personalizado
            const tamanoPredetRadio = document.getElementById('tamanoPredet');
            const tamanoPersonalRadio = document.getElementById('tamanoPersonal');
            if (tamanoPredetRadio && tamanoPersonalRadio) {
                tamanoPredetRadio.addEventListener('change', actualizarModoTamano);
                tamanoPersonalRadio.addEventListener('change', actualizarModoTamano);
            }

            // Listeners para limpiar errores en campos personalizados
            const anchoCustom = document.getElementById('anchoCustom');
            const largoCustom = document.getElementById('largoCustom');
            if (anchoCustom) anchoCustom.addEventListener('input', () => clearFieldError(anchoCustom));
            if (largoCustom) largoCustom.addEventListener('input', () => clearFieldError(largoCustom));

            // Listener para el tipo de producto
            const tipoProductoSelect = document.getElementById('tipoProducto');
            if (tipoProductoSelect) {
                tipoProductoSelect.addEventListener('change', () => {
                    clearFieldError(tipoProductoSelect);
                    // Actualizar el título dinámicamente
                    const tituloPage = document.getElementById('tituloPage');
                    if (tituloPage && tipoProductoSelect.value) {
                        const textoTipo = tipoProductoSelect.options[tipoProductoSelect.selectedIndex].text;
                        tituloPage.textContent = `Cotizador de ${textoTipo}`;
                    }
                });
            }

            // Special handling for radios for immediate error clearing
            document.querySelectorAll('input[name="tipoPapel"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    clearFieldError(document.getElementById('tipoPapelRadios'));
                    document.getElementById('tipoPapelError').classList.add('hidden');
                });
            });


            if (limpiarCamposBtn) {
                limpiarCamposBtn.addEventListener('click', limpiarCampos);
                // console.log('Botón limpiar asignado.');
            }

            // Funciones para generar y mostrar los costos base con inputs de modificación
            function generateCostInputHtml(label, baseCost, path) {
                const overrideKey = `manual_${path.replace(/\./g, '_').replace(/\[/g, '__').replace(/\]/g, '')}`;
                const currentValue = individualCostOverrides[overrideKey] !== undefined && individualCostOverrides[overrideKey] !== null
                    ? individualCostOverrides[overrideKey]
                    : baseCost;
                return `<p>${label}: <span>${formatCurrency(baseCost)}</span> <input type="number" id="${overrideKey}" value="${currentValue}" placeholder="Nuevo" step="0.01" class="cost-input"></p>`;
            }

            function renderPapelCosts() {
                const papelDetails = document.getElementById('papelCostDetails');
                papelDetails.innerHTML = `
                    <h5 class="font-bold text-gray-700 mt-2">Papel Autocopia (Costo por Hoja)</h5>
                    ${generateCostInputHtml('Original (Carta)', APP_COST_CONFIG.papel.carta.autocopia_original, 'papel.carta.autocopia_original')}
                    ${generateCostInputHtml('Final (Carta)', APP_COST_CONFIG.papel.carta.autocopia_final, 'papel.carta.autocopia_final')}
                    ${generateCostInputHtml('Intermedio (Carta)', APP_COST_CONFIG.papel.carta.autocopia_intermedio, 'papel.carta.autocopia_intermedio')}
                    ${generateCostInputHtml('Original (Oficio)', APP_COST_CONFIG.papel.oficio.autocopia_original, 'papel.oficio.autocopia_original')}
                    ${generateCostInputHtml('Final (Oficio)', APP_COST_CONFIG.papel.oficio.autocopia_final, 'papel.oficio.autocopia_final')}
                    ${generateCostInputHtml('Intermedio (Oficio)', APP_COST_CONFIG.papel.oficio.autocopia_intermedio, 'papel.oficio.autocopia_intermedio')}

                    <h5 class="font-bold text-gray-700 mt-4">Papel Simple (Costo por Hoja)</h5>
                    ${generateCostInputHtml('Bond 75gr (Carta)', APP_COST_CONFIG.papel.carta.bond75, 'papel.carta.bond75')}
                    ${generateCostInputHtml('Bond 90gr (Carta)', APP_COST_CONFIG.papel.carta.bond90, 'papel.carta.bond90')}
                    ${generateCostInputHtml('Bristol 180gr (Carta)', APP_COST_CONFIG.papel.carta.bristol180, 'papel.carta.bristol180')}
                    ${generateCostInputHtml('Seguridad Hoops (Carta)', APP_COST_CONFIG.papel.carta.seguridadHoops, 'papel.carta.seguridadHoops')}
                    ${generateCostInputHtml('Seguridad Oaktree (Carta)', APP_COST_CONFIG.papel.carta.seguridadOaktree, 'papel.carta.seguridadOaktree')}
                    ${generateCostInputHtml('Opalina 120gr (Carta)', APP_COST_CONFIG.papel.carta.opalina, 'papel.carta.opalina')} <!-- Nuevo input para Opalina Carta -->

                    ${generateCostInputHtml('Bond 75gr (Oficio)', APP_COST_CONFIG.papel.oficio.bond75, 'papel.oficio.bond75')}
                    ${generateCostInputHtml('Bond 90gr (Oficio)', APP_COST_CONFIG.papel.oficio.bond90, 'papel.oficio.bond90')}
                    ${generateCostInputHtml('Bristol 180gr (Oficio)', APP_COST_CONFIG.papel.oficio.bristol180, 'papel.oficio.bristol180')}
                    ${generateCostInputHtml('Seguridad Hoops (Oficio)', APP_COST_CONFIG.papel.oficio.seguridadHoops, 'papel.oficio.seguridadHoops')}
                    ${generateCostInputHtml('Seguridad Oaktree (Oficio)', APP_COST_CONFIG.papel.oficio.seguridadOaktree, 'papel.oficio.seguridadOaktree')}
                    ${generateCostInputHtml('Opalina 120gr (Oficio)', APP_COST_CONFIG.papel.oficio.opalina, 'papel.oficio.opalina')} <!-- Nuevo input para Opalina Oficio -->
                `;
            }

            function renderImpresionCosts() {
                const impresionDetails = document.getElementById('impresionCostDetails');
                let htmlContent = `<h5 class="font-bold text-gray-700 mt-2">Tarifas de Impresión Digital por Cantidad (Costo por Hoja)</h5>`;

                // B/N rates
                htmlContent += `<h6 class="font-semibold text-gray-600 mt-3">Impresión en Blanco y Negro:</h6>`;
                APP_COST_CONFIG.impresionDigital.bn.forEach((rate, index) => {
                    const rangeLabel = `${rate.min}-${rate.max}`;
                    htmlContent += generateCostInputHtml(`B/N (Carta) ${rangeLabel}`, rate.carta, `impresionDigital.bn[${index}].carta`);
                    htmlContent += generateCostInputHtml(`B/N (Oficio) ${rangeLabel}`, rate.oficio, `impresionDigital.bn[${index}].oficio`);
                });

                // Color rates
                htmlContent += `<h6 class="font-semibold text-gray-600 mt-3">Impresión a Color:</h6>`;
                APP_COST_CONFIG.impresionDigital.color.forEach((rate, index) => {
                    const rangeLabel = `${rate.min}-${rate.max}`;
                    htmlContent += generateCostInputHtml(`Color (Carta) ${rangeLabel}`, rate.carta, `impresionDigital.color[${index}].carta`);
                    htmlContent += generateCostInputHtml(`Color (Oficio) ${rangeLabel}`, rate.oficio, `impresionDigital.color[${index}].oficio`);
                });
                impresionDetails.innerHTML = htmlContent;
            }

            function renderAcabadosCosts() {
                const acabadosDetails = document.getElementById('acabadosCostDetails');
                acabadosDetails.innerHTML = `
                    <h5 class="font-bold text-gray-700 mt-2">Cortes (Costo Fijo)</h5>
                    ${generateCostInputHtml('1/2 División', APP_COST_CONFIG.acabadosDigital.corte_2_div, 'acabadosDigital.corte_2_div')}
                    ${generateCostInputHtml('1/3 División', APP_COST_CONFIG.acabadosDigital.corte_3_div, 'acabadosDigital.corte_3_div')}
                    ${generateCostInputHtml('1/4 División', APP_COST_CONFIG.acabadosDigital.corte_4_div, 'acabadosDigital.corte_4_div')}

                    <h5 class="font-bold text-gray-700 mt-4">Otros Acabados</h5>
                    ${generateCostInputHtml('Pegado', APP_COST_CONFIG.acabadosDigital.pegado, 'acabadosDigital.pegado')}
                    ${generateCostInputHtml('Compaginado (Autocopia)', APP_COST_CONFIG.acabadosDigital.compaginado_autocopia, 'acabadosDigital.compaginado_autocopia')}
                    <!-- El costo de Folio se movió a Servicios -->
                `;
            }

            function renderDisenoCosts() {
                const disenoDetails = document.getElementById('disenoCostDetails');
                disenoDetails.innerHTML = `
                    <h5 class="font-bold text-gray-700 mt-2">Tipos de Diseño (Costo Fijo)</h5>
                    ${generateCostInputHtml('Cliente envía diseño', APP_COST_CONFIG.servicios.diseno_cliente, 'servicios.diseno_cliente')}
                    ${generateCostInputHtml('Diseño guardado aquí', APP_COST_CONFIG.servicios.diseno_guardado, 'servicios.diseno_guardado')}
                    ${generateCostInputHtml('Realizar diseño nuevo', APP_COST_CONFIG.servicios.diseno_nuevo, 'servicios.diseno_nuevo')}
                    <h5 class="font-bold text-gray-700 mt-4">Costo de Folio (si aplica y no hay diseño nuevo)</h5>
                    ${generateCostInputHtml('Folio (diseño cliente/guardado)', APP_COST_CONFIG.servicios.folio_por_diseno_cliente_guardado, 'servicios.folio_por_diseno_cliente_guardado')}
                `;
            }

            function renderAllCosts() {
                renderPapelCosts();
                renderImpresionCosts();
                renderAcabadosCosts();
                renderDisenoCosts();
            }

            // Función para actualizar el objeto global `individualCostOverrides` desde los inputs
            function clearIndividualCostOverrides() {
                individualCostOverrides = {};
                const inputElements = document.querySelectorAll('.cost-details-content input.cost-input');
                inputElements.forEach(input => {
                    input.value = ''; // Limpiar el valor del input
                });
                renderAllCosts(); // Re-renderizar para mostrar los costos base nuevamente
                // No se muestra showCustomAlert aquí, ya que clearIndividualCostOverrides puede ser llamado por limpiarCampos()
            }

            // Event listener para el botón "Actualizar Costos Manuales y Recalcular"
            updateCostsBtn.addEventListener('click', () => {
                updateIndividualCostOverridesFromInputs();
                renderAllCosts(); // Volver a renderizar para mostrar los valores actuales en los inputs
                // Intentar recalcular, las validaciones internas de calcularCotizacion() manejarán los errores del formulario principal
                calcularCotizacion();
                showCustomAlert('Costos manuales actualizados. Verifica la cotización principal.');
            });

            // Event listener para el botón "Borrar Ajustes Manuales"
            clearManualCostsBtn.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que quieres borrar todos los ajustes manuales de costos?')) {
                    clearIndividualCostOverrides();
                    // Intentar recalcular con costos base, las validaciones manejarán errores
                    calcularCotizacion();
                }
            });


            // Inicializar al cargar la página
            limpiarCampos(); // Esto llamará a clearIndividualCostOverrides y actualizarOpcionesPapel
            renderAllCosts(); // Asegurarse de que los inputs se generen con los valores base inicialmente

        });

        // Función global para toggle de maquila (fuera del DOMContentLoaded para acceso desde HTML)
        function toggleMaquila() {
            const checkbox = document.getElementById('maquilaCheck');
            const card = document.getElementById('maquilaCard');
            const track = document.getElementById('maquilaToggleTrack');
            const thumb = document.getElementById('maquilaToggleThumb');
            const estado = document.getElementById('maquilaEstado');

            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                // Estado ON
                card.className = card.className.replace('maquila-card-off', 'maquila-card-on');
                track.className = track.className.replace('maquila-track-off', 'maquila-track-on');
                thumb.className = thumb.className.replace('maquila-thumb-off', 'maquila-thumb-on');
                estado.className = estado.className.replace('maquila-badge-off', 'maquila-badge-on');
                estado.textContent = 'ACTIVADO ✓';
            } else {
                // Estado OFF
                card.className = card.className.replace('maquila-card-on', 'maquila-card-off');
                track.className = track.className.replace('maquila-track-on', 'maquila-track-off');
                thumb.className = thumb.className.replace('maquila-thumb-on', 'maquila-thumb-off');
                estado.className = estado.className.replace('maquila-badge-on', 'maquila-badge-off');
                estado.textContent = 'DESACTIVADO';
            }
        }
    </script>

    <!-- Botón Flotante de Regreso al Menú -->
    <a href="index.html" class="btn-home-flotante" title="Volver al Menú Principal">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span>Volver al Menú</span>
    </a>

    <style>
        .btn-home-flotante {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 9999;
            font-family: 'Poppins', 'Inter', sans-serif;
        }

        .btn-home-flotante:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .btn-home-flotante:active {
            transform: translateY(-1px) scale(1.02);
        }

        .btn-home-flotante svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .btn-home-flotante span {
            white-space: nowrap;
        }

        /* Responsive: en móviles solo mostrar el icono */
        @media (max-width: 768px) {
            .btn-home-flotante {
                padding: 15px;
                border-radius: 50%;
                bottom: 20px;
                right: 20px;
            }

            .btn-home-flotante span {
                display: none;
            }

            .btn-home-flotante svg {
                width: 24px;
                height: 24px;
            }
        }
    </style>
</body>

</html>