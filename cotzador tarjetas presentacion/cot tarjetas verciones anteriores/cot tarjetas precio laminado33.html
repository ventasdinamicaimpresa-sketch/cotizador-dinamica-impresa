<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de Tarjetas de Presentación V3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/inter-font@3.19.1/index.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#1A73E8',
                        'secondary': '#E8F0FE',
                        'dark-bg': '#121212',
                        'dark-card': '#1E1E1E',
                        'dark-text': '#E0E0E0',
                        'dark-input': '#333333',
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .dark {
            background-color: #121212;
            color: #E0E0E0;
        }

        .dark .card {
            background-color: #1E1E1E;
            color: #E0E0E0;
        }

        .dark .form-input, .dark .form-select {
            background-color: #333333;
            color: #E0E0E0;
            border-color: #555555;
        }
        
        .dark .tab-button, .dark .selection-button {
            color: #E0E0E0;
            background-color: #333333;
        }

        .dark .selection-button.active, .dark .tab-button.active {
            background-color: #1A73E8;
            color: white;
            border-color: #1A73E8;
        }
        
        .dark .summary-box {
            background-color: #1E1E1E;
            border-color: #555555;
        }

        .selection-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid transparent;
        }
        
        .selection-button:hover:not(.active) {
            background-color: #e5e7eb;
            border-color: #d1d5db;
        }
        .dark .selection-button:hover:not(.active) {
            background-color: #2a2a2a;
            border-color: #4a4a4a;
        }

        .selection-button.active {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #1A73E8;
        }

        .sub-options-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }
        .sub-options-container.active {
            max-height: 200px; /* Ajustar según la altura del contenido */
            transition: max-height 0.3s ease-in, opacity 0.3s ease-in;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg p-4 flex items-center justify-center min-h-screen">

    <!-- Contenedor principal de la aplicación -->
    <div class="w-full max-w-7xl lg:flex lg:space-x-8">

        <!-- Formulario de cotización (izquierda) -->
        <div class="w-full lg:w-2/3 p-6 bg-white dark:bg-dark-card rounded-xl shadow-2xl space-y-8 md:p-10 mb-8 lg:mb-0">
            <!-- Encabezado y botón para alternar modo oscuro -->
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-dark-text">Cotizador de Tarjetas</h1>
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-dark-input text-gray-800 dark:text-gray-200 transition-colors duration-300">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>
            </div>

            <form id="quote-form" class="space-y-6">
                <!-- Cantidad -->
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cantidad</label>
                    <input type="number" id="quantity" name="quantity" class="form-input w-full p-3 rounded-lg border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary dark:bg-dark-input dark:text-dark-text transition-colors duration-300" min="1" placeholder="Ej. 1000">
                </div>

                <!-- Tipo de Papel (Menú desplegable) -->
                <div>
                    <label for="paper-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Papel</label>
                    <select id="paper-select" name="paper-select" class="form-select w-full p-3 rounded-lg border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary dark:bg-dark-input dark:text-dark-text transition-colors duration-300">
                        <option value="" disabled selected>Selecciona un tipo de papel</option>
                        <option value="opaline-white-225">Cartulina Opalina Blanca 225g</option>
                        <option value="opaline-ivory-225">Cartulina Opalina Marfil 225g</option>
                        <option value="couche-300">Couche 300g</option>
                        <option value="couche-250">Couche 250g</option>
                        <option value="sulfated-12pt">Cartulina Sulfatada 12pt</option>
                        <option value="kromakote">Cartulina Kromakote</option>
                        <option value="stardream">Cartulina Stardream</option>
                    </select>
                </div>

                <!-- Lados de Impresión -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lados de Impresión</label>
                    <div class="flex gap-4">
                        <button type="button" class="selection-button py-3 px-4 rounded-lg bg-gray-50 dark:bg-dark-input text-sm font-medium text-gray-700 dark:text-gray-300 active" data-type="printing-sides" data-value="1">1 Lado</button>
                        <button type="button" class="selection-button py-3 px-4 rounded-lg bg-gray-50 dark:bg-dark-input text-sm font-medium text-gray-700 dark:text-gray-300" data-type="printing-sides" data-value="2">2 Lados</button>
                    </div>
                </div>
                
                <!-- Opciones de impresión (Frente y Reverso) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Frente -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Impresión (Frente)</label>
                        <div class="flex gap-4">
                            <button type="button" class="selection-button py-3 px-4 rounded-lg bg-gray-50 dark:bg-dark-input text-sm font-medium text-gray-700 dark:text-gray-300 active" data-type="printing-front" data-value="color">Color</button>
                            <button type="button" class="selection-button py-3 px-4 rounded-lg bg-gray-50 dark:bg-dark-input text-sm font-medium text-gray-700 dark:text-gray-300" data-type="printing-front" data-value="bw">Blanco y Negro</button>
                        </div>
                    </div>
                    <!-- Reverso (se muestra solo si se elige 2 lados) -->
                    <div id="back-printing-options" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Impresión (Reverso)</label>
                        <div class="flex gap-4">
                            <button type="button" class="selection-button py-3 px-4 rounded-lg bg-gray-50 dark:bg-dark-input text-sm font-medium text-gray-700 dark:text-gray-300" data-type="printing-back" data-value="color">Color</button>
                            <button type="button" class="selection-button py-3 px-4 rounded-lg bg-gray-50 dark:bg-dark-input text-sm font-medium text-gray-700 dark:text-gray-300" data-type="printing-back" data-value="bw">Blanco y Negro</button>
                        </div>
                    </div>
                </div>

                <!-- Acabados -->
                <div class="space-y-6">
                    <label class="block text-lg font-bold text-gray-900 dark:text-dark-text mb-2">Acabados</label>
                    
                    <!-- Opción Sin Acabados -->
                    <div class="p-4 rounded-lg bg-gray-100 dark:bg-dark-input">
                        <button type="button" class="selection-button w-full py-3 px-4 rounded-lg bg-gray-50 dark:bg-dark-input text-sm font-medium text-gray-700 dark:text-gray-300 active" data-type="no-finish" data-value="no-finish">Sin Acabados</button>
                    </div>

                    <!-- Sección de Laminado -->
                    <div id="laminate-options" class="p-4 rounded-lg bg-gray-100 dark:bg-dark-input space-y-4">
                        <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300">Laminado</h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Lados</label>
                            <div class="flex gap-4">
                                <button type="button" class="selection-button py-2 px-3 rounded-lg bg-gray-50 dark:bg-dark-input text-xs font-medium text-gray-700 dark:text-gray-300" data-type="laminate-sides" data-value="1-side">1 Lado</button>
                                <button type="button" class="selection-button py-2 px-3 rounded-lg bg-gray-50 dark:bg-dark-input text-xs font-medium text-gray-700 dark:text-gray-300" data-type="laminate-sides" data-value="2-sides">2 Lados</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Tipo de Acabado</label>
                            <div class="flex gap-4">
                                <button type="button" class="selection-button py-2 px-3 rounded-lg bg-gray-50 dark:bg-dark-input text-xs font-medium text-gray-700 dark:text-gray-300" data-type="laminate-type" data-value="matte">Mate</button>
                                <button type="button" class="selection-button py-2 px-3 rounded-lg bg-gray-50 dark:bg-dark-input text-xs font-medium text-gray-700 dark:text-gray-300" data-type="laminate-type" data-value="glossy">Brillante</button>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de Redondeo de esquinas -->
                    <div id="rounded-options" class="p-4 rounded-lg bg-gray-100 dark:bg-dark-input space-y-4">
                        <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300">Redondeo de esquinas</h4>
                        <div class="flex gap-4">
                            <button type="button" class="selection-button py-2 px-3 rounded-lg bg-gray-50 dark:bg-dark-input text-xs font-medium text-gray-700 dark:text-gray-300" data-type="rounded-corners" data-value="rounded-1">1 Esquina</button>
                            <button type="button" class="selection-button py-2 px-3 rounded-lg bg-gray-50 dark:bg-dark-input text-xs font-medium text-gray-700 dark:text-gray-300" data-type="rounded-corners" data-value="rounded-2">2 Esquinas</button>
                            <button type="button" class="selection-button py-2 px-3 rounded-lg bg-gray-50 dark:bg-dark-input text-xs font-medium text-gray-700 dark:text-gray-300" data-type="rounded-corners" data-value="rounded-4">4 Esquinas</button>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
                    <button type="button" id="reset-btn" class="w-full sm:w-auto px-6 py-3 rounded-lg font-bold bg-gray-200 dark:bg-dark-input hover:bg-gray-300 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 transition-colors duration-300">
                        <i class="fas fa-sync-alt mr-2"></i> Limpiar Campos
                    </button>
                </div>
            </form>
        </div>

        <!-- Resumen de cotización (derecha) -->
        <div class="w-full lg:w-1/3 p-6 bg-secondary dark:bg-dark-card rounded-xl shadow-lg summary-box">
            <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Resumen de Cotización</h2>
            <div id="summary-content" class="text-gray-700 dark:text-gray-300 space-y-4">
                <p><strong>Cantidad:</strong> <span id="summary-quantity">--</span></p>
                <p><strong>Papel:</strong> <span id="summary-paper">--</span></p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Costo de papel: <span id="sheets-needed">0</span> pliegos x $<span id="cost-per-single-paper-sheet">0.00</span> = $<span id="total-paper-cost">0.00</span></p>
                <p><strong>Impresión:</strong> <span id="summary-printing">--</span></p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Costo de impresión: <span id="sheets-needed-for-printing-display">0</span> pliegos x $<span id="cost-per-printing-sheet">0.00</span> = $<span id="total-printing-cost-batch">0.00</span></p>
                <p><strong>Acabados:</strong> <span id="summary-finishes">--</span></p>
                <p id="laminate-detail" class="text-sm text-gray-500 dark:text-gray-400 hidden"></p>
                <p id="rounded-detail" class="text-sm text-gray-500 dark:text-gray-400 hidden"></p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Corte de tarjetas: $<span id="cutting-cost-display">220.00</span></p>
            </div>
            
            <div class="mt-8 pt-4 border-t border-gray-300 dark:border-gray-600">
                <p class="text-lg font-semibold text-gray-900 dark:text-dark-text">Costo Total:</p>
                <p id="total-cost" class="text-4xl font-extrabold text-primary dark:text-white">$0.00</p>
                <p id="error-message" class="text-red-500 text-sm mt-2 hidden">Por favor, completa todos los campos para calcular el costo.</p>
            </div>
        </div>
    </div>

    <!-- Script de la aplicación -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Mapeo de precios
            const prices = {
                paper: {
                    // Costos de papel actualizados según la imagen proporcionada (Costo Tamaño Doble Carta)
                    'opaline-white-225': 1.84,
                    'opaline-ivory-225': 1.55,
                    'couche-300': 1.35,
                    'couche-250': 1.13,
                    'sulfated-12pt': 2.34,
                    'kromakote': 3.695,
                    'stardream': 13.85,
                },
                printing: {
                    color: [
                        { range: [1, 50], '1-side': 12.08, '2-sides': 24.16 },
                        { range: [51, 100], '1-side': 12, '2-sides': 24 },
                        { range: [101, 150], '1-side': 11.8, '2-sides': 23.6 },
                        { range: [151, 200], '1-side': 11.6, '2-sides': 23.2 },
                        { range: [201, 500], '1-side': 11.3, '2-sides': 22.6 },
                        { range: [501, 1000], '1-side': 10.5, '2-sides': 21 }
                    ],
                    bw: [
                        { range: [1, 50], '1-side': 2.4, '2-sides': 4.8 },
                        { range: [51, 100], '1-side': 2.2, '2-sides': 4.4 },
                        { range: [101, 150], '1-side': 2, '2-sides': 4 },
                        { range: [151, 200], '1-side': 1.7, '2-sides': 3.4 },
                        { range: [201, 500], '1-side': 1.6, '2-sides': 3.2 },
                        { range: [501, 1000], '1-side': 1.56, '2-sides': 3.12 }
                    ]
                },
                finishes: {
                    'no-finish': 0,
                    laminate: { // Nuevos costos de laminado por pliego
                        matte: [
                            { range: [1, 50], '1-side': 5.852, '2-sides': 11.704 },
                            { range: [51, 100], '1-side': 5.0875, '2-sides': 10.175 },
                            { range: [101, 150], '1-side': 3.63, '2-sides': 6.534 },
                            { range: [151, 200], '1-side': 3.234, '2-sides': 5.4978 },
                            { range: [201, 500], '1-side': 2.42, '2-sides': 3.63 },
                            { range: [501, 1000], '1-side': 2.42, '2-sides': 3.63 } 
                        ],
                        glossy: [
                            { range: [1, 50], '1-side': 5.32, '2-sides': 10.64 },
                            { range: [51, 100], '1-side': 4.625, '2-sides': 9.25 },
                            { range: [101, 150], '1-side': 3.3, '2-sides': 5.94 },
                            { range: [151, 200], '1-side': 2.94, '2-sides': 4.998 },
                            { range: [201, 500], '1-side': 2.2, '2-sides': 3.3 },
                            { range: [501, 1000], '1-side': 2.2, '2-sides': 3.3 } 
                        ]
                    },
                    'rounded-1': 0.05,
                    'rounded-2': 0.10,
                    'rounded-4': 0.15,
                }
            };
            
            // Estado global de la aplicación para gestionar las selecciones
            let appState = {
                quantity: 0,
                paper: null,
                printingSides: '1',
                printingFront: 'color',
                printingBack: null,
                // Acabados ahora tienen un estado independiente
                noFinish: true,
                laminateSides: null,
                laminateType: null,
                roundedCorners: null,
                // Nuevos estados para el desglose de costos
                sheetsNeeded: 0, // Nuevo estado para pliegos necesarios
                paperCostTotal: 0, // Nuevo estado para costo total de papel
                paperCostPerSheetValue: 0, // Nuevo: Costo de un solo pliego de papel seleccionado
                printingCostPerSheet: 0, // Nuevo estado para costo de impresión por pliego
                totalPrintingCostForBatch: 0, // Nuevo: Costo total de impresión para el lote de pliegos
                totalLaminateCost: 0, // Nuevo: Costo total de laminado (después de aplicar mínimo)
                laminatePricePerSheetValue: 0, // Nuevo: Costo por pliego de laminado (antes de multiplicar y aplicar mínimo)
                cuttingCost: 220 // Costo fijo de corte
            };

            // Elementos del DOM
            const quantityInput = document.getElementById('quantity');
            const paperSelect = document.getElementById('paper-select');
            const noFinishButton = document.querySelector('[data-type="no-finish"]');
            const selectionButtons = document.querySelectorAll('.selection-button:not([data-type="no-finish"])');
            const backPrintingOptions = document.getElementById('back-printing-options');
            const totalCostEl = document.getElementById('total-cost');
            const errorMessageEl = document.getElementById('error-message');
            const resetButton = document.getElementById('reset-btn');
            const themeToggleBtn = document.getElementById('theme-toggle');

            // Nuevos elementos para el desglose del cálculo en el resumen
            const sheetsNeededEl = document.getElementById('sheets-needed');
            const totalPaperCostEl = document.getElementById('total-paper-cost');
            const costPerSinglePaperSheetEl = document.getElementById('cost-per-single-paper-sheet'); 
            const sheetsNeededForPrintingDisplayEl = document.getElementById('sheets-needed-for-printing-display'); 
            const costPerPrintingSheetEl = document.getElementById('cost-per-printing-sheet');
            const totalPrintingCostBatchEl = document.getElementById('total-printing-cost-batch'); 
            const laminateDetailEl = document.getElementById('laminate-detail'); // Nuevo elemento para detalle de laminado
            const roundedDetailEl = document.getElementById('rounded-detail'); // Nuevo elemento para detalle de redondeo
            const cuttingCostDisplayEl = document.getElementById('cutting-cost-display'); 


            // --- Funciones de control de UI y lógica de cálculo ---

            // Función para actualizar el resumen de selecciones en la UI
            const updateSummary = () => {
                document.getElementById('summary-quantity').textContent = appState.quantity || '--';
                
                // Actualizar resumen de papel usando el texto del menú desplegable
                const selectedPaperOption = paperSelect.options[paperSelect.selectedIndex];
                document.getElementById('summary-paper').textContent = selectedPaperOption.value ? selectedPaperOption.text : '--';
                
                // Actualizar resumen de impresión
                let printingText = 'No seleccionado';
                if (appState.printingFront) {
                    const frontLabel = document.querySelector(`[data-type="printing-front"][data-value="${appState.printingFront}"]`).textContent.trim();
                    printingText = `Frente: ${frontLabel}`;
                    if (appState.printingSides === '2' && appState.printingBack) {
                        const backLabel = document.querySelector(`[data-type="printing-back"][data-value="${appState.printingBack}"]`).textContent.trim();
                        printingText += `, Reverso: ${backLabel}`;
                    }
                }
                document.getElementById('summary-printing').textContent = printingText;
                
                // Actualizar resumen de acabados
                let finishesList = [];

                if (appState.noFinish) {
                    finishesList.push('Sin acabados');
                    laminateDetailEl.classList.add('hidden');
                    roundedDetailEl.classList.add('hidden');
                } else {
                    if (appState.laminateSides && appState.laminateType) {
                        const sidesLabel = document.querySelector(`[data-type="laminate-sides"][data-value="${appState.laminateSides}"]`).textContent.trim();
                        const typeLabel = document.querySelector(`[data-type="laminate-type"][data-value="${appState.laminateType}"]`).textContent.trim();
                        finishesList.push(`Laminado: ${sidesLabel}, ${typeLabel}`);
                        laminateDetailEl.textContent = `Laminado: ${appState.sheetsNeeded} pliegos x $${appState.laminatePricePerSheetValue.toFixed(2)} = $${appState.totalLaminateCost.toFixed(2)}`;
                        laminateDetailEl.classList.remove('hidden');
                    } else {
                        laminateDetailEl.classList.add('hidden');
                    }
                    if (appState.roundedCorners) {
                        const roundedLabel = document.querySelector(`[data-type="rounded-corners"][data-value="${appState.roundedCorners}"]`).textContent.trim();
                        finishesList.push(`Redondeo: ${roundedLabel}`);
                        // Calcular el costo total de redondeo para mostrarlo
                        const totalRoundedCost = prices.finishes[appState.roundedCorners] * appState.quantity;
                        roundedDetailEl.textContent = `Redondeo: $${totalRoundedCost.toFixed(2)} (Costo por unidad: $${prices.finishes[appState.roundedCorners].toFixed(4)})`;
                        roundedDetailEl.classList.remove('hidden');
                    } else {
                        roundedDetailEl.classList.add('hidden');
                    }
                }

                finishesText = finishesList.length > 0 ? finishesList.join(', ') : '--';
                document.getElementById('summary-finishes').textContent = finishesText;

                // Actualizar el desglose de costos
                sheetsNeededEl.textContent = appState.sheetsNeeded;
                costPerSinglePaperSheetEl.textContent = appState.paperCostPerSheetValue.toFixed(2);
                totalPaperCostEl.textContent = appState.paperCostTotal.toFixed(2);
                
                sheetsNeededForPrintingDisplayEl.textContent = appState.sheetsNeeded; 
                costPerPrintingSheetEl.textContent = appState.printingCostPerSheet.toFixed(2);
                totalPrintingCostBatchEl.textContent = appState.totalPrintingCostForBatch.toFixed(2);
                
                cuttingCostDisplayEl.textContent = appState.cuttingCost.toFixed(2); 
            };

            // Función para obtener el costo de impresión por la cantidad de pliegos
            const getPrintingCostForSheets = (colorType, sheetsQuantity, sidesConfig) => {
                const priceList = prices.printing[colorType];
                // Encuentra el rango de precios que coincide con la cantidad de pliegos
                const priceEntry = priceList.find(p => sheetsQuantity >= p.range[0] && sheetsQuantity <= p.range[1]);
                return priceEntry ? priceEntry[sidesConfig] : 0;
            };

            // Función para obtener el costo de laminado por la cantidad de pliegos
            const getLaminateCostForSheets = (laminateType, sheetsQuantity, sidesConfig) => {
                const priceList = prices.finishes.laminate[laminateType];
                const priceEntry = priceList.find(p => sheetsQuantity >= p.range[0] && sheetsQuantity <= p.range[1]);
                return priceEntry ? priceEntry[sidesConfig] : 0;
            };

            // Función principal para calcular el costo total
            const calculateTotal = () => {
                const { quantity, paper, printingSides, printingFront, printingBack, noFinish, laminateSides, laminateType, roundedCorners } = appState;

                // Validación para mostrar u ocultar el error
                if (quantity <= 0 || !paper || !printingFront || (printingSides === '2' && !printingBack)) {
                    totalCostEl.textContent = '$0.00';
                    errorMessageEl.classList.remove('hidden');
                    // Resetear los costos en el estado si la validación falla
                    appState.sheetsNeeded = 0;
                    appState.paperCostTotal = 0;
                    appState.paperCostPerSheetValue = 0;
                    appState.printingCostPerSheet = 0;
                    appState.totalPrintingCostForBatch = 0;
                    appState.totalLaminateCost = 0; 
                    appState.laminatePricePerSheetValue = 0; // Resetear este valor también
                    updateSummary(); // Actualizar el resumen con los valores reseteados
                    return;
                }
                errorMessageEl.classList.add('hidden');

                // --- 1. Calcular Costo de Papel ---
                // Cada pliego de doble carta rinde 20 tarjetas.
                // Siempre se cobra por pliegos completos.
                const cardsPerSheet = 20; 
                const sheetsNeeded = Math.ceil(quantity / cardsPerSheet);
                const paperCostPerSheetValue = prices.paper[paper]; // Costo de un solo pliego de papel
                const paperCostTotal = paperCostPerSheetValue * sheetsNeeded; // Costo total del papel para el lote

                // --- 2. Calcular Costo de Impresión ---
                let printingCostPerSheet = 0; // Costo de impresión por pliego
                if (printingSides === '1') {
                    // El costo de impresión por pliego se basa en la cantidad de pliegos (sheetsNeeded)
                    printingCostPerSheet = getPrintingCostForSheets(printingFront, sheetsNeeded, '1-side');
                } else if (printingSides === '2') {
                    if (printingFront === printingBack) { // Ambos lados del mismo tipo de color
                        // El costo de impresión por pliego se basa en la cantidad de pliegos (sheetsNeeded)
                        printingCostPerSheet = getPrintingCostForSheets(printingFront, sheetsNeeded, '2-sides');
                    } else { // Tipos de color mixtos (ej. frente color, reverso b/n)
                        // Sumamos el costo de 1 lado de cada tipo, basado en la cantidad de pliegos
                        const frontSideCostPerSheet = getPrintingCostForSheets(printingFront, sheetsNeeded, '1-side');
                        const backSideCostPerSheet = getPrintingCostForSheets(printingBack, sheetsNeeded, '1-side');
                        printingCostPerSheet = frontSideCostPerSheet + backSideCostPerSheet;
                    }
                }
                const totalPrintingCostForBatch = printingCostPerSheet * sheetsNeeded; // Costo total de impresión para el lote

                // --- 3. Calcular Costo de Acabados ---
                let totalFinishesCostForBatch = 0;
                let currentLaminateCost = 0;
                let laminatePricePerSheetFromTable = 0; // Para almacenar el costo del pliego de laminado antes de multiplicar

                if (!noFinish) {
                    if (laminateSides && laminateType) {
                        laminatePricePerSheetFromTable = getLaminateCostForSheets(laminateType, sheetsNeeded, laminateSides === '1-side' ? '1-side' : '2-sides');
                        currentLaminateCost = laminatePricePerSheetFromTable * sheetsNeeded;
                        // Aplicar costo mínimo de laminado
                        if (currentLaminateCost < 250 && currentLaminateCost > 0) {
                            currentLaminateCost = 250;
                        }
                        totalFinishesCostForBatch += currentLaminateCost;
                    }
                    if (roundedCorners) {
                        totalFinishesCostForBatch += prices.finishes[roundedCorners] * quantity; 
                    }
                }

                // --- 4. Agregar Costo de Corte ---
                const cuttingCost = appState.cuttingCost; 

                // --- 5. Calcular Total General ---
                const total = paperCostTotal + totalPrintingCostForBatch + totalFinishesCostForBatch + cuttingCost;

                totalCostEl.textContent = `$${total.toFixed(2)}`;

                // Almacenar costos en appState para mostrarlos en el resumen
                appState.sheetsNeeded = sheetsNeeded;
                appState.paperCostTotal = paperCostTotal;
                appState.paperCostPerSheetValue = paperCostPerSheetValue; 
                appState.printingCostPerSheet = printingCostPerSheet;
                appState.totalPrintingCostForBatch = totalPrintingCostForBatch; 
                appState.totalLaminateCost = currentLaminateCost; 
                appState.laminatePricePerSheetValue = laminatePricePerSheetFromTable; // Almacena el costo por pliego del laminado de la tabla
                // appState.cuttingCost ya está en 220, no necesita ser actualizado aquí a menos que sea dinámico

                updateSummary(); // Actualizar el resumen con los nuevos costos y el total
            };
            
            // Función para alternar la visibilidad de las opciones de impresión del reverso
            const toggleBackPrintingOptions = () => {
                if (appState.printingSides === '2') {
                    backPrintingOptions.classList.remove('hidden');
                    // Seleccionar una opción por defecto si no hay ninguna
                    if (!appState.printingBack) {
                        const defaultBackBtn = document.querySelector(`[data-type="printing-back"][data-value="color"]`);
                        defaultBackBtn.classList.add('active');
                        appState.printingBack = defaultBackBtn.dataset.value;
                    }
                } else {
                    backPrintingOptions.classList.add('hidden');
                    appState.printingBack = null;
                }
            };

            // Función para deseleccionar todos los acabados
            const deselectAllFinishes = () => {
                document.querySelectorAll('[data-type="laminate-sides"], [data-type="laminate-type"], [data-type="rounded-corners"]').forEach(btn => btn.classList.remove('active'));
                appState.laminateSides = null;
                appState.laminateType = null;
                appState.roundedCorners = null;
                appState.noFinish = true;
                noFinishButton.classList.add('active');
            };

            // Función principal que se llama en cada cambio para actualizar todo
            const updateUIAndCalculate = () => {
                updateSummary();
                calculateTotal();
            };

            // --- Manejadores de eventos ---
            
            // Manejador para el menú desplegable de papel
            paperSelect.addEventListener('change', () => {
                appState.paper = paperSelect.value;
                updateUIAndCalculate();
            });

            // Manejador para los botones de selección general (impresión, etc.) y los acabados
            selectionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const type = button.dataset.type;
                    const value = button.dataset.value;
                    
                    // Lógica para deseleccionar "Sin Acabados" si se elige un acabado
                    if (type !== 'no-finish') {
                        appState.noFinish = false;
                        noFinishButton.classList.remove('active');
                    }

                    // Manejo de selecciones de acabados (múltiples selecciones permitidas)
                    if (type === 'laminate-sides' || type === 'laminate-type' || type === 'rounded-corners') {
                        
                        // Si el botón ya está activo, lo desactiva.
                        // De lo contrario, lo activa y desactiva otros de su mismo grupo
                        const isActive = button.classList.contains('active');

                        // Lógica para grupos de selección única (Laminado)
                        if (type === 'laminate-sides' || type === 'laminate-type') {
                            document.querySelectorAll(`[data-type="${type}"]`).forEach(btn => btn.classList.remove('active'));
                            if (!isActive) {
                                button.classList.add('active');
                                if (type === 'laminate-sides') appState.laminateSides = value;
                                if (type === 'laminate-type') appState.laminateType = value;
                            } else {
                                // Si se desactiva, el estado se vuelve nulo
                                if (type === 'laminate-sides') appState.laminateSides = null;
                                if (type === 'laminate-type') appState.laminateType = null;
                            }
                        } 
                        // Lógica para grupos de selección múltiple (Redondeo)
                        else if (type === 'rounded-corners') {
                            // Se puede seleccionar solo uno a la vez en este caso (como en la versión anterior)
                            document.querySelectorAll(`[data-type="${type}"]`).forEach(btn => btn.classList.remove('active'));
                             if (!isActive) {
                                button.classList.add('active');
                                appState.roundedCorners = value;
                            } else {
                                appState.roundedCorners = null;
                            }
                        }
                    }
                    // Manejo de selecciones de impresión (selección única)
                    else {
                        document.querySelectorAll(`[data-type="${type}"]`).forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        
                        if (type === 'printing-sides') {
                            appState.printingSides = value;
                            toggleBackPrintingOptions();
                        } else if (type === 'printing-front') {
                            appState.printingFront = value;
                        } else if (type === 'printing-back') {
                            appState.printingBack = value;
                        }
                    }

                    // Si no hay acabados seleccionados, activar "Sin Acabados"
                    if (!appState.laminateSides && !appState.laminateType && !appState.roundedCorners) {
                        appState.noFinish = true;
                        noFinishButton.classList.add('active');
                    }

                    updateUIAndCalculate();
                });
            });

            // Manejador para el botón de "Sin Acabados"
            noFinishButton.addEventListener('click', () => {
                deselectAllFinishes();
                updateUIAndCalculate();
            });

            // Manejador para la cantidad (se activa al escribir o cambiar el valor)
            quantityInput.addEventListener('input', () => {
                appState.quantity = parseInt(quantityInput.value) || 0;
                updateUIAndCalculate();
            });

            // Manejador para el botón de limpiar
            resetButton.addEventListener('click', () => {
                quantityInput.value = '';
                paperSelect.value = ''; // Resetear el dropdown
                
                document.querySelectorAll('.selection-button').forEach(btn => btn.classList.remove('active'));
                
                // Reiniciar el estado a los valores por defecto
                appState = {
                    quantity: 0,
                    paper: null,
                    printingSides: '1',
                    printingFront: 'color',
                    printingBack: null,
                    noFinish: true,
                    laminateSides: null,
                    laminateType: null,
                    roundedCorners: null,
                    sheetsNeeded: 0,
                    paperCostTotal: 0,
                    paperCostPerSheetValue: 0,
                    printingCostPerSheet: 0,
                    totalPrintingCostForBatch: 0,
                    totalLaminateCost: 0,
                    laminatePricePerSheetValue: 0,
                    cuttingCost: 220 
                };
                
                // Activar los botones por defecto en la UI
                document.querySelector('[data-type="printing-sides"][data-value="1"]').classList.add('active');
                document.querySelector('[data-type="printing-front"][data-value="color"]').classList.add('active');
                noFinishButton.classList.add('active');

                // Ocultar las opciones condicionales
                backPrintingOptions.classList.add('hidden');

                // Actualizar la UI
                updateUIAndCalculate();
            });

            // Manejador de eventos para el botón de alternar tema
            themeToggleBtn.addEventListener('click', () => {
                document.body.classList.toggle('dark');
            });
            
            // Inicialización de la aplicación
            // Seleccionar los botones por defecto al cargar
            document.querySelector('[data-type="printing-sides"][data-value="1"]').classList.add('active');
            document.querySelector('[data-type="printing-front"][data-value="color"]').classList.add('active');
            noFinishButton.classList.add('active');
            updateUIAndCalculate();
        });
    </script>
</body>
</html>
