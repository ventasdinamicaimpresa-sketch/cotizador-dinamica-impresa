<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de Sellos v3.0</title>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        }
                    }
                }
            }
        }
    </script>
    <link href="assets/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            /* Gray 900 */
            color: #f3f4f6;
            /* Gray 100 */
        }
    </style>
    <script src="assets/js/react.production.min.js"></script>
    <script src="assets/js/react-dom.production.min.js"></script>
    <script src="assets/js/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- DATOS Y CONSTANTES (RESTAURADOS) ---
        const initialSelloData = {
            colop: {
                placa: [
                    { modelo: 'SELLO COLOP PRINTER 20', medida: '1.4x3.8', precio: 65.03, cojin: 35, cambioTinta: 25, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER 30N', medida: '1.8x4.7', precio: 79.5, cojin: 43, cambioTinta: 25, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER 35', medida: '3x5', precio: 229.0, cojin: 62, cambioTinta: 30, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER 40N', medida: '2.3x5.9', precio: 94.37, cojin: 47, cambioTinta: 35, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER 50', medida: '3x6.9', precio: 182.0, cojin: 62, cambioTinta: 35, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER 53 PLACA', medida: '3x4.5', precio: 163.08, cojin: 62, cambioTinta: 35, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER 54 PLACA', medida: '4x5', precio: 186.17, cojin: 62, cambioTinta: 40, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER 55 PLACA', medida: '4x6', precio: 186.6, cojin: 62, cambioTinta: 40, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER C60', medida: '3.7x7.6', precio: 168.75, cojin: null, cambioTinta: 40, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER Q43 PLACA', medida: '4.3x4.3', precio: 172.16, cojin: 62, cambioTinta: 40, tipo: 'placa' },
                ],
                fechador: [
                    { modelo: 'SELLO COLOP PRINTER 35 FECHADOR', medida: '3x5', precio: 320.0, cojin: 62, cambioTinta: 30, tipo: 'fechador' },
                    { modelo: 'SELLO COLOP PRINTER FECHADOR 53-DATER', medida: '3x4.5', precio: 273.26, cojin: 62, cambioTinta: 35, tipo: 'fechador' },
                    { modelo: 'SELLO COLOP PRINTER FECHADOR 54-DATER', medida: '4x5', precio: 275.45, cojin: 62, cojin2Colores: 81, cambioTinta: 40, cambioTinta2Colores: 50, tipo: 'fechador' },
                    { modelo: 'SELLO COLOP PRINTER FECHADOR 55-DATER', medida: '4x6', precio: 310.29, cojin: 62, cojin2Colores: 81, cambioTinta: 40, cambioTinta2Colores: 50, tipo: 'fechador' },
                    { modelo: 'SELLO COLOP PRINTER Q43 DATER FECHADOR', medida: '4.3x4.3', precio: 260.57, cojin: 62, cambioTinta: 40, tipo: 'fechador' },
                    { modelo: 'SELLO COLOP PRINTER R50 FECHADOR', medida: '5cm diametro', precio: 410.0, cojin: 82, cambioTinta: 45, tipo: 'fechador' },
                ],
                bolsillo: [
                    { modelo: 'SELLO COLOP POCKET STAMP PLUS 30 18X47MM', medida: '1.8x4.7', precio: 95.64, cojin: null, tipo: 'bolsillo' },
                    { modelo: 'SELLO COLOP POCKET STAMP 20', medida: '1.4x3.8', precio: 69.74, cojin: null, tipo: 'bolsillo' },
                    { modelo: 'Sello Automático COLOP Printer R12', medida: '1.2cm diametro', precio: 140, cojin: null, tipo: 'bolsillo', margen: 1.5, gomaEspecial: { w: 2.5, h: 2.5 } },
                ],
                redondos: [
                    { modelo: 'SELLO COLOP PRINTER R50 PLACA', medida: '5cm diametro', precio: 273.27, cojin: 82, cambioTinta: 45, tipo: 'placa' },
                    { modelo: 'SELLO COLOP PRINTER R50 FECHADOR', medida: '5cm diametro', precio: 410.0, cojin: 82, cambioTinta: 45, tipo: 'fechador' },
                ],
                ropa: [
                    { modelo: 'SELLO MARCADOR DE ROPA/LIBROS MINE C20/1 PIEZA', medida: '1.4x3.8', precio: 214.57, cojin: 80, tipo: 'ropa', isTextil: true },
                    { modelo: 'SELLO COLOP PRINTER 30 TEXTIL', medida: '1.8x4.7', precio: 320, cojin: null, tipo: 'ropa', isTextil: true },
                ],
                usoRudo: [
                    { modelo: 'Sello De Uso Rudo Metálico con Placa COLOP 2600', medida: '3.7x5.8', precio: 610, cojin: null, tipo: 'placa', margen: 1.6, costoGomaFijo: 85 },
                ],
            },
        };
        const initialMaderaData = [
            { ancho: 2, costoTira: 80, costoPuno: 16, costoFabricar: 20 }, { ancho: 2.5, costoTira: 80, costoPuno: 16, costoFabricar: 20 }, { ancho: 3, costoTira: 80, costoPuno: 16, costoFabricar: 20 }, { ancho: 3.5, costoTira: 80, costoPuno: 17, costoFabricar: 20 }, { ancho: 4, costoTira: 90, costoPuno: 17, costoFabricar: 20 }, { ancho: 4.5, costoTira: 90, costoPuno: 20, costoFabricar: 20 }, { ancho: 5, costoTira: 95, costoPuno: 20, costoFabricar: 20 }, { ancho: 5.5, costoTira: 95, costoPuno: 18, costoFabricar: 20 }, { ancho: 6, costoTira: 95, costoPuno: 50, costoFabricar: 30 }, { ancho: 6.5, costoTira: 95, costoPuno: 50, costoFabricar: 30 }, { ancho: 7, costoTira: 105, costoPuno: 78, costoFabricar: 30 }, { ancho: 7.5, costoTira: 105, costoPuno: 78, costoFabricar: 30 }, { ancho: 8, costoTira: 105, costoPuno: 78, costoFabricar: 30 }, { ancho: 8.5, costoTira: 105, costoPuno: 100, costoFabricar: 30 }, { ancho: 9, costoTira: 120, costoPuno: 100, costoFabricar: 30 }, { ancho: 9.5, costoTira: 120, costoPuno: 130, costoFabricar: 30 }, { ancho: 10, costoTira: 130, costoPuno: 130, costoFabricar: 40 }, { ancho: 10.5, costoTira: 130, costoPuno: 135, costoFabricar: 40 }, { ancho: 11, costoTira: 135, costoPuno: 135, costoFabricar: 40 }, { ancho: 11.5, costoTira: 135, costoPuno: 140, costoFabricar: 40 }, { ancho: 12, costoTira: 140, costoPuno: 140, costoFabricar: 40 }, { ancho: 12.5, costoTira: 160, costoPuno: 145, costoFabricar: 40 }, { ancho: 13, costoTira: 170, costoPuno: 145, costoFabricar: 50 }, { ancho: 13.5, costoTira: 175, costoPuno: 150, costoFabricar: 50 }, { ancho: 14, costoTira: 180, costoPuno: 150, costoFabricar: 50 }, { ancho: 14.5, costoTira: 185, costoPuno: 150, costoFabricar: 50 }, { ancho: 15, costoTira: 190, costoPuno: 150, costoFabricar: 80 }, { ancho: 20, costoTira: 250, costoPuno: 200, costoFabricar: 80 },
        ];
        const accesoriosData = [
            { id: 'cojin1', nombre: 'COJIN PELICAN #1 MEDIANO', precio: 19.21, tipo: 'cojin' }, { id: 'cojin2', nombre: 'COJIN PELICAN #2 GRANDE', precio: 32.20, tipo: 'cojin' }, { id: 'tintaNegra', nombre: 'TINTA PELICAN NEGRA 60ML', precio: 27, tipo: 'tinta' }, { id: 'tintaAzul', nombre: 'TINTA PELICAN AZUL 60ML', precio: 27, tipo: 'tinta' },
        ];
        const tiposDeSello = ['Madera', 'Auto-entintable', 'Gomas para sellos'];
        const ubicacionDeGoma = ['en aparato', 'en madera', 'solo la goma sin pegar'];
        const coloresDeTinta = ['Negra', 'Verde', 'Rojo', 'Azul', 'Morado'];
        const APARATO_MARGIN = 1.4, GENERIC_MATERIAL_MARGIN = 1.5, TIRA_MADERA_LENGTH_CM = 60, INITIAL_CYREL_SHEET_COST = 1000, TINTA_MARGIN = 1.50, COJIN_MARGIN = 1.80, cyrelSheetWidth = 19, cyrelSheetHeight = 25, disenoCost = 45, savedDisenoCost = 25, AUTO_GOMA_FABRICATION_COST = 45, manoDeObraCost = 40, costoPegadoAparato = 5, costoPegadoMadera = 10, expressSurchargePercentage = 0.50;

        const initialSelloDetails = { tipo: '', subTipo: '', modelo: '', ancho: '', alto: '', largo: '', cantidad: '', clienteEnviaDiseno: false, realizarDiseno: false, disenoGuardado: false, ubicacionGoma: '', cambioTinta2Colores: false, cambioTinta: false, colorTinta: '' };
        const initialAccesoriosState = { cojin1: 0, cojin2: 0, tintaNegra: 0, tintaAzul: 0 };

        const formatCurrency = (number) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(number);
        const getModelSize = (model) => {
            if (!model) return { w: 0, h: 0 };
            const m = (model.medida || '').toString();
            if (m.includes('diametro')) {
                const n = parseFloat(m.match(/([\d.]+)/)?.[0]) || 0;
                return { w: n, h: n };
            }
            const parts = m.split('x').map(p => parseFloat(p) || 0);
            return { w: parts[0] || 0, h: parts[1] || 0 };
        }

        const Header = () => (
            <div className="text-center py-8">
                <div className="inline-block p-4 rounded-full bg-gray-700/50 mb-4 shadow-[0_0_15px_rgba(34,211,238,0.2)]">
                    <i className="fas fa-stamp text-4xl text-cyan-400"></i>
                </div>
                <h1 className="text-4xl font-extrabold text-white tracking-tight mb-2">Cotizador de Sellos</h1>
                <div className="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 rounded-full border border-gray-700 shadow-sm mt-2">
                    <span className="text-sm font-bold text-cyan-400">v3.0 - Future Dark</span>
                </div>
            </div>
        );
        const ErrorMessage = ({ error }) => error ? <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><span className="block sm:inline">{error}</span></div> : null;

        const SelloDetailsForm = ({ currentItem, setCurrentItem, editableSelloData, gomaModel, setGomaModel }) => {
            const handleSelloChange = (name, value) => {
                setCurrentItem(prev => {
                    const updated = { ...prev, [name]: value };
                    if (name === 'tipo') {
                        setGomaModel({ subTipo: '', modelo: '' });
                        const newState = { ...initialSelloDetails, tipo: value, cantidad: prev.cantidad };
                        if (value === 'Auto-entintable') {
                            newState.colorTinta = 'Negra';
                        }
                        return newState;
                    }
                    if (name === 'subTipo') return { ...updated, modelo: '' };
                    return updated;
                });
            };

            const handleGomaModelChange = (name, value) => {
                const newGomaModel = { ...gomaModel, [name]: value };
                if (name === 'subTipo') newGomaModel.modelo = '';
                setGomaModel(newGomaModel);

                if (newGomaModel.subTipo && newGomaModel.modelo) {
                    const selectedSello = editableSelloData.colop[newGomaModel.subTipo]?.find(s => s.modelo === newGomaModel.modelo);
                    if (selectedSello) {
                        const { w, h } = getModelSize(selectedSello);
                        setCurrentItem(p => ({ ...p, ancho: w, alto: h }));
                    }
                } else {
                    setCurrentItem(p => ({ ...p, ancho: '', alto: '' }));
                }
            };

            const inputStyle = "w-full p-3 bg-gray-700 border border-gray-600 rounded-xl text-white focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none shadow-sm transition-all placeholder-gray-400";

            return (
                <div className="bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
                    <h2 className="text-xl font-bold mb-6 text-cyan-400 flex items-center gap-2">
                        <i className="fas fa-cog"></i> Paso 1: Configurar Artículo
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input name="cantidad" placeholder="Escribe cantidad a cotizar" type="number" min="1" value={currentItem.cantidad} onChange={(e) => handleSelloChange('cantidad', e.target.value)} className={inputStyle} />
                        <select onChange={(e) => handleSelloChange('tipo', e.target.value)} value={currentItem.tipo} className={inputStyle}>
                            <option value="">Tipo de Sello</option>
                            {tiposDeSello.map(tipo => <option key={tipo} value={tipo}>{tipo}</option>)}
                        </select>
                        {currentItem.tipo === 'Auto-entintable' && (
                            <>
                                <select onChange={(e) => handleSelloChange('subTipo', e.target.value)} value={currentItem.subTipo} className={inputStyle}>
                                    <option value="">Subtipo</option>
                                    {Object.keys(editableSelloData.colop).map(subTipo => <option key={subTipo} value={subTipo}>{subTipo}</option>)}
                                </select>
                                {currentItem.subTipo && (
                                    <select onChange={(e) => handleSelloChange('modelo', e.target.value)} value={currentItem.modelo} className={inputStyle}>
                                        <option value="">Modelo</option>
                                        {editableSelloData.colop[currentItem.subTipo].map(sello => <option key={sello.modelo} value={sello.modelo}>{`${sello.modelo} (${sello.medida})`}</option>)}
                                    </select>
                                )}
                            </>
                        )}
                        {currentItem.tipo === 'Madera' && (
                            <>
                                <input name="ancho" placeholder="Ancho (cm)" type="number" step="0.1" min="0" value={currentItem.ancho} onChange={(e) => handleSelloChange('ancho', e.target.value)} className={inputStyle} />
                                <input name="largo" placeholder="Largo (cm)" type="number" step="0.1" min="0" value={currentItem.largo} onChange={(e) => handleSelloChange('largo', e.target.value)} className={inputStyle} />
                            </>
                        )}
                        {currentItem.tipo === 'Gomas para sellos' && (
                            <>
                                <input name="ancho" placeholder="Ancho (cm)" type="number" step="0.1" min="0" value={currentItem.ancho} onChange={(e) => handleSelloChange('ancho', e.target.value)} className={inputStyle} disabled={!!gomaModel.modelo} />
                                <input name="alto" placeholder="Alto (cm)" type="number" step="0.1" min="0" value={currentItem.alto} onChange={(e) => handleSelloChange('alto', e.target.value)} className={inputStyle} disabled={!!gomaModel.modelo} />
                                <select onChange={(e) => handleGomaModelChange('subTipo', e.target.value)} value={gomaModel.subTipo} className={inputStyle}>
                                    <option value="">Opcional: Elegir aparato para medidas</option>
                                    {Object.keys(editableSelloData.colop).map(subTipo => <option key={subTipo} value={subTipo}>{subTipo}</option>)}
                                </select>
                                {gomaModel.subTipo && (
                                    <select onChange={(e) => handleGomaModelChange('modelo', e.target.value)} value={gomaModel.modelo} className={inputStyle}>
                                        <option value="">Elegir modelo</option>
                                        {editableSelloData.colop[gomaModel.subTipo].map(sello => <option key={sello.modelo} value={sello.modelo}>{sello.modelo}</option>)}
                                    </select>
                                )}
                                <div className="md:col-span-2">
                                    <select onChange={(e) => handleSelloChange('ubicacionGoma', e.target.value)} value={currentItem.ubicacionGoma} className={inputStyle}>
                                        <option value="">Ubicación de la Goma</option>
                                        {ubicacionDeGoma.map(ubicacion => <option key={ubicacion} value={ubicacion}>{ubicacion}</option>)}
                                    </select>
                                </div>
                            </>
                        )}
                        <div className="col-span-2 flex items-center space-x-4 text-gray-200">
                            <input type="checkbox" id="clienteEnviaDiseno" checked={currentItem.clienteEnviaDiseno} onChange={e => setCurrentItem(p => ({ ...p, clienteEnviaDiseno: e.target.checked, realizarDiseno: false, disenoGuardado: false }))} className="h-4 w-4 rounded bg-gray-600 border-gray-500 text-purple-500 focus:ring-purple-600" />
                            <label htmlFor="clienteEnviaDiseno">Cliente envía diseño</label>
                            <input type="checkbox" id="realizarDiseno" checked={currentItem.realizarDiseno} onChange={e => setCurrentItem(p => ({ ...p, realizarDiseno: e.target.checked, clienteEnviaDiseno: false, disenoGuardado: false }))} className="h-4 w-4 rounded bg-gray-600 border-gray-500 text-purple-500 focus:ring-purple-600" />
                            <label htmlFor="realizarDiseno">Realizar diseño</label>
                            <input type="checkbox" id="disenoGuardado" checked={currentItem.disenoGuardado} onChange={e => setCurrentItem(p => ({ ...p, disenoGuardado: e.target.checked, clienteEnviaDiseno: false, realizarDiseno: false }))} className="h-4 w-4 rounded bg-gray-600 border-gray-500 text-purple-500 focus:ring-purple-600" />
                            <label htmlFor="disenoGuardado">Diseño guardado</label>
                        </div>
                        <div className="col-span-2 flex items-center space-x-4 text-gray-200">
                            <input type="checkbox" id="cambioTinta" checked={currentItem.cambioTinta} onChange={e => setCurrentItem(p => ({ ...p, cambioTinta: e.target.checked, cambioTinta2Colores: false }))} className="h-4 w-4 rounded bg-gray-600 border-gray-500 text-purple-500 focus:ring-purple-600" disabled={!editableSelloData.colop[currentItem.subTipo]?.find(s => s.modelo === currentItem.modelo)?.cojin || editableSelloData.colop[currentItem.subTipo]?.find(s => s.modelo === currentItem.modelo)?.isTextil || currentItem.cambioTinta2Colores} />
                            <label htmlFor="cambioTinta">Cambio de Tinta (1 color)</label>

                            {editableSelloData.colop[currentItem.subTipo]?.find(s => s.modelo === currentItem.modelo)?.cojin2Colores && (
                                <>
                                    <input type="checkbox" id="cambioTinta2Colores" checked={currentItem.cambioTinta2Colores} onChange={e => setCurrentItem(p => ({ ...p, cambioTinta2Colores: e.target.checked, cambioTinta: false }))} className="h-4 w-4 rounded bg-gray-600 border-gray-500 text-purple-500 focus:ring-purple-600" disabled={currentItem.cambioTinta} />
                                    <label htmlFor="cambioTinta2Colores">Cambio de Tinta (2 colores)</label>
                                </>
                            )}
                        </div>
                        {currentItem.cambioTinta && (
                            <div className="col-span-2">
                                <select onChange={(e) => handleSelloChange('colorTinta', e.target.value)} value={currentItem.colorTinta} className={inputStyle}>
                                    <option value="">Color de Tinta</option>
                                    {coloresDeTinta.map(color => <option key={color} value={color}>{color}</option>)}
                                </select>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AccesoriosSection = ({ currentAccesorios, setCurrentAccesorios }) => (
            <div className="mt-6 bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
                <h3 className="text-xl font-bold mb-6 text-cyan-400">Paso 3: Agregar Accesorios (Opcional)</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {accesoriosData.map(item => (
                        <div key={item.id} className="flex items-center justify-between p-3 bg-gray-700 rounded-lg border border-gray-600">
                            <label htmlFor={item.id} className="text-sm font-medium text-gray-200">{item.nombre}</label>
                            <input id={item.id} type="number" min="0" value={currentAccesorios[item.id] || 0} onChange={e => setCurrentAccesorios(p => ({ ...p, [item.id]: parseInt(e.target.value) || 0 }))} className="w-24 p-2 bg-gray-900 border border-gray-500 rounded-md text-white text-right focus:ring-2 focus:ring-cyan-500 outline-none" />
                        </div>
                    ))}
                </div>
            </div>
        );

        const GlobalOptions = ({ globalOptions, setGlobalOptions }) => (
            <div className="mt-6 bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700 flex flex-col space-y-4">
                <h2 className="text-xl font-bold text-cyan-400">Paso 4: Opciones Globales</h2>
                <div className="flex items-center space-x-3 p-3 bg-gray-700 rounded-lg border border-gray-600">
                    <input type="checkbox" id="isExpress" checked={globalOptions.isExpress} onChange={e => setGlobalOptions(o => ({ ...o, isExpress: e.target.checked }))} className="h-5 w-5 rounded border-gray-500 text-cyan-600 focus:ring-cyan-500 bg-gray-900" />
                    <label htmlFor="isExpress" className="text-sm font-medium text-gray-200">Servicio Exprés para toda la cotización</label>
                </div>
                <div className="flex items-center space-x-3 p-3 bg-gray-700 rounded-lg border border-gray-600">
                    <input type="checkbox" id="isMaquila" checked={globalOptions.isMaquila} onChange={e => setGlobalOptions(o => ({ ...o, isMaquila: e.target.checked }))} className="h-5 w-5 rounded border-gray-500 text-cyan-600 focus:ring-cyan-500 bg-gray-900" />
                    <label htmlFor="isMaquila" className="text-sm font-medium text-gray-200">Es Maquila (Aplica a todos los artículos)</label>
                </div>
            </div>
        );

        const QuoteItemsList = ({ items, removeItem, generateItemDescription, editableSelloData, editableMaderaData, editableCyrelSheetCost }) => {
            const [expandedId, setExpandedId] = React.useState(null);
            if (items.length === 0) return null;

            return (
                <div className="mt-8">
                    <h2 className="text-xl font-bold mb-6 text-cyan-400">Paso 5: Revisar Cotización</h2>
                    <div className="space-y-4">
                        {items.map((item, index) => {
                            if (!item.calculos) return null;
                            const isExpanded = expandedId === item.id;
                            const selectedModelData = item.details.subTipo && item.details.modelo ? editableSelloData.colop[item.details.subTipo]?.find(s => s.modelo === item.details.modelo) : null;
                            return (
                                <div key={item.id} className="bg-gray-800 p-6 rounded-2xl shadow-md border border-gray-700 transition-all hover:shadow-lg hover:border-cyan-500/50">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-grow pr-4">
                                            <p className="font-bold text-lg text-white">{generateItemDescription(item)}</p>
                                            <p className="font-extrabold text-cyan-400 text-xl mt-1">Total: {formatCurrency(item.calculos.total)}</p>
                                            <div className="mt-2 flex gap-4 text-sm text-gray-400">
                                                <span className="bg-gray-700 px-2 py-1 rounded">Unitario (c/IVA): {formatCurrency(item.calculos.total / parseInt(item.details.cantidad || '1', 10))}</span>
                                                <span className="bg-gray-700 px-2 py-1 rounded">Unitario (s/IVA): {formatCurrency(item.calculos.subtotal / parseInt(item.details.cantidad || '1', 10))}</span>
                                            </div>
                                        </div>
                                        <div className="text-right flex-shrink-0 flex flex-col items-end gap-2">
                                            <button onClick={() => setExpandedId(isExpanded ? null : item.id)} className="text-sm font-semibold text-cyan-400 hover:text-cyan-300 bg-gray-700 px-3 py-1 rounded-full transition-colors">
                                                {isExpanded ? 'Ocultar Desglose' : 'Ver Desglose'}
                                            </button>
                                            <button onClick={() => removeItem(index)} className="text-sm font-semibold text-red-400 hover:text-red-300 bg-gray-700 px-3 py-1 rounded-full transition-colors">
                                                <i className="fas fa-trash-alt"></i> Eliminar
                                            </button>
                                        </div>
                                    </div>
                                    {isExpanded && <CostSummary calculos={item.calculos} selloDetails={item.details} selectedModelData={selectedModelData} editableMaderaData={editableMaderaData} editableCyrelSheetCost={editableCyrelSheetCost} />}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const CostSummary = ({ calculos, selloDetails, selectedModelData, editableMaderaData, editableCyrelSheetCost }) => {
            const cyrelAreaCostPerCm2 = (parseFloat(editableCyrelSheetCost) || 0) / (cyrelSheetWidth * cyrelSheetHeight);
            const modelDims = getModelSize(selectedModelData);
            const anchoMaderaNum = parseFloat(selloDetails.ancho || '0');
            const selectedMaderaForDisplay = anchoMaderaNum > 0 ? editableMaderaData.find(m => m.ancho >= anchoMaderaNum) : null;
            const tirasNecesariasForDisplay = selectedMaderaForDisplay ? Math.ceil((parseFloat(selloDetails.largo || '0') * parseInt(selloDetails.cantidad || '1')) / TIRA_MADERA_LENGTH_CM) : 0;

            return (
                <div className="bg-gray-700/50 p-4 rounded-xl mt-4 border border-gray-600">
                    <h3 className="text-sm font-bold text-gray-300 mb-3 uppercase tracking-wide">Desglose Detallado</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm text-gray-400">
                        {calculos.costoAparato > 0 && <p>Costo Aparato: <span className="font-semibold text-white">{formatCurrency(calculos.costoAparato)}</span><br /><span className="text-xs text-gray-500">Costo: {parseFloat(selectedModelData?.precio || '0').toFixed(2)} x Margen: {selectedModelData?.isTextil ? 1 : APARATO_MARGIN} x Cant: {selloDetails.cantidad}</span></p>}
                        {calculos.costoMadera > 0 && selectedMaderaForDisplay && <p>Costo Madera: <span className="font-semibold text-white">{formatCurrency(calculos.costoMadera)}</span><br /><span className="text-xs text-gray-500">((Costo Tira: {selectedMaderaForDisplay.costoTira} / {TIRA_MADERA_LENGTH_CM}cm) * {selloDetails.largo}cm * {selloDetails.cantidad}) * Margen: {GENERIC_MATERIAL_MARGIN}</span></p>}
                        {calculos.costoPuno > 0 && selectedMaderaForDisplay && <p>Costo Puño: <span className="font-semibold text-white">{formatCurrency(calculos.costoPuno)}</span><br /><span className="text-xs text-gray-500">(Costo Puño: {selectedMaderaForDisplay.costoPuno} x Cant: {selloDetails.cantidad}) * Margen: {GENERIC_MATERIAL_MARGIN}</span></p>}
                        {calculos.costoFabricar > 0 && selectedMaderaForDisplay && <p>Costo Fabricar (Madera): <span className="font-semibold text-white">{formatCurrency(calculos.costoFabricar)}</span><br /><span className="text-xs text-gray-500">(Costo Fabricar: {selectedMaderaForDisplay.costoFabricar} x Tiras: {tirasNecesariasForDisplay}) * Margen: {GENERIC_MATERIAL_MARGIN}</span></p>}
                        {calculos.costoFabricacionAutoGoma > 0 && <p>Costo Fabricar (Auto/Goma): <span className="font-semibold text-white">{formatCurrency(calculos.costoFabricacionAutoGoma)}</span><br /><span className="text-xs text-gray-500">Costo: {AUTO_GOMA_FABRICATION_COST} x Cant: {selloDetails.cantidad}</span></p>}
                        {calculos.costoGoma > 0 && <p>Costo Goma: <span className="font-semibold text-white">{formatCurrency(calculos.costoGoma)}</span><br /><span className="text-xs text-gray-500">({selloDetails.ancho || modelDims.w}cm x {selloDetails.alto || selloDetails.largo || modelDims.h}cm x ${cyrelAreaCostPerCm2.toFixed(2)}/cm²) x {selloDetails.cantidad}</span></p>}
                        {calculos.costoGrabado > 0 && <p>Costo Grabado: <span className="font-semibold text-white">{formatCurrency(calculos.costoGrabado)}</span><br /><span className="text-xs text-gray-500">{`Tarifa para ${selloDetails.cantidad} pz`}</span></p>}
                        {calculos.costoDiseno > 0 && <p>Costo Diseño: <span className="font-semibold text-white">{formatCurrency(calculos.costoDiseno)}</span><br /><span className="text-xs text-gray-500">Costo: {selloDetails.realizarDiseno ? disenoCost : savedDisenoCost} x Cant: {selloDetails.cantidad}</span></p>}
                        {calculos.costoCambioTinta > 0 && <p>Costo Cambio Tinta: <span className="font-semibold text-white">{formatCurrency(calculos.costoCambioTinta)}</span><br /><span className="text-xs text-gray-500">{`((Cojín: ${selloDetails.cambioTinta2Colores ? selectedModelData?.cojin2Colores : selectedModelData?.cojin} x ${GENERIC_MATERIAL_MARGIN}) + Tinta: ${selloDetails.cambioTinta2Colores ? selectedModelData?.cambioTinta2Colores : selectedModelData?.cambioTinta} + M.O.: ${manoDeObraCost}) x ${selloDetails.cantidad}`}</span></p>}
                        {calculos.costoExpress > 0 && (
                            <p>Costo Exprés: <span className="font-semibold text-red-400">{formatCurrency(calculos.costoExpress)}</span><br />
                                <span className="text-xs text-gray-500">Recargo (50% de {formatCurrency(calculos.surchargeBase)}) + $250 tarifa fija</span></p>
                        )}
                        {calculos.costoMaquila > 0 && <p>Descuento Maquila: <span className="font-semibold text-green-400">-{formatCurrency(calculos.costoMaquila)}</span><br /><span className="text-xs text-gray-500">Subtotal: {formatCurrency(calculos.subtotalBase + calculos.costoExpress)} x 20%</span></p>}
                    </div>
                </div>
            );
        };

        const TotalSummary = ({ items }) => {
            if (items.length === 0) return null;
            const grandTotal = items.reduce((sum, item) => sum + (item.calculos?.total || 0), 0);
            const grandSubtotal = items.reduce((sum, item) => sum + (item.calculos?.subtotal || 0), 0);
            const grandIva = items.reduce((sum, item) => sum + (item.calculos?.iva || 0), 0);
            return (
                <div className="mt-8 bg-gray-800 border-l-4 border-cyan-500 p-6 rounded-2xl shadow-xl flex flex-col md:flex-row justify-between items-center gap-4 border border-gray-700">
                    <div>
                        <h2 className="text-2xl font-bold text-white">Resumen Total</h2>
                        <div className="text-sm text-gray-400 mt-1">
                            <span className="mr-4">Subtotal: {formatCurrency(grandSubtotal)}</span>
                            <span>IVA (16%): {formatCurrency(grandIva)}</span>
                        </div>
                    </div>
                    <div className="text-right">
                        <p className="text-sm text-gray-400 uppercase font-bold">Total a Pagar</p>
                        <p className="text-4xl font-black text-cyan-400 drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">{formatCurrency(grandTotal)}</p>
                    </div>
                </div>
            );
        };

        const SimplifiedSummary = ({ generateSimplifiedSummaryText, copyToClipboard, copiedMessage, handleClearQuote }) => {
            const summaryText = generateSimplifiedSummaryText();
            if (!summaryText) return null;
            return (
                <div className="mt-6 bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-[0_0_15px_rgba(34,211,238,0.1)]">
                    <h3 className="text-lg font-bold text-cyan-400 mb-3 flex items-center gap-2"><i className="fab fa-whatsapp text-green-500"></i> Resumen para Cliente</h3>
                    <div className="bg-gray-900 p-4 rounded-xl shadow-inner border border-gray-700">
                        <pre className="whitespace-pre-wrap text-gray-300 font-mono text-sm leading-relaxed">{summaryText}</pre>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4 mt-6">
                        <button onClick={copyToClipboard} className="flex-1 bg-gradient-to-r from-green-600 to-emerald-700 text-white font-bold py-3 px-6 rounded-xl hover:shadow-lg hover:scale-[1.02] transition-all border border-green-500/30 shadow-[0_0_10px_rgba(34,197,94,0.3)]">
                            <i className="fas fa-copy"></i> Copiar Cotización
                        </button>
                        <button onClick={handleClearQuote} className="flex-1 bg-red-900/20 text-red-400 font-bold py-3 px-6 rounded-xl border border-red-800 hover:bg-red-900/40 transition-colors">
                            <i className="fas fa-trash-alt"></i> Eliminar Todo
                        </button>
                    </div>
                    {copiedMessage && <p className="text-green-400 font-bold text-center mt-3 animate-pulse">{copiedMessage}</p>}
                </div>
            );
        };

        const MaterialCosts = ({
            editableSelloData, setEditableSelloData,
            editableMaderaData, setEditableMaderaData,
            editableCyrelSheetCost, setEditableCyrelSheetCost,
            editableDisenoCost, setEditableDisenoCost,
            editableSavedDisenoCost, setEditableSavedDisenoCost,
            editableAutoGomaFabricationCost, setEditableAutoGomaFabricationCost
        }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const [expandedCategory, setExpandedCategory] = React.useState(null);
            const inputStyle = "w-full p-2 bg-gray-900 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-cyan-500 outline-none";

            const handleSelloChange = (subTipo, modelo, newPrecio) => {
                setEditableSelloData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    const sello = newData.colop[subTipo].find(s => s.modelo === modelo);
                    if (sello) sello.precio = parseFloat(newPrecio) || 0;
                    return newData;
                });
            };

            const handleMaderaChange = (index, field, value) => {
                setEditableMaderaData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    newData[index][field] = parseFloat(value) || 0;
                    return newData;
                });
            };

            const categories = {
                "Costos Sellos": "sellos",
                "Madera y Puños": "madera",
                "Goma, Grabado y Fabricado": "goma",
                "Costo de Diseños": "diseno"
            };

            return (
                <div className="mt-8 bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full bg-gradient-to-r from-cyan-600 to-blue-700 text-white font-bold py-3 px-6 rounded-xl hover:shadow-lg hover:from-cyan-700 hover:to-blue-800 transition-all duration-200 flex items-center justify-center gap-2 border border-cyan-500/30 shadow-[0_0_10px_rgba(34,211,238,0.3)]">
                        <i className="fas fa-cogs"></i> {isOpen ? 'Ocultar Costos de Materiales' : 'Configurar Costos de Materiales'}
                    </button>
                    {isOpen && (
                        <div className="mt-6 animate-fadeIn">
                            <div className="flex flex-wrap gap-2 mb-6 justify-center">
                                {Object.entries(categories).map(([name, key]) => (
                                    <button key={key} onClick={() => setExpandedCategory(expandedCategory === key ? null : key)} className={`px-4 py-2 text-sm font-semibold rounded-full transition-colors ${expandedCategory === key ? 'bg-cyan-600 text-white shadow-[0_0_10px_rgba(34,211,238,0.5)]' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>
                                        {name}
                                    </button>
                                ))}
                            </div>

                            {expandedCategory === 'sellos' && (
                                <div className="space-y-4">
                                    <h4 className="text-lg font-bold text-cyan-400 border-b border-gray-700 pb-2">Aparatos y Placas</h4>
                                    {Object.entries(editableSelloData.colop).map(([subTipo, sellos]) => (
                                        <div key={subTipo} className="bg-gray-700 p-4 rounded-xl border border-gray-600">
                                            <h5 className="font-bold text-cyan-300 capitalize mb-3 border-b border-gray-600 pb-1">{subTipo}</h5>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {sellos.map(sello => (
                                                    <div key={sello.modelo} className="flex items-center gap-2 text-sm">
                                                        <span className="text-gray-200 flex-1">{sello.modelo}</span>
                                                        <input type="number" value={sello.precio} onChange={e => handleSelloChange(subTipo, sello.modelo, e.target.value)} className="w-24 p-2 bg-gray-900 border border-gray-500 rounded text-right text-white" />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {expandedCategory === 'madera' && (
                                <div className="space-y-4">
                                    <h4 className="text-lg font-bold text-cyan-400 border-b border-gray-700 pb-2">Maderas y Puños</h4>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left text-gray-300">
                                            <thead className="text-xs text-cyan-300 uppercase bg-gray-700">
                                                <tr>
                                                    <th className="px-4 py-2 rounded-tl-lg">Ancho</th>
                                                    <th className="px-4 py-2">Costo Tira</th>
                                                    <th className="px-4 py-2">Costo Puño</th>
                                                    <th className="px-4 py-2 rounded-tr-lg">Costo Fab.</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {editableMaderaData.map((madera, index) => (
                                                    <tr key={index} className="border-b border-gray-600 hover:bg-gray-700/50">
                                                        <td className="px-4 py-2 font-medium">{madera.ancho} cm</td>
                                                        <td className="px-4 py-2"><input type="number" value={madera.costoTira} onChange={e => handleMaderaChange(index, 'costoTira', e.target.value)} className="w-20 p-1 border border-gray-500 bg-gray-900 rounded text-white" /></td>
                                                        <td className="px-4 py-2"><input type="number" value={madera.costoPuno} onChange={e => handleMaderaChange(index, 'costoPuno', e.target.value)} className="w-20 p-1 border border-gray-500 bg-gray-900 rounded text-white" /></td>
                                                        <td className="px-4 py-2"><input type="number" value={madera.costoFabricar} onChange={e => handleMaderaChange(index, 'costoFabricar', e.target.value)} className="w-20 p-1 border border-gray-500 bg-gray-900 rounded text-white" /></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {expandedCategory === 'goma' && (
                                <div className="space-y-4">
                                    <h4 className="text-lg font-bold text-cyan-400 border-b border-gray-700 pb-2">Goma, Grabado y Fabricado</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-gray-700 p-4 rounded-xl border border-gray-600">
                                            <label className="block text-sm font-medium text-gray-200 mb-1">Costo Plancha Cyrel</label>
                                            <input type="number" value={editableCyrelSheetCost} onChange={e => setEditableCyrelSheetCost(e.target.value)} className={inputStyle} />
                                        </div>
                                        <div className="bg-gray-700 p-4 rounded-xl border border-gray-600">
                                            <label className="block text-sm font-medium text-gray-200 mb-1">Costo Fabr. (Auto/Goma)</label>
                                            <input type="number" value={editableAutoGomaFabricationCost} onChange={e => setEditableAutoGomaFabricationCost(e.target.value)} className={inputStyle} />
                                        </div>
                                    </div>
                                    <p className="text-gray-400 text-xs italic">Nota: Los costos de grabado se calculan automáticamente según cantidad.</p>
                                </div>
                            )}

                            {expandedCategory === 'diseno' && (
                                <div className="space-y-4">
                                    <h4 className="text-lg font-bold text-cyan-400 border-b border-gray-700 pb-2">Costo de Diseños</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-gray-700 p-4 rounded-xl border border-gray-600">
                                            <label className="block text-sm font-medium text-gray-200 mb-1">Realizar Diseño (Nuevo)</label>
                                            <input type="number" value={editableDisenoCost} onChange={e => setEditableDisenoCost(e.target.value)} className={inputStyle} />
                                        </div>
                                        <div className="bg-gray-700 p-4 rounded-xl border border-gray-600">
                                            <label className="block text-sm font-medium text-gray-200 mb-1">Usar Diseño Guardado</label>
                                            <input type="number" value={editableSavedDisenoCost} onChange={e => setEditableSavedDisenoCost(e.target.value)} className={inputStyle} />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        function App() {
            const [currentItem, setCurrentItem] = React.useState(initialSelloDetails);
            const [currentAccesorios, setCurrentAccesorios] = React.useState(initialAccesoriosState);
            const [quoteItems, setQuoteItems] = React.useState([]);
            const [globalOptions, setGlobalOptions] = React.useState({ isExpress: false, isMaquila: false });
            const [gomaModel, setGomaModel] = React.useState({ subTipo: '', modelo: '' });
            const [error, setError] = React.useState('');
            const [copiedMessage, setCopiedMessage] = React.useState('');

            const [editableSelloData, setEditableSelloData] = React.useState(() => JSON.parse(JSON.stringify(initialSelloData)));
            const [editableMaderaData, setEditableMaderaData] = React.useState(() => JSON.parse(JSON.stringify(initialMaderaData)));
            const [editableCyrelSheetCost, setEditableCyrelSheetCost] = React.useState(String(INITIAL_CYREL_SHEET_COST));
            const [editableDisenoCost, setEditableDisenoCost] = React.useState(String(disenoCost));
            const [editableSavedDisenoCost, setEditableSavedDisenoCost] = React.useState(String(savedDisenoCost));
            const [editableAutoGomaFabricationCost, setEditableAutoGomaFabricationCost] = React.useState(String(AUTO_GOMA_FABRICATION_COST));


            const calculateCosts = React.useCallback((itemDetails, itemAccesorios, isExpress, isMaquila) => {
                const cantidad = parseInt(itemDetails.cantidad || '1', 10);
                if (cantidad === 0 && Object.values(itemAccesorios).every(q => q === 0)) return null;

                const cyrelSheetCost = parseFloat(editableCyrelSheetCost) || 0;
                const currentDisenoCost = parseFloat(editableDisenoCost) || 0;
                const currentSavedDisenoCost = parseFloat(editableSavedDisenoCost) || 0;
                const currentAutoGomaFabricationCost = parseFloat(editableAutoGomaFabricationCost) || 0;

                const cyrelAreaCostPerCm2 = cyrelSheetCost / (cyrelSheetWidth * cyrelSheetHeight);
                let c = { costoAparato: 0, costoMadera: 0, costoPuno: 0, costoFabricar: 0, costoGoma: 0, costoGrabado: 0, costoDiseno: 0, costoCambioTinta: 0, costoAdicionalPegado: 0, costoExpress: 0, costoFabricacionAutoGoma: 0, costoMaquila: 0, costoAccesorios: 0, subtotalBase: 0, surchargeBase: 0 };

                Object.keys(itemAccesorios).forEach(key => {
                    const accData = accesoriosData.find(a => a.id === key);
                    if (accData && itemAccesorios[key] > 0) {
                        const margin = accData.tipo === 'tinta' ? TINTA_MARGIN : COJIN_MARGIN;
                        c.costoAccesorios += itemAccesorios[key] * accData.precio * margin;
                    }
                });

                if (itemDetails.tipo && cantidad > 0) {
                    const grabadoBase = isMaquila ? 80 : 120;
                    if (itemDetails.subTipo === 'bolsillo') {
                        if (cantidad <= 5) {
                            c.costoGrabado = 120;
                        } else if (cantidad <= 10) {
                            c.costoGrabado = 150;
                        } else {
                            c.costoGrabado = 180;
                        }
                    } else {
                        c.costoGrabado = (cantidad >= 6) ? 185 : (cantidad >= 2) ? 150 : grabadoBase * cantidad;
                    }
                    if (itemDetails.realizarDiseno) c.costoDiseno = currentDisenoCost * cantidad;
                    else if (itemDetails.disenoGuardado) c.costoDiseno = currentSavedDisenoCost * cantidad;

                    if (itemDetails.tipo === 'Auto-entintable' && itemDetails.subTipo && itemDetails.modelo) {
                        const selectedSello = editableSelloData.colop[itemDetails.subTipo]?.find(s => s.modelo === itemDetails.modelo);
                        if (selectedSello) {
                            let { w, h } = getModelSize(selectedSello);
                            if (selectedSello.gomaEspecial) {
                                w = selectedSello.gomaEspecial.w;
                                h = selectedSello.gomaEspecial.h;
                            }
                            if (selectedSello.costoGomaFijo) {
                                c.costoGoma = selectedSello.costoGomaFijo * cantidad;
                            } else {
                                c.costoGoma = (w * h) * cyrelAreaCostPerCm2 * cantidad;
                            }
                            const margenAparato = selectedSello.margen || (selectedSello.isTextil ? 1 : APARATO_MARGIN);
                            c.costoAparato = (parseFloat(selectedSello.precio) || 0) * margenAparato * cantidad;
                            c.costoFabricacionAutoGoma = currentAutoGomaFabricationCost * cantidad;

                            if (!selectedSello.isTextil) {
                                const cojinCosto = parseFloat(selectedSello.cojin || '0') || 0;
                                const cojin2ColoresCosto = parseFloat(selectedSello.cojin2Colores || '0') || 0;
                                const cambioTintaCostoUnitario = parseFloat(selectedSello.cambioTinta || '0') || 0;
                                const cambioTinta2ColoresCostoUnitario = parseFloat(selectedSello.cambioTinta2Colores || '0') || 0;

                                if (itemDetails.cambioTinta && cojinCosto && cambioTintaCostoUnitario) {
                                    c.costoCambioTinta = (cojinCosto * GENERIC_MATERIAL_MARGIN + cambioTintaCostoUnitario + manoDeObraCost) * cantidad;
                                } else if (itemDetails.cambioTinta2Colores && cojin2ColoresCosto && cambioTinta2ColoresCostoUnitario) {
                                    c.costoCambioTinta = (cojin2ColoresCosto * GENERIC_MATERIAL_MARGIN + cambioTinta2ColoresCostoUnitario + manoDeObraCost) * cantidad;
                                }
                            }
                        }
                    } else if (itemDetails.tipo === 'Madera') {
                        const ancho = parseFloat(itemDetails.ancho || '0');
                        const largo = parseFloat(itemDetails.largo || '0');
                        if (ancho > 0 && largo > 0) {
                            const selectedMadera = editableMaderaData.find(m => m.ancho >= ancho);
                            if (selectedMadera) {
                                const totalLargoNecesario = largo * cantidad;
                                const tirasNecesarias = Math.ceil(totalLargoNecesario / TIRA_MADERA_LENGTH_CM);
                                c.costoMadera = (parseFloat(selectedMadera.costoTira) / TIRA_MADERA_LENGTH_CM * totalLargoNecesario) * GENERIC_MATERIAL_MARGIN;
                                c.costoPuno = parseFloat(selectedMadera.costoPuno) * cantidad * GENERIC_MATERIAL_MARGIN;
                                c.costoFabricar = parseFloat(selectedMadera.costoFabricar) * tirasNecesarias * GENERIC_MATERIAL_MARGIN;
                            }
                            c.costoGoma = (ancho * largo) * cyrelAreaCostPerCm2 * cantidad;
                        }
                    } else if (itemDetails.tipo === 'Gomas para sellos') {
                        const ancho = parseFloat(itemDetails.ancho || '0');
                        const alto = parseFloat(itemDetails.alto || '0');
                        if (ancho > 0 && alto > 0) {
                            c.costoGoma = (ancho * alto) * cyrelAreaCostPerCm2 * cantidad;
                            c.costoFabricacionAutoGoma = currentAutoGomaFabricationCost * cantidad;
                            if (!isMaquila) {
                                if (itemDetails.ubicacionGoma === 'en aparato') c.costoAdicionalPegado = costoPegadoAparato * cantidad;
                                else if (itemDetails.ubicacionGoma === 'en madera') c.costoAdicionalPegado = costoPegadoMadera * cantidad;
                            }
                        }
                    }
                }

                c.subtotalBase = [

                    c.costoAparato, c.costoMadera, c.costoPuno, c.costoFabricar,

                    c.costoGoma, c.costoGrabado, c.costoDiseno, c.costoCambioTinta,

                    c.costoAdicionalPegado, c.costoFabricacionAutoGoma, c.costoAccesorios

                ].reduce((acc, val) => acc + (parseFloat(val) || 0), 0);



                if (isExpress) {
                    // El cargo del 50% es solo para materiales y mano de obra (goma, fabricar, grabado, etc.)
                    // SIN contar el aparato ni accesorios ni diseño.
                    const sBase = c.subtotalBase - c.costoAparato - c.costoAccesorios - c.costoDiseno;
                    c.surchargeBase = sBase;
                    c.costoExpress = (sBase * 0.50) + 250;
                }
                const subtotalAfterExpress = c.subtotalBase + c.costoExpress;
                if (isMaquila) {
                    c.costoMaquila = subtotalAfterExpress * 0.20;
                }
                const subtotalFinal = subtotalAfterExpress - c.costoMaquila;
                c.subtotal = subtotalFinal;
                c.iva = subtotalFinal * 0.16;
                c.total = subtotalFinal + c.iva;
                return c;
            }, [editableSelloData, editableMaderaData, editableCyrelSheetCost, editableDisenoCost, editableSavedDisenoCost, editableAutoGomaFabricationCost]);

            const processedQuoteItems = React.useMemo(() => {
                return quoteItems.map(item => ({
                    ...item,
                    calculos: calculateCosts(item.details, item.accesorios, globalOptions.isExpress, globalOptions.isMaquila)
                })).filter(item => item.calculos);
            }, [quoteItems, globalOptions, calculateCosts]);

            const handleAddToQuote = () => {
                if (!currentItem.tipo && Object.values(currentAccesorios).every(q => q === 0)) {
                    setError('No se puede agregar un artículo vacío.');
                    return;
                }
                setQuoteItems(prev => [...prev, { id: Date.now(), details: currentItem, accesorios: currentAccesorios }]);
                setCurrentItem(initialSelloDetails);
                setCurrentAccesorios(initialAccesoriosState);
                setGomaModel({ subTipo: '', modelo: '' });
                setError('');
            };

            const handleClearForm = () => {
                setCurrentItem(initialSelloDetails);
                setCurrentAccesorios(initialAccesoriosState);
                setGomaModel({ subTipo: '', modelo: '' });
                setError('');
            }

            const handleClearQuote = () => {
                setQuoteItems([]);
                setCurrentItem(initialSelloDetails);
                setCurrentAccesorios(initialAccesoriosState);
                setGomaModel({ subTipo: '', modelo: '' });
                setGlobalOptions({ isExpress: false, isMaquila: false });
                setError('');
            };

            const generateItemDescription = (item) => {
                const { details, accesorios } = item;
                const cantidad = parseInt(details.cantidad || '1', 10);
                let parts = [];
                if (cantidad > 0 && details.tipo) {
                    const pluralSello = cantidad > 1 ? 'sellos' : 'sello';
                    let desc = `${cantidad} ${pluralSello}`;
                    switch (details.tipo) {
                        case 'Madera': desc += ` de Madera (${details.ancho}x${details.largo} cm)`; break;
                        case 'Auto-entintable':
                            const selectedModel = editableSelloData.colop[details.subTipo]?.find(s => s.modelo === details.modelo);
                            desc += ` autoentitable ${details.subTipo} modelo ${selectedModel?.modelo || ''} (${selectedModel?.medida || ''})`;
                            if (details.cambioTinta) {
                                desc += `, con cambio de tinta (${details.colorTinta || 'sin especificar'})`;
                            } else if (details.cambioTinta2Colores) {
                                desc += ', con cambio de tinta (2 colores)';
                            } else if (details.colorTinta && !selectedModel?.isTextil) {
                                desc += `, tinta ${details.colorTinta}`;
                            }
                            break;
                        case 'Gomas para sellos': desc = `${cantidad} ${cantidad > 1 ? 'gomas' : 'goma'} para sellos (${details.ancho}x${details.alto} cm)`; break;
                    }
                    parts.push(desc);
                }
                if (Object.values(accesorios).some(q => q > 0)) {
                    const accParts = accesoriosData.filter(acc => accesorios[acc.id] > 0).map(acc => `${accesorios[acc.id]} x ${acc.nombre}`);
                    if (accParts.length > 0) parts.push(`Accesorios: ${accParts.join(', ')}`);
                }
                return parts.join('; ');
            };

            const generateSimplifiedSummaryText = () => {
                if (processedQuoteItems.length === 0) return '';
                const toTitleCase = (str) => str.replace(/\b\w/g, c => c.toUpperCase());
                const grandTotal = processedQuoteItems.reduce((sum, item) => sum + (item.calculos.total || 0), 0);
                const summaryLines = processedQuoteItems.map(item => {
                    const { details, calculos } = item;
                    const cantidad = parseInt(details.cantidad || '1', 10);
                    let line = `- ${generateItemDescription(item)}`;
                    if (cantidad > 1) {
                        const unitPrice = calculos.total / cantidad;
                        line += `, Unitario: ${formatCurrency(unitPrice)}, Total: ${formatCurrency(calculos.total)}`;
                    } else {
                        line += `, Total: ${formatCurrency(calculos.total)}`;
                    }
                    return toTitleCase(line);
                });
                summaryLines.push(toTitleCase(`\nTotal neto: ${formatCurrency(grandTotal)}`));
                return summaryLines.join('\n');
            };

            const copyToClipboard = () => {
                const textToCopy = generateSimplifiedSummaryText();
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        setCopiedMessage('¡Copiado!');
                        setTimeout(() => setCopiedMessage(''), 2000);
                    });
                }
            };

            return (
                <div className="min-h-screen p-4 flex flex-col items-center bg-gray-900 font-inter">
                    <div className="w-full max-w-4xl p-6 rounded-xl space-y-6">
                        <Header />
                        <ErrorMessage error={error} />
                        <SelloDetailsForm currentItem={currentItem} setCurrentItem={setCurrentItem} editableSelloData={editableSelloData} gomaModel={gomaModel} setGomaModel={setGomaModel} />
                        <div className="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 mt-6">
                            <button onClick={handleAddToQuote} className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-bold py-4 px-6 rounded-xl hover:from-cyan-700 hover:to-blue-700 text-lg transition-all duration-200 shadow-[0_0_15px_rgba(34,211,238,0.3)] hover:shadow-[0_0_20px_rgba(34,211,238,0.5)] hover:-translate-y-1 flex items-center justify-center gap-2">
                                <i className="fas fa-plus-circle"></i> Agregar Artículo
                            </button>
                            <button onClick={handleClearForm} className="w-full md:w-1/3 bg-gray-700 text-white border border-gray-600 font-bold py-4 px-6 rounded-xl hover:bg-gray-600 transition-all duration-200 flex items-center justify-center gap-2 shadow-lg">
                                <i className="fas fa-eraser"></i> Limpiar
                            </button>
                        </div>
                        <AccesoriosSection currentAccesorios={currentAccesorios} setCurrentAccesorios={setCurrentAccesorios} />
                        <GlobalOptions globalOptions={globalOptions} setGlobalOptions={setGlobalOptions} />
                        <QuoteItemsList items={processedQuoteItems} removeItem={(index) => setQuoteItems(items => items.filter((_, i) => i !== index))} generateItemDescription={generateItemDescription} editableSelloData={editableSelloData} editableMaderaData={editableMaderaData} editableCyrelSheetCost={editableCyrelSheetCost} />
                        {processedQuoteItems.length > 0 && <TotalSummary items={processedQuoteItems} />}
                        {processedQuoteItems.length > 0 && <SimplifiedSummary generateSimplifiedSummaryText={generateSimplifiedSummaryText} copyToClipboard={copyToClipboard} copiedMessage={copiedMessage} handleClearQuote={handleClearQuote} />}
                        <MaterialCosts
                            editableSelloData={editableSelloData} setEditableSelloData={setEditableSelloData}
                            editableMaderaData={editableMaderaData} setEditableMaderaData={setEditableMaderaData}
                            editableCyrelSheetCost={editableCyrelSheetCost} setEditableCyrelSheetCost={setEditableCyrelSheetCost}
                            editableDisenoCost={editableDisenoCost} setEditableDisenoCost={setEditableDisenoCost}
                            editableSavedDisenoCost={editableSavedDisenoCost} setEditableSavedDisenoCost={setEditableSavedDisenoCost}
                            editableAutoGomaFabricationCost={editableAutoGomaFabricationCost} setEditableAutoGomaFabricationCost={setEditableAutoGomaFabricationCost}
                        />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- Botón Flotante de Regreso al Menú -->
    <a href="index.html" class="btn-home-flotante" title="Volver al Menú Principal">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span>Volver al Menú</span>
    </a>

    <style>
        .btn-home-flotante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #06b6d4;
            /* Cyan 500 */
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 1000;
            border: 2px solid #22d3ee;
        }

        .btn-home-flotante:hover {
            background-color: #0891b2;
            /* Cyan 600 */
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(6, 182, 212, 0.6);
        }
    </style>
</body>

</html>
</body>

</html>
