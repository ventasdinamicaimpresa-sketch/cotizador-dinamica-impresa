<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de Imprenta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F9FF;
            /* Un azul claro vibrante para el fondo general */
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #1F2937;
            /* Color de texto más oscuro para contraste */
        }

        .input-group select,
        .input-group input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #93C5FD;
            /* Borde azul más claro */
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            background-color: #DBEAFE;
            /* Fondo azul claro para los campos */
            color: #1F2937;
        }

        /* Estilo para el grupo de entrada con error */
        .input-group.input-error {
            border: 2px solid #EF4444;
            /* Borde rojo más grueso para el grupo */
            border-radius: 0.5rem;
            /* Asegura que el radio coincida con los elementos internos si es necesario */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
            /* Sombra roja */
            padding: 0.5rem;
            /* Añade un poco de padding para que el borde no se superponga al contenido */
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            border-bottom: 2px solid #1F2937;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .result-card {
            background-color: #EEF2FF;
            /* Un color ligeramente diferente para la tarjeta de resultados */
            border: 1px solid #C7D2FE;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            text-align: center;
        }

        .result-price {
            font-size: 2.5rem;
            font-weight: 800;
            color: #16A34A;
            text-align: center;
            margin: 1rem 0;
        }

        .result-breakdown {
            margin-top: 1.5rem;
            border-top: 1px dashed #A78BFA;
            /* Borde punteado morado */
            padding-top: 1.5rem;
        }

        .result-breakdown p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .result-breakdown span {
            font-weight: 600;
        }

        .formula {
            font-size: 0.85rem;
            color: #6B7280;
            margin-left: 1rem;
            margin-bottom: 0.5rem;
        }

        .copy-text-container {
            background-color: #E0F2FE;
            /* Azul muy claro para el contenedor de texto de resumen */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            word-break: break-all;
            border: 1px solid #93C5FD;
        }

        .creator-info {
            color: #EF4444;
            /* Rojo vibrante para la información del creador */
            font-weight: 600;
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.95rem;
        }

        .cost-details-section {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }

        .cost-details-section summary {
            font-weight: 600;
            cursor: pointer;
            padding: 0.5rem 0;
            color: #2563EB;
            /* Azul para el resumen */
            list-style: none;
            /* Elimina la flecha predeterminada */
            display: flex;
            align-items: center;
        }

        .cost-details-section summary::-webkit-details-marker {
            display: none;
            /* Oculta el marcador en Webkit */
        }

        .cost-details-section summary::before {
            content: '+';
            /* Símbolo para cerrado */
            font-weight: bold;
            margin-right: 0.5rem;
            transition: transform 0.2s ease-in-out;
            transform: rotate(0deg);
        }

        .cost-details-section[open] summary::before {
            content: '-';
            /* Símbolo para abierto */
            transform: rotate(90deg);
        }

        .cost-details-content p {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Alinea verticalmente el texto y el input */
            padding: 0.2rem 0;
            border-bottom: 1px dotted #E5E7EB;
        }

        .cost-details-content p:last-child {
            border-bottom: none;
        }

        .cost-details-content input[type="number"] {
            width: 80px;
            /* Ancho fijo para los inputs de costo */
            padding: 0.25rem 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            text-align: right;
            margin-left: 0.5rem;
        }

        /* Estilos para el nuevo botón maestro de consulta de costos */
        .master-cost-details-section {
            background-color: #E0F2FE;
            /* Un azul muy claro para el contenedor principal de la consulta */
            border: 1px solid #93C5FD;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .master-cost-details-section summary {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1E40AF;
            /* Azul oscuro para el título principal */
            cursor: pointer;
            padding: 0.5rem 0;
            list-style: none;
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .master-cost-details-section summary::-webkit-details-marker {
            display: none;
        }

        .master-cost-details-section summary::before {
            content: '+';
            font-weight: bold;
            margin-right: 0.75rem;
            font-size: 1.25em;
            transition: transform 0.2s ease-in-out;
            transform: rotate(0deg);
        }

        .master-cost-details-section[open] summary::before {
            content: '-';
            transform: rotate(90deg);
        }

        .master-cost-details-content {
            padding-top: 1rem;
            border-top: 1px dashed #BFDBFE;
            /* Línea punteada azul claro */
        }

        .offset-recommendation {
            color: #EF4444;
            /* Rojo vibrante */
            font-weight: 600;
            text-align: center;
            margin-top: 1.5rem;
            font-size: 1.1rem;
            border-top: 2px dashed #EF4444;
            padding-top: 1rem;
        }

        /* Estilo para el mensaje de alerta personalizado */
        #customAlert {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background-color: #EF4444;
            /* bg-red-500 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1000;
            /* Asegura que esté por encima de otros elementos */
            font-weight: 500;
            max-width: 300px;
            text-align: center;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Cotizador de Notas de Remisión</h1>
            <p class="text-gray-500 mt-2">Completa los campos para obtener un precio estimado.</p>
            <!-- Información del creador agregada aquí -->
            <div class="creator-info">
                Creado por Joel Adrian Mtz Meza, whats 8341446103
            </div>
        </div>

        <form id="cotizadorForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">

            <!-- SECCIÓN 1: INFORMACIÓN BÁSICA -->
            <fieldset class="md:col-span-2 border-t pt-6">
                <legend class="section-title">1. Información Básica</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="cantidad">Cantidad de Notas</label>
                        <input type="number" id="cantidad" placeholder="Escribe cantidad solicitada" min="1" required>
                    </div>
                    <div class="input-group">
                        <label for="tamano">Tamaño</label>
                        <select id="tamano">
                            <option value="" disabled selected>Selecciona el tamaño</option>
                            <option value="carta">Carta</option>
                            <option value="media_carta">1/2 Carta</option>
                            <option value="tercio_carta">1/3 Carta</option>
                            <option value="cuarto_carta">1/4 Carta</option>
                            <option value="oficio">Oficio</option>
                            <option value="media_oficio">1/2 Oficio</option>
                            <option value="tercio_oficio">1/3 Oficio</option>
                            <option value="cuarto_oficio">1/4 Oficio</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- SECCIÓN 2: TIPO DE PAPEL -->
            <fieldset class="md:col-span-2 border-t pt-6">
                <legend class="section-title">2. Tipo de Papel</legend>
                <div class="input-group">
                    <label>¿Lleva copias (Papel Autocopia)?</label>
                    <div class="flex items-center space-x-4" id="tipoPapelRadios">
                        <!-- Ninguno seleccionado por defecto -->
                        <input type="radio" id="conCopia" name="tipoPapel" value="autocopia">
                        <label for="conCopia">Sí</label>
                        <input type="radio" id="sinCopia" name="tipoPapel" value="simple">
                        <label for="sinCopia">No</label>
                    </div>
                    <p id="tipoPapelError" class="text-red-500 text-sm mt-1 hidden">Por favor, selecciona una opción
                        para el tipo de papel.</p>
                </div>

                <!-- Opciones para Papel Autocopia -->
                <div id="opcionesAutocopia" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="numCopias">Número de Copias (además del original)</label>
                        <input type="number" id="numCopias" placeholder="¿Cuántas copias?" min="0">
                    </div>
                    <div id="coloresCopiasContainer" class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Los selectores de color se generarán aquí -->
                    </div>
                </div>

                <!-- Opciones para Papel Simple -->
                <div id="opcionesSimple" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="papelSimple">Tipo de Papel</label>
                        <select id="papelSimple">
                            <option value="" disabled selected>Selecciona el tipo de papel</option>
                            <option value="bond75">Bond 75gr</option>
                            <option value="bond90">Bond 90gr</option>
                            <option value="bristol180">Bristol 180gr</option>
                            <option value="seguridadHoops">Seguridad Hoops</option>
                            <option value="seguridadOaktree">Seguridad Oaktree</option>
                            <option value="opalina">Opalina 120gr</option> <!-- Nueva opción con 120gr -->
                        </select>
                    </div>
                    <div id="colorOaktreeContainer" class="input-group hidden">
                        <label for="colorOaktree">Color Papel Oaktree</label>
                        <select id="colorOaktree">
                            <option value="" disabled selected>Selecciona el color</option>
                            <option value="amarillo_claro">Amarillo Claro</option>
                            <option value="oro">Oro</option>
                            <option value="verde_claro">Verde Claro</option>
                            <option value="verde_oscuro">Verde Oscuro</option>
                            <option value="azul_claro">Azul Claro</option>
                            <option value="azul_oscuro">Azul Oscuro</option>
                            <option value="rosa">Rosa</option>
                            <option value="gris">Gris</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- SECCIÓN 3: ACABADOS Y DISEÑO -->
            <fieldset class="md:col-span-2 border-t pt-6">
                <legend class="section-title">3. Acabados y Diseño</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label for="folio">¿Lleva Folio?</label>
                        <select id="folio">
                            <option value="" disabled selected>Selecciona la opción</option>
                            <option value="no">No</option>
                            <option value="si">Sí</option>
                        </select>
                    </div>
                    <div id="folioColorContainer" class="input-group hidden">
                        <label for="folioColor">Color del Folio</label>
                        <select id="folioColor">
                            <option value="" disabled selected>Selecciona el color</option>
                            <option value="negro">Negro</option>
                            <option value="rojo">Rojo</option>
                            <option value="otro">Otro Color</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="impresion">Tipo de Impresión</label>
                        <select id="impresion">
                            <option value="" disabled selected>Selecciona la impresión</option>
                            <option value="bw">Blanco y Negro</option>
                            <option value="color1">1 Color Específico</option>
                            <option value="color2">2 Colores Específicos</option>
                            <option value="cmyk">Selección de Color (CMYK)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="diseno">Diseño</label>
                        <select id="diseno">
                            <option value="" disabled selected>Selecciona tipo de diseño</option>
                            <option value="cliente">Cliente envía diseño</option>
                            <option value="guardado">Diseño guardado aquí</option>
                            <option value="nuevo">Realizar diseño</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <div class="md:col-span-2 mt-6">
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 text-lg">
                    Calcular Cotización
                </button>
            </div>
        </form>

        <div id="resultado" class="hidden"></div>

        <!-- Botón LIMPIAR CAMPOS movido fuera del formulario y con estilo grande -->
        <div class="md:col-span-2 mt-6">
            <button type="button" id="limpiarCamposBtn"
                class="w-full bg-red-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-red-700 transition-colors duration-300 text-xl">
                LIMPIAR CAMPOS
            </button>
        </div>

        <!-- Sección de Consulta de Costos MAESTRA -->
        <div class="md:col-span-2 master-cost-details-section">
            <details id="masterCostDetails">
                <summary>Consulta y Edición de Costos Base</summary>
                <div class="master-cost-details-content">
                    <p class="text-gray-600 mb-4">Modifica los valores en los campos de la derecha. Deja un campo vacío
                        para usar el costo predefinido.</p>

                    <!-- Contenedores para la generación dinámica de costos -->
                    <details class="cost-details-section">
                        <summary class="text-lg text-orange-600">Costos de Papel</summary>
                        <div id="papelCostDetails" class="cost-details-content pt-2">
                            <!-- Contenido de costos de papel se generará aquí -->
                        </div>
                    </details>

                    <details class="cost-details-section mt-4">
                        <summary class="text-lg text-blue-600">Costos de Impresión</summary>
                        <div id="impresionCostDetails" class="cost-details-content pt-2">
                            <!-- Contenido de costos de impresión se generará aquí -->
                        </div>
                    </details>

                    <details class="cost-details-section mt-4">
                        <summary class="text-lg text-purple-600">Costos de Acabados</summary>
                        <div id="acabadosCostDetails" class="cost-details-content pt-2">
                            <!-- Contenido de costos de acabados se generará aquí -->
                        </div>
                    </details>

                    <details class="cost-details-section mt-4">
                        <summary class="text-lg text-green-600">Costos de Diseño</summary>
                        <div id="disenoCostDetails" class="cost-details-content pt-2">
                            <!-- Contenido de costos de diseño se generará aquí -->
                        </div>
                    </details>

                    <button type="button" id="updateCostsBtn"
                        class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg mt-6 hover:bg-indigo-700 transition-colors duration-300 text-lg">
                        Actualizar Costos Manuales y Recalcular
                    </button>
                    <button type="button" id="clearManualCostsBtn"
                        class="w-full bg-gray-400 text-white font-bold py-3 px-6 rounded-lg mt-2 hover:bg-gray-500 transition-colors duration-300 text-lg">
                        Borrar Ajustes Manuales
                    </button>
                </div>
            </details>
        </div>
    </div>

    <!-- Custom Alert Message Box -->
    <div id="customAlert" class="hidden"></div>

    <script>
        // --- CONFIGURACIÓN CENTRALIZADA DE COSTOS ---
        const APP_COST_CONFIG = {
            papel: {
                carta: {
                    autocopia_original: 0.43,
                    autocopia_final: 0.48,
                    autocopia_intermedio: 0.40,
                    bond75: 0.20,
                    bond90: 0.20,
                    bristol180: 1.21,
                    seguridadHoops: 0.52,
                    seguridadOaktree: 0.75,
                    opalina: 0.49 // Nuevo costo Opalina Carta
                },
                oficio: {
                    autocopia_original: 0.43,
                    autocopia_final: 0.48,
                    autocopia_intermedio: 0.40,
                    bond75: 0.21,
                    bond90: 0.25,
                    bristol180: 1.21,
                    seguridadHoops: 0.69,
                    seguridadOaktree: 1.00,
                    opalina: 0.64 // Nuevo costo Opalina Oficio
                }
            },
            impresionDigital: {
                bn: [
                    { min: 1, max: 50, carta: 0.8, oficio: 0.85 },
                    { min: 51, max: 100, carta: 0.78, oficio: 0.83 },
                    { min: 101, max: 150, carta: 0.78, oficio: 0.8 },
                    { min: 151, max: 200, carta: 0.7, oficio: 0.78 },
                    { min: 201, max: 500, carta: 0.68, oficio: 0.75 },
                    { min: 501, max: 1000, carta: 0.65, oficio: 0.7 }
                ],
                color: [
                    { min: 1, max: 50, carta: 6.04, oficio: 6.5 },
                    { min: 51, max: 100, carta: 6, oficio: 6.3 },
                    { min: 101, max: 150, carta: 5.85, oficio: 6 },
                    { min: 151, max: 200, carta: 5.7, oficio: 5.85 },
                    { min: 201, max: 500, carta: 5.5, oficio: 5.6 },
                    { min: 501, max: 1000, carta: 5.4, oficio: 5.45 }
                ]
            },
            acabadosDigital: {
                corte_2_div: 100, // 1/2 Carta/Oficio
                corte_3_div: 120, // 1/3 Carta/Oficio
                corte_4_div: 125, // 1/4 Carta/Oficio
                pegado: 85,
                compaginado_autocopia: 80, // Costo por servicio
                // folio_acabado_millar: 200 // Eliminado de aquí
            },
            servicios: {
                diseno_cliente: 60,
                diseno_guardado: 150,
                diseno_nuevo: 215.52,
                folio_por_diseno_cliente_guardado: 150 // Nuevo costo para folio cuando diseño es cliente/guardado
            }
        };

        // Objeto global para almacenar los ajustes manuales de costos individuales
        let individualCostOverrides = {};

        // Función para obtener un valor de costo de APP_COST_CONFIG
        function getBaseCostValue(path) {
            let value = APP_COST_CONFIG;
            const parts = path.split('.');
            for (let i = 0; i < parts.length; i++) {
                let part = parts[i];
                const arrayMatch = part.match(/(\w+)\[(\d+)\]/); // Check for array index pattern
                if (arrayMatch) {
                    const arrayName = arrayMatch[1];
                    const index = parseInt(arrayMatch[2], 10);
                    if (value && value[arrayName] !== undefined && Array.isArray(value[arrayName]) && value[arrayName][index] !== undefined) {
                        value = value[arrayName][index];
                    } else {
                        console.warn(`Path de costo '${path}' (parte array '${part}') no encontrado en APP_COST_CONFIG.`);
                        return undefined;
                    }
                } else {
                    if (value && value[part] !== undefined) {
                        value = value[part];
                    } else {
                        console.warn(`Path de costo '${path}' (parte '${part}') no encontrado en APP_COST_CONFIG.`);
                        return undefined;
                    }
                }
            }
            return value;
        }


        // Función para obtener un costo efectivo (con override si existe)
        function getEffectiveCostValue(path) {
            const overrideKey = `manual_${path.replace(/\./g, '_').replace(/\[/g, '__').replace(/\]/g, '')}`; // e.g., "manual_impresionDigital_bn__0__carta"
            if (individualCostOverrides[overrideKey] !== undefined && individualCostOverrides[overrideKey] !== null) {
                return individualCostOverrides[overrideKey];
            }
            return getBaseCostValue(path);
        }

        // Función para formatear valores a moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
        }

        // Function to show a custom alert message
        let customAlertTimeout; // To store the timeout ID
        function showCustomAlert(message) {
            const customAlert = document.getElementById('customAlert');
            customAlert.textContent = message;
            customAlert.classList.remove('hidden');

            // Clear any existing timeout to prevent multiple alerts from hiding too soon
            clearTimeout(customAlertTimeout);

            // Hide after a few seconds
            customAlertTimeout = setTimeout(() => {
                customAlert.classList.add('hidden');
            }, 5000);
        }

        // --- Funciones de validación visual (movidas al ámbito global) ---
        function markFieldError(element) {
            // Find the closest parent .input-group
            let parentGroup = element.closest('.input-group');
            if (parentGroup) {
                parentGroup.classList.add('input-error');
            } else if (element) {
                // Fallback if not inside an input-group, apply directly to the element
                element.classList.add('input-error');
            }
        }

        function clearFieldError(element) {
            let parentGroup = element.closest('.input-group');
            if (parentGroup) {
                parentGroup.classList.remove('input-error');
            } else if (element) {
                // Fallback
                element.classList.remove('input-error');
            }
        }

        function clearAllFieldErrors() {
            // Clear errors on input-group elements
            document.querySelectorAll('.input-group.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
            // Clear any potential direct errors on inputs/selects not inside a recognized input-group
            document.querySelectorAll('input.input-error, select.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
            // Also hide the specific radio button error message
            document.getElementById('tipoPapelError').classList.add('hidden');
        }

        // --- MOTOR DE CÁLCULO (movido al ámbito global) ---
        function calcularCotizacion() {
            clearAllFieldErrors(); // Limpiar errores visuales al inicio de cada cálculo
            let isValid = true; // Bandera para rastrear la validez del formulario

            // 1. Recopilar datos del formulario
            const cantidad = parseInt(document.getElementById('cantidad').value);
            const tamano = document.getElementById('tamano').value;
            const conCopiaRadio = document.getElementById('conCopia');
            const sinCopiaRadio = document.getElementById('sinCopia');
            const esAutocopia = conCopiaRadio.checked;
            const numCopias = esAutocopia ? parseInt(document.getElementById('numCopias').value) : 0;
            const papelSimple = document.getElementById('papelSimple').value;
            const llevaFolio = document.getElementById('folio').value === 'si';
            const folioColor = document.getElementById('folioColor').value;
            const impresion = document.getElementById('impresion').value;
            const diseno = document.getElementById('diseno').value;

            // Validación de campos y marcaje de errores
            if (isNaN(cantidad) || cantidad <= 0) {
                markFieldError(document.getElementById('cantidad'));
                isValid = false;
            }
            if (!tamano) {
                markFieldError(document.getElementById('tamano'));
                isValid = false;
            }
            // Check if any radio button for tipoPapel is selected
            const tipoPapelSelected = document.querySelector('input[name="tipoPapel"]:checked');
            const tipoPapelError = document.getElementById('tipoPapelError');
            if (!tipoPapelSelected) {
                markFieldError(document.getElementById('tipoPapelRadios')); // Marca el contenedor de los radios
                tipoPapelError.classList.remove('hidden'); // Show inline error
                isValid = false;
            } else {
                tipoPapelError.classList.add('hidden'); // Hide inline error if valid
            }

            if (esAutocopia) {
                if (isNaN(numCopias) || numCopias < 0) {
                    markFieldError(document.getElementById('numCopias'));
                    isValid = false;
                }
                const coloresCopiasGenerados = document.querySelectorAll('#coloresCopiasContainer select');
                for (let i = 0; i < coloresCopiasGenerados.length; i++) {
                    if (!coloresCopiasGenerados[i].value) {
                        markFieldError(coloresCopiasGenerados[i]);
                        isValid = false;
                    }
                }
            } else if (!papelSimple) {
                markFieldError(document.getElementById('papelSimple'));
                isValid = false;
            }
            if (papelSimple === 'seguridadOaktree' && document.getElementById('colorOaktreeContainer').classList.contains('hidden') === false && !document.getElementById('colorOaktree').value) {
                markFieldError(document.getElementById('colorOaktree'));
                isValid = false;
            }

            if (!document.getElementById('folio').value) {
                markFieldError(document.getElementById('folio'));
                isValid = false;
            }
            if (llevaFolio && !folioColor) {
                markFieldError(document.getElementById('folioColor'));
                isValid = false;
            }
            if (!document.getElementById('impresion').value) {
                markFieldError(document.getElementById('impresion'));
                isValid = false;
            }
            if (!document.getElementById('diseno').value) {
                markFieldError(document.getElementById('diseno'));
                isValid = false;
            }

            if (!isValid) {
                showCustomAlert('Por favor, completa todos los campos resaltados en rojo.');
                return false; // Indicar que la validación falló
            }

            // 2. Cálculos iniciales
            const basePapel = tamano.includes('oficio') ? 'oficio' : 'carta';
            const factorDivision = {
                carta: 1, media_carta: 2, tercio_carta: 3, cuarto_carta: 4,
                oficio: 1, media_oficio: 2, tercio_oficio: 3, cuarto_oficio: 4
            }[tamano];

            const hojasRequeridasCliente = Math.ceil(cantidad / factorDivision);
            const numPartes = esAutocopia ? 1 + numCopias : 1;

            // Todas las cotizaciones ahora se hacen con el método Digital
            const resultado = calcularDigital(cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, folioColor, impresion, diseno, basePapel, factorDivision, hojasRequeridasCliente, numPartes);

            // 3. Mostrar resultado
            mostrarResultado(resultado, { cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, folioColor, impresion, diseno, hojasRequeridasCliente }); // Pasa hojasRequeridasCliente
            return true; // Indicar que la cotización se realizó con éxito
        }

        // Función para obtener el texto descriptivo del tipo de papel (para resumen)
        function getTipoPapelText(esAutocopia, numCopias, papelSimple) {
            if (esAutocopia) {
                return `Autocopia (${1 + numCopias} partes)`;
            } else {
                const papelSelect = document.getElementById('papelSimple');
                // Retorna el texto visible del option seleccionado
                return papelSelect.options[papelSelect.selectedIndex].text;
            }
        }

        // Función para obtener el texto descriptivo del tipo de impresión (para resumen)
        function getImpresionText(impresionValue) {
            const impresionSelect = document.getElementById('impresion');
            return impresionSelect.options[impresionSelect.selectedIndex].text;
        }

        // Función para obtener el texto descriptivo del diseño (para resumen)
        function getDisenoText(disenoValue) {
            const disenoSelect = document.getElementById('diseno');
            return disenoSelect.options[disenoSelect.selectedIndex].text;
        }

        // Función para construir el texto de resumen para el cliente
        function getSummaryText(res, params) {
            const { cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, impresion, diseno, factorDivision } = params;

            let summary = `${cantidad} Notas `;
            summary += `tamaño ${document.getElementById('tamano').options[document.getElementById('tamano').selectedIndex].text} `;
            // Usa la función getTipoPapelText para el resumen
            summary += `en papel ${getTipoPapelText(esAutocopia, numCopias, papelSimple)} `;

            if (llevaFolio) {
                summary += `con Folio `;
            }

            const acabadosParts = [];
            let isCortadas = false;
            let isPegadas = false;
            let isCompaginadas = false;

            if (factorDivision > 1) {
                isCortadas = true;
            }
            if (esAutocopia) {
                isCompaginadas = true;
            }
            // Para el método Digital, el pegado aplica si las notas son cortadas (implica que se forman blocs)
            if (isCortadas) {
                isPegadas = true;
            }

            if (isCortadas && isPegadas) {
                acabadosParts.push('cortadas y pegadas');
            } else if (isCortadas) {
                acabadosParts.push('cortadas');
            } else if (isPegadas) {
                acabadosParts.push('pegadas');
            }

            if (isCompaginadas) {
                acabadosParts.push('compaginadas');
            }

            let acabadosStr = '';
            if (acabadosParts.length > 0) {
                acabadosStr = acabadosParts.join(', ');
            }

            if (acabadosStr) {
                summary += `con impresión ${getImpresionText(impresion)}, ${acabadosStr}, `;
            } else {
                summary += `con impresión ${getImpresionText(impresion)}, `;
            }

            summary += `${getDisenoText(diseno)}, `;

            summary += `Precio Unitario sin IVA: ${formatCurrency(res.precioUnitarioSinIVA)} $, `;
            summary += `TOTAL neto: ${formatCurrency(res.total)}. `;
            summary += `Método de impresión: Impresión Digital.`;

            return summary;
        }

        // Función para mostrar los resultados en la UI
        function mostrarResultado(res, params) {
            const resultadoDiv = document.getElementById('resultado');
            if (!res) { // Si no hay resultado (por ejemplo, al limpiar campos), ocultar y resetear
                resultadoDiv.classList.add('hidden');
                return;
            }

            resultadoDiv.classList.remove('hidden');

            // Desglose de costos detallado
            let breakdownHtml = `
                <p>Método de Producción: <span>Impresión Digital</span></p>
                <hr class="my-2 border-gray-300">

                <h3 class="text-md font-semibold mt-4 mb-2 text-gray-700">Detalle de Papel:</h3>
                <p>Costo de Papel: <span>${formatCurrency(res.costos.papel)}</span></p>
                <p class="formula">Fórmula: ${res.papelFormula}</p>
                
                <h3 class="text-md font-semibold mt-4 mb-2 text-gray-700">Detalle de Impresión:</h3>
                <p>Costo de Impresión: <span>${formatCurrency(res.costos.impresion)}</span></p>
                <p class="formula">Fórmula: ${res.impresionFormula}</p>
                
                <h3 class="text-md font-semibold mt-4 mb-2 text-gray-700">Detalle de Acabados:</h3>
                <p>Costos de Acabados: <span>${formatCurrency(res.costos.acabados)}</span></p>
                <p class="formula">Fórmula: ${res.acabadosFormula}</p>

                <h3 class="text-md font-semibold mt-4 mb-2 text-gray-700">Detalle de Servicios:</h3>
                <p>Costo de Servicios: <span>${formatCurrency(res.costos.servicios)}</span></p>
                <p class="formula">Fórmula: ${res.serviciosFormula}</p>
                
                <hr class="my-4 border-gray-300">
                <p class="font-bold">Subtotal (sin utilidad ni IVA): <span>${formatCurrency(res.subtotalBase)}</span></p>
            `;

            breakdownHtml += `
                <p class="font-bold">IVA (16%): <span>${formatCurrency(res.iva)}</span></p>
                <hr class="my-2 border-gray-300">
                <p class="font-bold text-lg text-gray-700">Precio Unitario sin IVA: <span>${formatCurrency(res.precioUnitarioSinIVA)}</span></p>
                <p class="font-bold text-2xl text-green-700">TOTAL: <span>${formatCurrency(res.total)}</span></p>
            `;

            resultadoDiv.innerHTML = `
                <div class="result-card">
                    <h2 class="result-title">Cotización Estimada</h2>
                    <p class="result-price">${formatCurrency(res.total)}</p>
                    <div class="result-breakdown">
                        <h3 class="text-lg font-semibold mb-2 text-center text-gray-700">Desglose de Costos</h3>
                        ${breakdownHtml}
                    </div>
                    <div class="copy-text-container">
                        <p class="text-gray-800 font-medium">Texto para Cliente:</p>
                        <p id="clientSummaryText" class="text-gray-600 mt-1">${getSummaryText(res, { ...params, factorDivision: res.factorDivision })}</p>
                        <button class="mt-2 w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300 transition-colors" onclick="copyToClipboard('clientSummaryText')">
                            Copiar al Portapapeles
                        </button>
                    </div>
                    ${params.hojasRequeridasCliente > 250 ? '<p class="offset-recommendation">¡Importante! Para esta cantidad, se recomienda cotizar en Offset.</p>' : ''}
                </div>
            `;
            resultadoDiv.scrollIntoView({ behavior: 'smooth' });

        }

        // Función para copiar texto al portapapeles
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges();
            showCustomAlert('Texto copiado al portapapeles!');
        }

        // --- LÓGICA DE COTIZACIÓN DIGITAL ---
        function calcularDigital(cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, folioColor, impresion, diseno, basePapel, factorDivision, hojasRequeridasCliente, numPartes) {
            const costos = { papel: 0, impresion: 0, acabados: 0, servicios: 0 };
            let papelFormula = '';
            let impresionFormula = '';
            let acabadosFormula = '';
            let serviciosFormula = '';

            const tamanoDisplayName = document.getElementById('tamano').options[document.getElementById('tamano').selectedIndex].text;
            const hojasRequeridasFormula = `(Cantidad de Notas (${cantidad}) / Factor de División por tamaño (${factorDivision})) = ${hojasRequeridasCliente} hojas de cliente. `;

            // --- Costo Papel ---
            if (esAutocopia) {
                const costoOriginal = getEffectiveCostValue(`papel.${basePapel}.autocopia_original`);
                const costoFinal = getEffectiveCostValue(`papel.${basePapel}.autocopia_final`);
                const costoIntermedio = getEffectiveCostValue(`papel.${basePapel}.autocopia_intermedio`);

                let costoBasePapelCalculado = 0;
                costoBasePapelCalculado += hojasRequeridasCliente * costoOriginal;
                costoBasePapelCalculado += hojasRequeridasCliente * costoFinal;
                papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoOriginal.toFixed(2)}/hoja original) + `;
                papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoFinal.toFixed(2)}/hoja final) `;

                if (numCopias > 1) {
                    costoBasePapelCalculado += hojasRequeridasCliente * (numCopias - 1) * costoIntermedio;
                    papelFormula += `+ (${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${numCopias - 1} copias intermedias x ${costoIntermedio.toFixed(2)}/hoja)`;
                }
                costos.papel = costoBasePapelCalculado * 2;
                papelFormula = hojasRequeridasFormula + `(${papelFormula}) * 2 (utilidad del papel)`;
            } else {
                const papelSimpleDisplayName = document.getElementById('papelSimple').options[document.getElementById('papelSimple').selectedIndex].text;

                // Condición para el papel Opalina
                if (papelSimple === 'opalina') {
                    const costoUnitarioOpalina = getEffectiveCostValue(`papel.${basePapel}.opalina`);
                    let costoBasePapelCalculado = hojasRequeridasCliente * costoUnitarioOpalina;
                    papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoUnitarioOpalina.toFixed(2)}/hoja de ${papelSimpleDisplayName})`;
                    costos.papel = costoBasePapelCalculado * 2;
                    papelFormula = hojasRequeridasFormula + `(${papelFormula}) * 2 (utilidad del papel)`;
                } else if (papelSimple.startsWith('bond')) {
                    costos.papel = 0;
                    papelFormula = hojasRequeridasFormula + `Costo de papel Bond (${papelSimpleDisplayName}) incluido en impresión digital. Utilidad del papel ya aplicada.`;
                } else {
                    const costoUnitarioPapelSimple = getEffectiveCostValue(`papel.${basePapel}.${papelSimple}`);
                    let costoBasePapelCalculado = hojasRequeridasCliente * costoUnitarioPapelSimple;
                    papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoUnitarioPapelSimple.toFixed(2)}/hoja de ${papelSimpleDisplayName})`;
                    costos.papel = costoBasePapelCalculado * 2;
                    papelFormula = hojasRequeridasFormula + `(${papelFormula}) * 2 (utilidad del papel)`;
                }
            }

            // --- Costo Impresión (digital) ---
            let tarifaImpresion = 0;
            const esImpresionBN = impresion === 'bw';
            const folioCambiaColor = llevaFolio && (folioColor === 'rojo' || folioColor === 'otro');

            const currentImpresionType = (!esImpresionBN || folioCambiaColor) ? 'color' : 'bn'; // Determine if it's color or B/N based on selections
            const impressionRates = APP_COST_CONFIG.impresionDigital[currentImpresionType];

            // Find the correct rate based on quantity
            let foundRate = false;
            for (let i = 0; i < impressionRates.length; i++) {
                const rate = impressionRates[i];
                if (cantidad >= rate.min && cantidad <= rate.max) {
                    tarifaImpresion = getEffectiveCostValue(`impresionDigital.${currentImpresionType}[${i}].${basePapel}`);
                    impresionFormula += `Tarifa ${currentImpresionType.toUpperCase()} ${basePapel === 'carta' ? 'Carta' : 'Oficio'} (Cant: ${rate.min}-${rate.max}): ${tarifaImpresion.toFixed(2)}`;
                    foundRate = true;
                    break;
                }
            }
            // If quantity is above the last defined range, use the last rate
            if (!foundRate && cantidad > impressionRates[impressionRates.length - 1].max) {
                const lastRateIndex = impressionRates.length - 1;
                const lastRate = impressionRates[lastRateIndex];
                tarifaImpresion = getEffectiveCostValue(`impresionDigital.${currentImpresionType}[${lastRateIndex}].${basePapel}`);
                impresionFormula += `Tarifa ${currentImpresionType.toUpperCase()} ${basePapel === 'carta' ? 'Carta' : 'Oficio'} (Cant: >${lastRate.max}): ${tarifaImpresion.toFixed(2)}`;
            } else if (!foundRate) {
                // Fallback if no rate found (e.g., quantity is 0 or invalid)
                tarifaImpresion = 0;
                impresionFormula += `No se encontró tarifa de impresión para la cantidad y tipo de impresión seleccionados.`;
            }

            costos.impresion = (hojasRequeridasCliente * numPartes) * tarifaImpresion;
            impresionFormula = `(${hojasRequeridasCliente} cantidad de hojas x ${numPartes} partes) x (${impresionFormula}). `;
            if (esImpresionBN && folioCambiaColor) {
                impresionFormula += `(La impresión B/N se cotiza como Color debido al color de folio seleccionado).`;
            }


            // --- Costos Acabados (digital) ---
            let corteCosto = 0;
            acabadosFormula += 'Corte: ';
            if (factorDivision === 2) { corteCosto = getEffectiveCostValue('acabadosDigital.corte_2_div'); acabadosFormula += `${corteCosto} (1/2 Carta/Oficio) `; }
            if (factorDivision === 3) { corteCosto = getEffectiveCostValue('acabadosDigital.corte_3_div'); acabadosFormula += `${corteCosto} (1/3 Carta/Oficio) `; }
            if (factorDivision === 4) { corteCosto = getEffectiveCostValue('acabadosDigital.corte_4_div'); acabadosFormula += `${corteCosto} (1/4 Carta/Oficio) `; }
            costos.acabados += corteCosto;

            const pegadoCosto = getEffectiveCostValue('acabadosDigital.pegado');
            costos.acabados += pegadoCosto;
            acabadosFormula += `+ Pegado: ${pegadoCosto}`;

            if (esAutocopia) {
                const compaginadoCosto = getEffectiveCostValue('acabadosDigital.compaginado_autocopia');
                costos.acabados += compaginadoCosto;
                acabadosFormula += `+ Compaginado: ${compaginadoCosto}`;
            }

            // El costo del folio se mueve a la sección de servicios según el tipo de diseño

            // --- Costos Servicios (digital) ---
            serviciosFormula += 'Diseño: ';
            const disenoCosto = {
                cliente: getEffectiveCostValue('servicios.diseno_cliente'),
                guardado: getEffectiveCostValue('servicios.diseno_guardado'),
                nuevo: getEffectiveCostValue('servicios.diseno_nuevo')
            }[diseno];
            serviciosFormula += `${disenoCosto} (${getDisenoText(diseno)})`;
            costos.servicios += disenoCosto;

            if (llevaFolio) {
                if (diseno === 'cliente' || diseno === 'guardado') {
                    const folioServicioCosto = getEffectiveCostValue('servicios.folio_por_diseno_cliente_guardado');
                    costos.servicios += folioServicioCosto;
                    serviciosFormula += ` + Costo Folio: ${folioServicioCosto} (cuando diseño es cliente/guardado)`;
                } else if (diseno === 'nuevo') {
                    // No additional cost for folio if new design is being made, it's included in 'nuevo' design cost
                    serviciosFormula += ` (Folio incluido en costo de "Realizar diseño")`;
                }
            }


            const subtotalBase = costos.papel + costos.impresion + costos.acabados + costos.servicios;
            const subtotal = subtotalBase; // En digital, no hay utilidad antes del IVA
            const iva = subtotal * 0.16;
            const total = subtotal + iva;
            const precioUnitarioSinIVA = subtotal / cantidad;

            return {
                metodo: 'Digital',
                costos,
                subtotalBase,
                subtotal,
                iva,
                total,
                precioUnitarioSinIVA,
                papelFormula,
                impresionFormula,
                acabadosFormula,
                serviciosFormula,
                factorDivision
            };
        }

        // --- LÓGICA DE LA INTERFAZ ---
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('cotizadorForm');

            // Elementos del DOM del formulario
            const cantidadInput = document.getElementById('cantidad');
            const tamanoSelect = document.getElementById('tamano');
            const conCopiaRadio = document.getElementById('conCopia');
            const sinCopiaRadio = document.getElementById('sinCopia');
            const opcionesAutocopia = document.getElementById('opcionesAutocopia');
            const opcionesSimple = document.getElementById('opcionesSimple');
            const papelSimpleSelect = document.getElementById('papelSimple');
            const colorOaktreeContainer = document.getElementById('colorOaktreeContainer');
            const folioSelect = document.getElementById('folio');
            const folioColorContainer = document.getElementById('folioColorContainer');
            const numCopiasInput = document.getElementById('numCopias');
            const coloresCopiasContainer = document.getElementById('coloresCopiasContainer');
            const impresionSelect = document.getElementById('impresion');
            const disenoSelect = document.getElementById('diseno');
            const limpiarCamposBtn = document.getElementById('limpiarCamposBtn');

            // Elementos para el control maestro de costos
            const masterCostDetails = document.getElementById('masterCostDetails');
            const updateCostsBtn = document.getElementById('updateCostsBtn');
            const clearManualCostsBtn = document.getElementById('clearManualCostsBtn');


            // --- Funciones de UI ---

            // Función para actualizar visibilidad de opciones de papel
            function actualizarOpcionesPapel() {
                // Clear errors on related fields when changing selection
                clearFieldError(conCopiaRadio); // Clear error on the radio container
                clearFieldError(sinCopiaRadio);
                clearFieldError(numCopiasInput);
                clearFieldError(papelSimpleSelect);
                clearFieldError(document.getElementById('colorOaktree'));

                // Ocultar el mensaje de error de radio específico
                document.getElementById('tipoPapelError').classList.add('hidden');

                if (conCopiaRadio.checked) {
                    opcionesAutocopia.style.display = 'grid'; // Control directo del display
                    opcionesSimple.style.display = 'none';    // Control directo del display
                    actualizarColoresCopias();
                } else if (sinCopiaRadio.checked) {
                    opcionesAutocopia.style.display = 'none';    // Control directo del display
                    opcionesSimple.style.display = 'grid'; // Control directo del display
                } else { // Ni "Sí" ni "No" están seleccionados
                    opcionesAutocopia.style.display = 'none';
                    opcionesSimple.style.display = 'none';
                }
                actualizarColorOaktree(); // Llamar después de actualizar visibilidad de opcionesSimple
            }

            // Función para actualizar visibilidad de color Oaktree
            function actualizarColorOaktree() {
                clearFieldError(papelSimpleSelect);
                clearFieldError(document.getElementById('colorOaktree'));

                // Solo mostrar si papelSimpleSelect.value es 'seguridadOaktree' Y opcionesSimple está visible
                if (papelSimpleSelect.value === 'seguridadOaktree' && opcionesSimple.style.display === 'grid') {
                    colorOaktreeContainer.classList.remove('hidden');
                } else {
                    colorOaktreeContainer.classList.add('hidden');
                }
            }

            // Función para actualizar visibilidad de color de folio
            function actualizarColorFolio() {
                clearFieldError(folioSelect);
                clearFieldError(document.getElementById('folioColor'));
                if (folioSelect.value === 'si') {
                    folioColorContainer.classList.remove('hidden');
                } else {
                    folioColorContainer.classList.add('hidden');
                }
            }

            // Función para generar selectores de color para copias
            function actualizarColoresCopias() {
                clearFieldError(numCopiasInput); // Clear error when number of copies changes
                coloresCopiasContainer.innerHTML = '';
                const copias = parseInt(numCopiasInput.value) || 0;
                // Solo generar si "Sí" está marcado y hay copias > 0
                if (copias <= 0 || !conCopiaRadio.checked) {
                    return;
                }

                const colores = ['Verde', 'Azul', 'Rosa', 'Amarillo'];

                // Copias intermedias
                for (let i = 1; i < copias; i++) {
                    const id = `intermedio_color_${i}`;
                    let html = `<div class="input-group"><label for="${id}">Color Intermedio ${i}</label><select id="${id}">`;
                    html += `<option value="" disabled selected>Selecciona el color</option>`;
                    colores.forEach(color => {
                        html += `<option value="${color.toLowerCase()}">${color}</option>`;
                    });
                    html += `</select></div>`;
                    coloresCopiasContainer.innerHTML += html;
                }

                // Copia final
                const idFinal = 'final_color';
                let htmlFinal = `<div class="input-group"><label for="${idFinal}">Color Copia Final</label><select id="${idFinal}">`;
                htmlFinal += `<option value="" disabled selected>Selecciona el color</option>`;
                colores.forEach(color => {
                    htmlFinal += `<option value="${color.toLowerCase()}">${color}</option>`;
                });
                htmlFinal += `</select></div>`;
                coloresCopiasContainer.innerHTML += htmlFinal;
            }

            // Función para limpiar todos los campos del formulario y ocultar el resultado
            function limpiarCampos() {
                cantidadInput.value = '';
                numCopiasInput.value = '';

                tamanoSelect.value = '';
                papelSimpleSelect.value = '';
                folioSelect.value = '';
                impresionSelect.value = '';
                disenoSelect.value = '';

                conCopiaRadio.checked = false;
                sinCopiaRadio.checked = false;

                document.getElementById('resultado').classList.add('hidden');
                colorOaktreeContainer.classList.add('hidden');
                folioColorContainer.classList.add('hidden');
                coloresCopiasContainer.innerHTML = '';

                clearAllFieldErrors(); // Clear all red borders
                clearIndividualCostOverrides(); // Llama a la nueva función de limpieza
                actualizarOpcionesPapel(); // Asegurar el estado inicial correcto al limpiar (ocultar todo)
            }

            // --- Event Listeners ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                clearAllFieldErrors(); // Clear previous errors before validating
                calcularCotizacion();
            });

            conCopiaRadio.addEventListener('change', actualizarOpcionesPapel);
            sinCopiaRadio.addEventListener('change', actualizarOpcionesPapel);
            papelSimpleSelect.addEventListener('change', actualizarColorOaktree);
            folioSelect.addEventListener('change', actualizarColorFolio);
            numCopiasInput.addEventListener('input', actualizarColoresCopias);

            // Add input/change listeners for immediate error clearing
            cantidadInput.addEventListener('input', () => clearFieldError(cantidadInput));
            tamanoSelect.addEventListener('change', () => clearFieldError(tamanoSelect));
            impresionSelect.addEventListener('change', () => clearFieldError(impresionSelect));
            disenoSelect.addEventListener('change', () => clearFieldError(disenoSelect));
            // Special handling for radios for immediate error clearing
            document.querySelectorAll('input[name="tipoPapel"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    clearFieldError(document.getElementById('tipoPapelRadios'));
                    document.getElementById('tipoPapelError').classList.add('hidden');
                });
            });


            limpiarCamposBtn.addEventListener('click', limpiarCampos);

            // Funciones para generar y mostrar los costos base con inputs de modificación
            function generateCostInputHtml(label, baseCost, path) {
                const overrideKey = `manual_${path.replace(/\./g, '_').replace(/\[/g, '__').replace(/\]/g, '')}`;
                const currentValue = individualCostOverrides[overrideKey] !== undefined && individualCostOverrides[overrideKey] !== null
                    ? individualCostOverrides[overrideKey]
                    : baseCost;
                return `<p>${label}: <span>${formatCurrency(baseCost)}</span> <input type="number" id="${overrideKey}" value="${currentValue}" placeholder="Nuevo" step="0.01" class="cost-input"></p>`;
            }

            function renderPapelCosts() {
                const papelDetails = document.getElementById('papelCostDetails');
                papelDetails.innerHTML = `
                    <h5 class="font-bold text-gray-700 mt-2">Papel Autocopia (Costo por Hoja)</h5>
                    ${generateCostInputHtml('Original (Carta)', APP_COST_CONFIG.papel.carta.autocopia_original, 'papel.carta.autocopia_original')}
                    ${generateCostInputHtml('Final (Carta)', APP_COST_CONFIG.papel.carta.autocopia_final, 'papel.carta.autocopia_final')}
                    ${generateCostInputHtml('Intermedio (Carta)', APP_COST_CONFIG.papel.carta.autocopia_intermedio, 'papel.carta.autocopia_intermedio')}
                    ${generateCostInputHtml('Original (Oficio)', APP_COST_CONFIG.papel.oficio.autocopia_original, 'papel.oficio.autocopia_original')}
                    ${generateCostInputHtml('Final (Oficio)', APP_COST_CONFIG.papel.oficio.autocopia_final, 'papel.oficio.autocopia_final')}
                    ${generateCostInputHtml('Intermedio (Oficio)', APP_COST_CONFIG.papel.oficio.autocopia_intermedio, 'papel.oficio.autocopia_intermedio')}

                    <h5 class="font-bold text-gray-700 mt-4">Papel Simple (Costo por Hoja)</h5>
                    ${generateCostInputHtml('Bond 75gr (Carta)', APP_COST_CONFIG.papel.carta.bond75, 'papel.carta.bond75')}
                    ${generateCostInputHtml('Bond 90gr (Carta)', APP_COST_CONFIG.papel.carta.bond90, 'papel.carta.bond90')}
                    ${generateCostInputHtml('Bristol 180gr (Carta)', APP_COST_CONFIG.papel.carta.bristol180, 'papel.carta.bristol180')}
                    ${generateCostInputHtml('Seguridad Hoops (Carta)', APP_COST_CONFIG.papel.carta.seguridadHoops, 'papel.carta.seguridadHoops')}
                    ${generateCostInputHtml('Seguridad Oaktree (Carta)', APP_COST_CONFIG.papel.carta.seguridadOaktree, 'papel.carta.seguridadOaktree')}
                    ${generateCostInputHtml('Opalina 120gr (Carta)', APP_COST_CONFIG.papel.carta.opalina, 'papel.carta.opalina')} <!-- Nuevo input para Opalina Carta -->

                    ${generateCostInputHtml('Bond 75gr (Oficio)', APP_COST_CONFIG.papel.oficio.bond75, 'papel.oficio.bond75')}
                    ${generateCostInputHtml('Bond 90gr (Oficio)', APP_COST_CONFIG.papel.oficio.bond90, 'papel.oficio.bond90')}
                    ${generateCostInputHtml('Bristol 180gr (Oficio)', APP_COST_CONFIG.papel.oficio.bristol180, 'papel.oficio.bristol180')}
                    ${generateCostInputHtml('Seguridad Hoops (Oficio)', APP_COST_CONFIG.papel.oficio.seguridadHoops, 'papel.oficio.seguridadHoops')}
                    ${generateCostInputHtml('Seguridad Oaktree (Oficio)', APP_COST_CONFIG.papel.oficio.seguridadOaktree, 'papel.oficio.seguridadOaktree')}
                    ${generateCostInputHtml('Opalina 120gr (Oficio)', APP_COST_CONFIG.papel.oficio.opalina, 'papel.oficio.opalina')} <!-- Nuevo input para Opalina Oficio -->
                `;
            }

            function renderImpresionCosts() {
                const impresionDetails = document.getElementById('impresionCostDetails');
                let htmlContent = `<h5 class="font-bold text-gray-700 mt-2">Tarifas de Impresión Digital por Cantidad (Costo por Hoja)</h5>`;

                // B/N rates
                htmlContent += `<h6 class="font-semibold text-gray-600 mt-3">Impresión en Blanco y Negro:</h6>`;
                APP_COST_CONFIG.impresionDigital.bn.forEach((rate, index) => {
                    const rangeLabel = `${rate.min}-${rate.max}`;
                    htmlContent += generateCostInputHtml(`B/N (Carta) ${rangeLabel}`, rate.carta, `impresionDigital.bn[${index}].carta`);
                    htmlContent += generateCostInputHtml(`B/N (Oficio) ${rangeLabel}`, rate.oficio, `impresionDigital.bn[${index}].oficio`);
                });

                // Color rates
                htmlContent += `<h6 class="font-semibold text-gray-600 mt-3">Impresión a Color:</h6>`;
                APP_COST_CONFIG.impresionDigital.color.forEach((rate, index) => {
                    const rangeLabel = `${rate.min}-${rate.max}`;
                    htmlContent += generateCostInputHtml(`Color (Carta) ${rangeLabel}`, rate.carta, `impresionDigital.color[${index}].carta`);
                    htmlContent += generateCostInputHtml(`Color (Oficio) ${rangeLabel}`, rate.oficio, `impresionDigital.color[${index}].oficio`);
                });
                impresionDetails.innerHTML = htmlContent;
            }

            function renderAcabadosCosts() {
                const acabadosDetails = document.getElementById('acabadosCostDetails');
                acabadosDetails.innerHTML = `
                    <h5 class="font-bold text-gray-700 mt-2">Cortes (Costo Fijo)</h5>
                    ${generateCostInputHtml('1/2 División', APP_COST_CONFIG.acabadosDigital.corte_2_div, 'acabadosDigital.corte_2_div')}
                    ${generateCostInputHtml('1/3 División', APP_COST_CONFIG.acabadosDigital.corte_3_div, 'acabadosDigital.corte_3_div')}
                    ${generateCostInputHtml('1/4 División', APP_COST_CONFIG.acabadosDigital.corte_4_div, 'acabadosDigital.corte_4_div')}

                    <h5 class="font-bold text-gray-700 mt-4">Otros Acabados</h5>
                    ${generateCostInputHtml('Pegado', APP_COST_CONFIG.acabadosDigital.pegado, 'acabadosDigital.pegado')}
                    ${generateCostInputHtml('Compaginado (Autocopia)', APP_COST_CONFIG.acabadosDigital.compaginado_autocopia, 'acabadosDigital.compaginado_autocopia')}
                    <!-- El costo de Folio se movió a Servicios -->
                `;
            }

            function renderDisenoCosts() {
                const disenoDetails = document.getElementById('disenoCostDetails');
                disenoDetails.innerHTML = `
                    <h5 class="font-bold text-gray-700 mt-2">Tipos de Diseño (Costo Fijo)</h5>
                    ${generateCostInputHtml('Cliente envía diseño', APP_COST_CONFIG.servicios.diseno_cliente, 'servicios.diseno_cliente')}
                    ${generateCostInputHtml('Diseño guardado aquí', APP_COST_CONFIG.servicios.diseno_guardado, 'servicios.diseno_guardado')}
                    ${generateCostInputHtml('Realizar diseño nuevo', APP_COST_CONFIG.servicios.diseno_nuevo, 'servicios.diseno_nuevo')}
                    <h5 class="font-bold text-gray-700 mt-4">Costo de Folio (si aplica y no hay diseño nuevo)</h5>
                    ${generateCostInputHtml('Folio (diseño cliente/guardado)', APP_COST_CONFIG.servicios.folio_por_diseno_cliente_guardado, 'servicios.folio_por_diseno_cliente_guardado')}
                `;
            }

            function renderAllCosts() {
                renderPapelCosts();
                renderImpresionCosts();
                renderAcabadosCosts();
                renderDisenoCosts();
            }

            // Función para actualizar el objeto global `individualCostOverrides` desde los inputs
            function updateIndividualCostOverridesFromInputs() {
                const inputElements = document.querySelectorAll('.cost-details-content input.cost-input');
                inputElements.forEach(input => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value)) {
                        individualCostOverrides[input.id] = value;
                    } else {
                        individualCostOverrides[input.id] = null; // Borrar el override si el input está vacío o no es un número
                    }
                });
                console.log("Individual Cost Overrides actualizados:", individualCostOverrides);
            }

            // Función para limpiar todos los overrides manuales y resetear los inputs
            function clearIndividualCostOverrides() {
                individualCostOverrides = {};
                const inputElements = document.querySelectorAll('.cost-details-content input.cost-input');
                inputElements.forEach(input => {
                    input.value = ''; // Limpiar el valor del input
                });
                renderAllCosts(); // Re-renderizar para mostrar los costos base nuevamente
                // No se muestra showCustomAlert aquí, ya que clearIndividualCostOverrides puede ser llamado por limpiarCampos()
            }

            // Event listener para el botón "Actualizar Costos Manuales y Recalcular"
            updateCostsBtn.addEventListener('click', () => {
                updateIndividualCostOverridesFromInputs();
                renderAllCosts(); // Volver a renderizar para mostrar los valores actuales en los inputs
                // Intentar recalcular, las validaciones internas de calcularCotizacion() manejarán los errores del formulario principal
                calcularCotizacion();
                showCustomAlert('Costos manuales actualizados. Verifica la cotización principal.');
            });

            // Event listener para el botón "Borrar Ajustes Manuales"
            clearManualCostsBtn.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que quieres borrar todos los ajustes manuales de costos?')) {
                    clearIndividualCostOverrides();
                    // Intentar recalcular con costos base, las validaciones manejarán errores
                    calcularCotizacion();
                }
            });


            // Inicializar al cargar la página
            limpiarCampos(); // Esto llamará a clearIndividualCostOverrides y actualizarOpcionesPapel
            renderAllCosts(); // Asegurarse de que los inputs se generen con los valores base inicialmente

        });
    </script>

    <!-- Botón Flotante de Regreso al Menú -->
    <a href="indexcotizadorcompleto.html" class="btn-home-flotante" title="Volver al Menú Principal">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span>Volver al Menú</span>
    </a>

    <style>
        .btn-home-flotante {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 9999;
            font-family: 'Poppins', 'Inter', sans-serif;
        }

        .btn-home-flotante:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .btn-home-flotante:active {
            transform: translateY(-1px) scale(1.02);
        }

        .btn-home-flotante svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .btn-home-flotante span {
            white-space: nowrap;
        }

        /* Responsive: en móviles solo mostrar el icono */
        @media (max-width: 768px) {
            .btn-home-flotante {
                padding: 15px;
                border-radius: 50%;
                bottom: 20px;
                right: 20px;
            }

            .btn-home-flotante span {
                display: none;
            }

            .btn-home-flotante svg {
                width: 24px;
                height: 24px;
            }
        }
    </style>
</body>

</html>