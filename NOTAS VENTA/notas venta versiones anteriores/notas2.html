<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de Imprenta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .input-group select, .input-group input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            border-bottom: 2px solid #1F2937;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .result-card {
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-top: 2rem;
        }
        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            text-align: center;
        }
        .result-price {
            font-size: 2.5rem;
            font-weight: 800;
            color: #16A34A;
            text-align: center;
            margin: 1rem 0;
        }
        .result-breakdown {
            margin-top: 1.5rem;
            border-top: 1px dashed #D1D5DB;
            padding-top: 1.5rem;
        }
        .result-breakdown p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .result-breakdown span {
            font-weight: 600;
        }
        .formula {
            font-size: 0.85rem;
            color: #6B7280;
            margin-left: 1rem;
            margin-bottom: 0.5rem;
        }
        .copy-text-container {
            background-color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            word-break: break-all; /* Para asegurar que el texto se ajuste si es muy largo */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Cotizador de Notas de Remisión</h1>
            <p class="text-gray-500 mt-2">Completa los campos para obtener un precio estimado.</p>
        </div>

        <form id="cotizadorForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
            
            <!-- SECCIÓN 1: INFORMACIÓN BÁSICA -->
            <fieldset class="md:col-span-2 border-t pt-6">
                <legend class="section-title">1. Información Básica</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="cantidad">Cantidad de Notas</label>
                        <input type="number" id="cantidad" placeholder="Escribe cantidad solicitada" min="1" required>
                    </div>
                    <div class="input-group">
                        <label for="tamano">Tamaño</label>
                        <select id="tamano">
                            <option value="" disabled selected>Selecciona el tamaño</option>
                            <option value="carta">Carta</option>
                            <option value="media_carta">1/2 Carta</option>
                            <option value="tercio_carta">1/3 Carta</option>
                            <option value="cuarto_carta">1/4 Carta</option>
                            <option value="oficio">Oficio</option>
                            <option value="media_oficio">1/2 Oficio</option>
                            <option value="tercio_oficio">1/3 Oficio</option>
                            <option value="cuarto_oficio">1/4 Oficio</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- SECCIÓN 2: TIPO DE PAPEL -->
            <fieldset class="md:col-span-2 border-t pt-6">
                <legend class="section-title">2. Tipo de Papel</legend>
                <div class="input-group">
                    <label>¿Lleva copias (Papel Autocopia)?</label>
                    <div class="flex items-center space-x-4">
                        <!-- Ninguno seleccionado por defecto -->
                        <input type="radio" id="conCopia" name="tipoPapel" value="autocopia">
                        <label for="conCopia">Sí</label>
                        <input type="radio" id="sinCopia" name="tipoPapel" value="simple">
                        <label for="sinCopia">No</label>
                    </div>
                </div>
                
                <!-- Opciones para Papel Autocopia -->
                <div id="opcionesAutocopia" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="numCopias">Número de Copias (además del original)</label>
                        <input type="number" id="numCopias" placeholder="¿Cuántas copias?" min="0">
                    </div>
                    <div id="coloresCopiasContainer" class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Los selectores de color se generarán aquí -->
                    </div>
                </div>

                <!-- Opciones para Papel Simple -->
                <div id="opcionesSimple" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="papelSimple">Tipo de Papel</label>
                        <select id="papelSimple">
                            <option value="" disabled selected>Selecciona el tipo de papel</option>
                            <option value="bond75">Bond 75gr</option>
                            <option value="bond90">Bond 90gr</option>
                            <option value="bristol180">Bristol 180gr</option>
                            <option value="seguridadHoops">Seguridad Hoops</option>
                            <option value="seguridadOaktree">Seguridad Oaktree</option>
                        </select>
                    </div>
                    <div id="colorOaktreeContainer" class="input-group hidden">
                        <label for="colorOaktree">Color Papel Oaktree</label>
                        <select id="colorOaktree">
                            <option value="" disabled selected>Selecciona el color</option>
                            <option value="amarillo_claro">Amarillo Claro</option>
                            <option value="oro">Oro</option>
                            <option value="verde_claro">Verde Claro</option>
                            <option value="verde_oscuro">Verde Oscuro</option>
                            <option value="azul_claro">Azul Claro</option>
                            <option value="azul_oscuro">Azul Oscuro</option>
                            <option value="rosa">Rosa</option>
                            <option value="gris">Gris</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- SECCIÓN 3: ACABADOS Y DISEÑO -->
            <fieldset class="md:col-span-2 border-t pt-6">
                 <legend class="section-title">3. Acabados y Diseño</legend>
                 <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label for="folio">¿Lleva Folio?</label>
                        <select id="folio">
                            <option value="" disabled selected>Selecciona la opción</option>
                            <option value="no">No</option>
                            <option value="si">Sí</option>
                        </select>
                    </div>
                    <div id="folioColorContainer" class="input-group hidden">
                        <label for="folioColor">Color del Folio</label>
                        <select id="folioColor">
                            <option value="" disabled selected>Selecciona el color</option>
                            <option value="negro">Negro</option>
                            <option value="rojo">Rojo</option>
                            <option value="otro">Otro Color</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="impresion">Tipo de Impresión</label>
                        <select id="impresion">
                            <option value="" disabled selected>Selecciona la impresión</option>
                            <option value="bw">Blanco y Negro</option>
                            <option value="color1">1 Color Específico</option>
                            <option value="color2">2 Colores Específicos</option>
                            <option value="cmyk">Selección de Color (CMYK)</option>
                        </select>
                    </div>
                     <div class="input-group">
                        <label for="diseno">Diseño</label>
                        <select id="diseno">
                            <option value="" disabled selected>Selecciona tipo de diseño</option>
                            <option value="cliente">Cliente envía diseño</option>
                            <option value="guardado">Diseño guardado aquí</option>
                            <option value="nuevo">Realizar diseño</option>
                        </select>
                    </div>
                 </div>
            </fieldset>
            
            <div class="md:col-span-2 mt-6">
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 text-lg">
                    Calcular Cotización
                </button>
            </div>
        </form>

        <div id="resultado" class="hidden"></div>

        <!-- Botón LIMPIAR CAMPOS movido fuera del formulario y con estilo grande -->
        <div class="md:col-span-2 mt-6">
            <button type="button" id="limpiarCamposBtn" class="w-full bg-red-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-red-700 transition-colors duration-300 text-xl">
                LIMPIAR CAMPOS
            </button>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS DE COSTOS ---
        const COSTOS_PAPEL = {
            carta: {
                autocopia_original: 0.43,
                autocopia_final: 0.48,
                autocopia_intermedio: 0.40,
                bond75: 1.95, // ¡Revisar este valor! Parece alto comparado con bond90
                bond90: 0.20,
                seguridadHoops: 0.52,
                seguridadOaktree: 0.75,
                bristol180: 1.21
            },
            oficio: {
                autocopia_original: 0.43, // ¡Revisar si debe ser igual al de carta!
                autocopia_final: 0.48,     // ¡Revisar si debe ser igual al de carta!
                autocopia_intermedio: 0.40,
                bond75: 0.20,
                bond90: 0.25,
                seguridadHoops: 0.69,
                seguridadOaktree: 1.00,
                bristol180: 1.21 // ¡Revisar si debe ser igual al de carta!
            }
        };

        // --- LÓGICA DE LA INTERFAZ ---
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('cotizadorForm');
            
            // Elementos del DOM
            const cantidadInput = document.getElementById('cantidad');
            const tamanoSelect = document.getElementById('tamano');
            const conCopiaRadio = document.getElementById('conCopia');
            const sinCopiaRadio = document.getElementById('sinCopia');
            const opcionesAutocopia = document.getElementById('opcionesAutocopia');
            const opcionesSimple = document.getElementById('opcionesSimple');
            const papelSimpleSelect = document.getElementById('papelSimple');
            const colorOaktreeContainer = document.getElementById('colorOaktreeContainer');
            const folioSelect = document.getElementById('folio');
            const folioColorContainer = document.getElementById('folioColorContainer');
            const numCopiasInput = document.getElementById('numCopias');
            const coloresCopiasContainer = document.getElementById('coloresCopiasContainer');
            const impresionSelect = document.getElementById('impresion');
            const disenoSelect = document.getElementById('diseno');
            const limpiarCamposBtn = document.getElementById('limpiarCamposBtn'); 

            // Función para actualizar visibilidad de opciones de papel
            function actualizarOpcionesPapel() {
                // Si ninguno de los radios de autocopia está seleccionado, ocultar ambos paneles
                if (!conCopiaRadio.checked && !sinCopiaRadio.checked) {
                    opcionesAutocopia.classList.add('hidden');
                    opcionesSimple.classList.add('hidden');
                    return;
                }

                if (conCopiaRadio.checked) {
                    opcionesAutocopia.classList.remove('hidden');
                    opcionesSimple.classList.add('hidden');
                    actualizarColoresCopias();
                } else { // sinCopiaRadio.checked
                    opcionesAutocopia.classList.add('hidden');
                    opcionesSimple.classList.remove('hidden');
                }
                // Asegurarse de que el color Oaktree se actualice solo si se muestra el panel simple
                actualizarColorOaktree();
            }

            // Función para actualizar visibilidad de color Oaktree
            function actualizarColorOaktree() {
                if (papelSimpleSelect.value === 'seguridadOaktree' && !opcionesSimple.classList.contains('hidden')) {
                    colorOaktreeContainer.classList.remove('hidden');
                } else {
                    colorOaktreeContainer.classList.add('hidden');
                }
            }
            
            // Función para actualizar visibilidad de color de folio
            function actualizarColorFolio() {
                if (folioSelect.value === 'si') {
                    folioColorContainer.classList.remove('hidden');
                } else {
                    folioColorContainer.classList.add('hidden');
                }
            }
            
            // Función para generar selectores de color para copias
            function actualizarColoresCopias() {
                coloresCopiasContainer.innerHTML = '';
                const copias = parseInt(numCopiasInput.value) || 0;
                // No generar selectores si no hay copias adicionales o si no es autocopia
                if (copias <= 0 || !conCopiaRadio.checked) {
                    return; 
                }

                const colores = ['Verde', 'Azul', 'Rosa', 'Amarillo'];
                
                // Copias intermedias
                for (let i = 1; i < copias; i++) {
                    const id = `intermedio_color_${i}`;
                    let html = `<div class="input-group"><label for="${id}">Color Intermedio ${i}</label><select id="${id}">`;
                    html += `<option value="" disabled selected>Selecciona el color</option>`; // Placeholder
                    colores.forEach(color => {
                        html += `<option value="${color.toLowerCase()}">${color}</option>`;
                    });
                    html += `</select></div>`;
                    coloresCopiasContainer.innerHTML += html;
                }

                // Copia final
                const idFinal = 'final_color';
                let htmlFinal = `<div class="input-group"><label for="${idFinal}">Color Copia Final</label><select id="${idFinal}">`;
                htmlFinal += `<option value="" disabled selected>Selecciona el color</option>`; // Placeholder
                colores.forEach(color => {
                    htmlFinal += `<option value="${color.toLowerCase()}">${color}</option>`;
                });
                htmlFinal += `</select></div>`;
                coloresCopiasContainer.innerHTML += htmlFinal;
            }

            // Función para limpiar todos los campos del formulario y ocultar el resultado
            function limpiarCampos() {
                // Restablecer campos input a vacío
                cantidadInput.value = '';
                numCopiasInput.value = '';

                // Restablecer selectores a su opción placeholder
                tamanoSelect.value = '';
                papelSimpleSelect.value = '';
                folioSelect.value = '';
                impresionSelect.value = '';
                disenoSelect.value = '';
                
                // Deseleccionar radios de autocopia
                conCopiaRadio.checked = false;
                sinCopiaRadio.checked = false;

                // Ocultar sección de resultados y contenedores condicionales
                document.getElementById('resultado').classList.add('hidden'); 
                opcionesAutocopia.classList.add('hidden');
                opcionesSimple.classList.add('hidden');
                colorOaktreeContainer.classList.add('hidden');
                folioColorContainer.classList.add('hidden');
                coloresCopiasContainer.innerHTML = ''; // Limpiar selectores de copias dinámicos
            }

            // Event Listeners
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                calcularCotizacion();
            });
            
            conCopiaRadio.addEventListener('change', actualizarOpcionesPapel);
            sinCopiaRadio.addEventListener('change', actualizarOpcionesPapel);
            papelSimpleSelect.addEventListener('change', actualizarColorOaktree);
            folioSelect.addEventListener('change', actualizarColorFolio);
            numCopiasInput.addEventListener('input', actualizarColoresCopias);
            limpiarCamposBtn.addEventListener('click', limpiarCampos); 

            // Inicializar estado de la UI al cargar la página (todos los campos vacíos)
            // Llama a limpiarCampos para establecer los estados iniciales deseados
            limpiarCampos(); 
            // Después de limpiar, si quieres que al cargar la página se muestren ciertas opciones,
            // tendrías que simular la selección o establecerlas directamente aquí.
            // Pero según tu solicitud, todo debería empezar vacío.
        });

        // --- MOTOR DE CÁLCULO ---
        function calcularCotizacion() {
            // 1. Recopilar datos del formulario
            const cantidad = parseInt(document.getElementById('cantidad').value);
            const tamano = document.getElementById('tamano').value;
            // Obtener las referencias a los radios aquí para la validación
            const conCopiaRadio = document.getElementById('conCopia');
            const sinCopiaRadio = document.getElementById('sinCopia');
            const esAutocopia = conCopiaRadio.checked; // Usar la referencia obtenida
            const numCopias = esAutocopia ? parseInt(document.getElementById('numCopias').value) : 0;
            const papelSimple = document.getElementById('papelSimple').value;
            const llevaFolio = document.getElementById('folio').value === 'si';
            const folioColor = document.getElementById('folioColor').value;
            const impresion = document.getElementById('impresion').value;
            const diseno = document.getElementById('diseno').value;

            // Validación de campos antes de calcular
            if (isNaN(cantidad) || cantidad <= 0) {
                alert('Por favor, ingresa una cantidad de notas válida (mayor que 0).'); 
                return;
            }
            if (!tamano) {
                alert('Por favor, selecciona un tamaño.');
                return;
            }
            // Validar que se haya seleccionado si lleva autocopia o no
            if (!conCopiaRadio.checked && !sinCopiaRadio.checked) {
                alert('Por favor, selecciona si lleva copias (Papel Autocopia).');
                return;
            }
            if (esAutocopia) {
                if (isNaN(numCopias) || numCopias < 0) {
                    alert('Por favor, ingresa un número de copias válido (0 o más).');
                    return;
                }
                // Validar selectores de color de copias
                const coloresCopiasGenerados = document.querySelectorAll('#coloresCopiasContainer select');
                for (let i = 0; i < coloresCopiasGenerados.length; i++) {
                    if (!coloresCopiasGenerados[i].value) {
                        alert(`Por favor, selecciona el color para la copia ${i + 1} (contando desde la primera intermedia).`);
                        return;
                    }
                }
            } else if (!papelSimple) { // Si no es autocopia, debe tener un papel simple seleccionado
                alert('Por favor, selecciona un tipo de papel simple.');
                return;
            }
            if (papelSimple === 'seguridadOaktree' && document.getElementById('colorOaktree').classList.contains('hidden') === false && !document.getElementById('colorOaktree').value) {
                alert('Por favor, selecciona un color para el Papel Oaktree.');
                return;
            }

            if (!document.getElementById('folio').value) { // Utiliza el valor directamente del elemento
                 alert('Por favor, selecciona si lleva folio o no.');
                 return;
            }
            if (llevaFolio && !folioColor) {
                 alert('Por favor, selecciona un color para el folio.');
                 return;
            }
            if (!document.getElementById('impresion').value) { // Utiliza el valor directamente del elemento
                alert('Por favor, selecciona un tipo de impresión.');
                return;
            }
            if (!document.getElementById('diseno').value) { // Utiliza el valor directamente del elemento
                alert('Por favor, selecciona un tipo de diseño.');
                return;
            }

            // 2. Cálculos iniciales
            const basePapel = tamano.includes('oficio') ? 'oficio' : 'carta';
            const factorDivision = {
                carta: 1, media_carta: 2, tercio_carta: 3, cuarto_carta: 4,
                oficio: 1, media_oficio: 2, tercio_oficio: 3, cuarto_oficio: 4
            }[tamano];

            // Las hojas requeridas para el cliente, considerando el tamaño de la nota
            const hojasRequeridasCliente = Math.ceil(cantidad / factorDivision);
            // Número total de partes (original + copias)
            const numPartes = esAutocopia ? 1 + numCopias : 1;
            
            let resultado;
            // 3. Decidir método de impresión (Digital si <= 250 hojas del cliente, Offset si > 250)
            if (hojasRequeridasCliente <= 250) {
                resultado = calcularDigital(cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, folioColor, impresion, diseno, basePapel, factorDivision, hojasRequeridasCliente, numPartes);
            } else {
                resultado = calcularOffset(cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, impresion, diseno, basePapel, factorDivision, hojasRequeridasCliente, numPartes);
            }
            
            // 4. Mostrar resultado
            mostrarResultado(resultado, {cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, folioColor, impresion, diseno});
        }
        
        // Función para formatear valores a moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
        }

        // Función para obtener el texto descriptivo del tipo de papel (para resumen)
        function getTipoPapelText(esAutocopia, numCopias, papelSimple) {
            if (esAutocopia) {
                return `Autocopia (${1 + numCopias} partes)`;
            } else {
                const papelSelect = document.getElementById('papelSimple');
                return papelSelect.options[papelSelect.selectedIndex].text;
            }
        }

        // Función para obtener el texto descriptivo del tipo de impresión (para resumen)
        function getImpresionText(impresionValue) {
            const impresionSelect = document.getElementById('impresion');
            return impresionSelect.options[impresionSelect.selectedIndex].text;
        }

        // Función para obtener el texto descriptivo del diseño (para resumen)
        function getDisenoText(disenoValue) {
            const disenoSelect = document.getElementById('diseno');
            return disenoSelect.options[disenoSelect.selectedIndex].text;
        }


        // Función para construir el texto de resumen para el cliente
        function getSummaryText(res, params) {
            const { cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, impresion, diseno } = params;
            
            let summary = `Notas: ${cantidad} `;
            summary += `Tamaño: ${document.getElementById('tamano').options[document.getElementById('tamano').selectedIndex].text} `;
            summary += `Papel: ${getTipoPapelText(esAutocopia, numCopias, papelSimple)} `;
            summary += `Folio: ${llevaFolio ? 'Sí' : 'No'} `;
            
            const acabadosText = [];
            // Aquí puedes añadir más detalles de acabados si los quieres en el resumen
            if (llevaFolio) acabadosText.push('Folio');
            if (res.metodo === 'Offset') acabadosText.push('Corte', 'Pegado');
            if (esAutocopia) acabadosText.push('Copaginado');
            
            if (acabadosText.length > 0) {
                summary += `Acabados: ${acabadosText.join(', ')}. `;
            } else {
                 summary += `Acabados: Ninguno. `;
            }

            summary += `Impresión: ${getImpresionText(impresion)}. `;
            summary += `Diseño: ${getDisenoText(diseno)}. `;
            summary += `Precio Unitario sin IVA: ${formatCurrency(res.precioUnitarioSinIVA)}. `;
            summary += `TOTAL: ${formatCurrency(res.total)}.`;
            
            return summary;
        }


        // Función para mostrar los resultados en la UI
        function mostrarResultado(res, params) {
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.classList.remove('hidden');
            
            // Desglose de costos detallado
            let breakdownHtml = `
                <p>Método de Producción: <span>${res.metodo}</span></p>
                <hr class="my-2 border-gray-300">

                <h3 class="text-md font-semibold mt-4 mb-2 text-gray-700">Detalle de Papel:</h3>
                <p>Costo de Papel: <span>${formatCurrency(res.costos.papel)}</span></p>
                <p class="formula">Fórmula: ${res.papelFormula}</p>
                
                <h3 class="text-md font-semibold mt-4 mb-2 text-gray-700">Detalle de Impresión:</h3>
                <p>Costo de Impresión: <span>${formatCurrency(res.costos.impresion)}</span></p>
                <p class="formula">Fórmula: ${res.impresionFormula}</p>
                ${res.metodo === 'Offset' ? `<p class="formula">Costo de Placas: ${formatCurrency(res.costos.placas)} (${res.placasFormula})</p>` : ''}
                
                <h3 class="text-md font-semibold mt-4 mb-2 text-gray-700">Detalle de Acabados:</h3>
                <p>Costos de Acabados: <span>${formatCurrency(res.costos.acabados)}</span></p>
                <p class="formula">Fórmula: ${res.acabadosFormula}</p>

                <h3 class="text-md font-semibold mt-4 mb-2 text-gray-700">Detalle de Servicios:</h3>
                <p>Costos de Servicios: <span>${formatCurrency(res.costos.servicios)}</span></p>
                <p class="formula">Fórmula: ${res.serviciosFormula}</p>
                
                <hr class="my-4 border-gray-300">
                <p class="font-bold">Subtotal (sin utilidad ni IVA): <span>${formatCurrency(res.subtotalBase || res.subtotal)}</span></p>
            `;

            if (res.metodo === 'Offset') {
                breakdownHtml += `<p class="font-bold">Subtotal + Utilidad (38%): <span>${formatCurrency(res.subtotalConUtilidad)}</span></p>`;
            }
            
            breakdownHtml += `
                <p class="font-bold">IVA (16%): <span>${formatCurrency(res.iva)}</span></p>
                <hr class="my-2 border-gray-300">
                <p class="font-bold text-lg text-gray-700">Precio Unitario sin IVA: <span>${formatCurrency(res.precioUnitarioSinIVA)}</span></p>
                <p class="font-bold text-2xl text-green-700">TOTAL: <span>${formatCurrency(res.total)}</span></p>
            `;

            resultadoDiv.innerHTML = `
                <div class="result-card">
                    <h2 class="result-title">Cotización Estimada</h2>
                    <p class="result-price">${formatCurrency(res.total)}</p>
                    <div class="result-breakdown">
                        <h3 class="text-lg font-semibold mb-2 text-center text-gray-700">Desglose de Costos</h3>
                        ${breakdownHtml}
                    </div>
                    <div class="copy-text-container">
                        <p class="text-gray-800 font-medium">Texto para Cliente:</p>
                        <p id="clientSummaryText" class="text-gray-600 mt-1">${getSummaryText(res, params)}</p>
                        <button class="mt-2 w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300 transition-colors" onclick="copyToClipboard('clientSummaryText')">
                            Copiar al Portapapeles
                        </button>
                    </div>
                </div>
            `;
            resultadoDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Función para copiar texto al portapapeles
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges();
            alert('Texto copiado al portapapeles!'); // Considerar un modal personalizado
        }

        // --- LÓGICA DE COTIZACIÓN DIGITAL ---
        // Para tiradas pequeñas (<= 250 hojas del cliente)
        function calcularDigital(cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, folioColor, impresion, diseno, basePapel, factorDivision, hojasRequeridasCliente, numPartes) {
            const costos = { papel: 0, impresion: 0, acabados: 0, servicios: 0 };
            let papelFormula = '';
            let impresionFormula = '';
            let acabadosFormula = '';
            let serviciosFormula = '';

            // Costo Papel
            let costoBasePapel = 0;
            const tamanoDisplayName = document.getElementById('tamano').options[document.getElementById('tamano').selectedIndex].text; // Obtener nombre visible del tamaño
            if (esAutocopia) {
                const costoOriginal = COSTOS_PAPEL[basePapel].autocopia_original;
                const costoFinal = COSTOS_PAPEL[basePapel].autocopia_final;
                const costoIntermedio = COSTOS_PAPEL[basePapel].autocopia_intermedio;

                costoBasePapel += hojasRequeridasCliente * costoOriginal;
                costoBasePapel += hojasRequeridasCliente * costoFinal;
                papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoOriginal.toFixed(2)}/hoja original) + `; 
                papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoFinal.toFixed(2)}/hoja final) `; 

                if (numCopias > 1) {
                    costoBasePapel += hojasRequeridasCliente * (numCopias - 1) * costoIntermedio;
                    papelFormula += `+ (${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${numCopias - 1} copias intermedias x ${costoIntermedio.toFixed(2)}/hoja)`; 
                }
            } else {
                const costoUnitarioPapelSimple = COSTOS_PAPEL[basePapel][papelSimple];
                const papelSimpleDisplayName = document.getElementById('papelSimple').options[document.getElementById('papelSimple').selectedIndex].text; // Obtener nombre visible del tipo de papel
                costoBasePapel = hojasRequeridasCliente * costoUnitarioPapelSimple;
                papelFormula += `(${hojasRequeridasCliente} hojas de tamaño ${tamanoDisplayName} x ${costoUnitarioPapelSimple.toFixed(2)}/hoja de ${papelSimpleDisplayName})`; 
            }
            // VERIFICAR: Este *2 es intencional para utilidad del papel.
            costos.papel = costoBasePapel * 2; 
            papelFormula = `(${papelFormula}) * 2 (utilidad del papel)`;


            // Costo Impresión (digital)
            let tarifaImpresion = 0;
            const esImpresionBN = impresion === 'bw';
            const folioCambiaColor = llevaFolio && (folioColor === 'rojo' || folioColor === 'otro');
            
            if (!esImpresionBN || folioCambiaColor) { 
                tarifaImpresion = basePapel === 'carta' ? 6.0 : 6.5; 
                impresionFormula += `${basePapel === 'carta' ? 'Tarifa Color Carta' : 'Tarifa Color Oficio'} (${tarifaImpresion.toFixed(2)})`;
            } else { 
                tarifaImpresion = basePapel === 'carta' ? 0.8 : 0.86; 
                impresionFormula += `${basePapel === 'carta' ? 'Tarifa B/N Carta' : 'Tarifa B/N Oficio'} (${tarifaImpresion.toFixed(2)})`;
            }
            costos.impresion = (hojasRequeridasCliente * numPartes) * tarifaImpresion;
            impresionFormula = `(${hojasRequeridasCliente} hojas cliente x ${numPartes} partes) x ${impresionFormula}`;

            // Costos Acabados (digital)
            let corteCosto = 0;
            acabadosFormula += 'Corte: ';
            if (factorDivision === 2) { corteCosto = 100; acabadosFormula += '100 (1/2 Carta/Oficio) '; }
            if (factorDivision === 3) { corteCosto = 120; acabadosFormula += '120 (1/3 Carta/Oficio) '; }
            if (factorDivision === 4) { corteCosto = 125; acabadosFormula += '125 (1/4 Carta/Oficio) '; }
            costos.acabados += corteCosto;

            const pegadoCosto = 85;
            costos.acabados += pegadoCosto;
            acabadosFormula += `+ Pegado: ${pegadoCosto}`;
            
            if (esAutocopia) {
                const copaginadoCosto = 80;
                costos.acabados += copaginadoCosto;
                acabadosFormula += `+ Copaginado: ${copaginadoCosto}`;
            }

            // Costos Servicios (digital)
            serviciosFormula += 'Diseño: ';
            const disenoCosto = { cliente: 60, guardado: 150, nuevo: 215.52 }[diseno];
            serviciosFormula += `${disenoCosto} (${getDisenoText(diseno)})`;
            costos.servicios += disenoCosto;

            if (llevaFolio) {
                const folioServicioCosto = 150;
                costos.servicios += folioServicioCosto;
                serviciosFormula += ` + Folio: ${folioServicioCosto}`;
            }

            const subtotalBase = costos.papel + costos.impresion + costos.acabados + costos.servicios;
            const subtotal = subtotalBase; // En digital, no hay utilidad antes del IVA
            const iva = subtotal * 0.16;
            const total = subtotal + iva;
            const precioUnitarioSinIVA = subtotal / cantidad;

            return { 
                metodo: 'Digital', 
                costos, 
                subtotalBase,
                subtotal, 
                iva, 
                total, 
                precioUnitarioSinIVA,
                papelFormula,
                impresionFormula,
                acabadosFormula,
                serviciosFormula
            };
        }

        // --- LÓGICA DE COTIZACIÓN OFFSET ---
        // Para tiradas grandes (> 250 hojas del cliente)
        function calcularOffset(cantidad, tamano, esAutocopia, numCopias, papelSimple, llevaFolio, impresion, diseno, basePapel, factorDivision, hojasRequeridasCliente, numPartes) {
            const costos = { papel: 0, placas: 0, impresion: 0, acabados: 0, servicios: 0 };
            let papelFormula = '';
            let impresionFormula = '';
            let placasFormula = '';
            let acabadosFormula = '';
            let serviciosFormula = '';
            
            // Hojas de producción incluyendo merma
            const hojasProduccion = hojasRequeridasCliente + 180;
            // Total de hojas a imprimir en offset (producción * partes)
            const totalHojasImprimirOffset = hojasProduccion * numPartes;
            
            // Costo Papel
            let costoUnitarioJuego = 0;
            const tamanoDisplayName = document.getElementById('tamano').options[document.getElementById('tamano').selectedIndex].text; // Obtener nombre visible del tamaño
            if (esAutocopia) {
                const costoOriginal = COSTOS_PAPEL[basePapel].autocopia_original;
                const costoFinal = COSTOS_PAPEL[basePapel].autocopia_final;
                const costoIntermedio = COSTOS_PAPEL[basePapel].autocopia_intermedio;

                costoUnitarioJuego += costoOriginal;
                costoUnitarioJuego += costoFinal;
                papelFormula += `(${costoOriginal.toFixed(2)}/hoja original de tamaño ${tamanoDisplayName}) + `; 
                papelFormula += `(${costoFinal.toFixed(2)}/hoja final de tamaño ${tamanoDisplayName}) `; 
                if (numCopias > 1) {
                    costoUnitarioJuego += (numCopias - 1) * costoIntermedio;
                    papelFormula += `+ (${numCopias - 1} copias intermedias x ${costoIntermedio.toFixed(2)}/hoja de tamaño ${tamanoDisplayName})`; 
                }
            } else {
                const costoUnitarioPapelSimple = COSTOS_PAPEL[basePapel][papelSimple];
                const papelSimpleDisplayName = document.getElementById('papelSimple').options[document.getElementById('papelSimple').selectedIndex].text; // Obtener nombre visible del tipo de papel
                costoUnitarioJuego = costoUnitarioPapelSimple;
                papelFormula += `${costoUnitarioPapelSimple.toFixed(2)}/hoja de ${papelSimpleDisplayName} (Tamaño ${tamanoDisplayName})`; 
            }
            costos.papel = hojasProduccion * costoUnitarioJuego;
            papelFormula = `(${hojasProduccion} hojas de producción x (${papelFormula}))`;

            // Costo Placas y Tinta (Offset)
            let numPlacas = 0;
            let costoTintaMillar = 0;
            switch(impresion) {
                case 'bw': numPlacas = 1; costoTintaMillar = 150; break;
                case 'color1': numPlacas = 1; costoTintaMillar = 250; break;
                case 'color2': numPlacas = 2; costoTintaMillar = 500; break;
                case 'cmyk': numPlacas = 4; costoTintaMillar = 600; break;
            }
            costos.placas = numPlacas * 180; // Costo fijo por placa
            placasFormula = `${numPlacas} placas x 180/placa`;

            const millaresImpresion = Math.ceil(totalHojasImprimirOffset / 1000);
            costos.impresion = millaresImpresion * costoTintaMillar; // Costo de tinta por millar
            impresionFormula = `(${millaresImpresion} millares de impresión x ${costoTintaMillar}/millar)`;


            // Costos Acabados (Offset)
            acabadosFormula += 'Corte: ';
            const bloquesCorte = Math.ceil(hojasProduccion / 500);
            let costoCorte = 0;
            if (factorDivision === 2) { costoCorte = 100; acabadosFormula += `(${bloquesCorte} bloques x 100 (1/2 Carta/Oficio))`; }
            if (factorDivision === 3) { costoCorte = 120; acabadosFormula += `(${bloquesCorte} bloques x 120 (1/3 Carta/Oficio))`; }
            if (factorDivision === 4) { costoCorte = 125; acabadosFormula += `(${bloquesCorte} bloques x 125 (1/4 Carta/Oficio))`; }
            costos.acabados += bloquesCorte * costoCorte;

            if (esAutocopia) {
                const millaresCopaginado = Math.ceil(totalHojasImprimirOffset / 1000);
                const copaginadoCosto = 120;
                costos.acabados += millaresCopaginado * copaginadoCosto;
                acabadosFormula += ` + Copaginado: (${millaresCopaginado} millares x ${copaginadoCosto}/millar)`;
            }
            if (llevaFolio) {
                const millaresFolio = Math.ceil(cantidad / 1000); 
                const folioCosto = 200;
                costos.acabados += millaresFolio * folioCosto;
                acabadosFormula += ` + Folio: (${millaresFolio} millares de notas x ${folioCosto}/millar)`;
            }
            const millaresPegado = Math.ceil(totalHojasImprimirOffset / 1000);
            const pegadoCosto = 85;
            costos.acabados += millaresPegado * pegadoCosto;
            acabadosFormula += ` + Pegado: (${millaresPegado} millares de impresión x ${pegadoCosto}/millar)`;


            // Costos Servicios (Diseño)
            serviciosFormula += 'Diseño: ';
            const disenoCosto = { cliente: 80, guardado: 150, nuevo: 215.52 }[diseno];
            serviciosFormula += `${disenoCosto} (${getDisenoText(diseno)})`;
            costos.servicios = disenoCosto; // En offset, el folio se carga en acabados

            const subtotalBase = costos.papel + costos.placas + costos.impresion + costos.acabados + costos.servicios;
            const subtotalConUtilidad = subtotalBase * 1.38; // Aplicar 38% de utilidad
            const iva = subtotalConUtilidad * 0.16;
            const total = subtotalConUtilidad + iva;
            const precioUnitarioSinIVA = subtotalConUtilidad / cantidad; // Precio unitario considerando utilidad pero sin IVA

            return { 
                metodo: 'Offset', 
                costos: {
                    papel: costos.papel,
                    placas: costos.placas,
                    impresion: costos.impresion, // Esto es solo tinta en este desglose
                    acabados: costos.acabados,
                    servicios: costos.servicios
                }, 
                subtotalBase,
                subtotalConUtilidad, 
                iva, 
                total, 
                precioUnitarioSinIVA,
                papelFormula,
                impresionFormula,
                placasFormula,
                acabadosFormula,
                serviciosFormula
            };
        }

    </script>
</body>
</html>
